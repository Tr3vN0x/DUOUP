rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    // Users
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasAll([
          'nickname','uid','email','authType','lastActive','bio',
          'friends','profileImageUrl','isPremium','status','favoriteGames'
        ])
        && request.resource.data.uid == userId
        && request.resource.data.email == request.auth.token.email
        && request.resource.data.friends is list
        && request.resource.data.favoriteGames is list;
      allow update: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'lastActive','bio','profileImageUrl','friends',
          'nickname','status','favoriteGames','isPremium'
        ]);
    }

    // Games
    match /games/{gameId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    // Friend Requests
    match /friendRequests/{requestId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    // Messages
    match /messages/{messageId} {
      allow read, write: if isSignedIn();
    }
  }
}
