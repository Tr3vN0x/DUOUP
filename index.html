<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr3vMedia</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
/* ---------------------------------- */
/* --- ğŸ¨ COLOR REVERTED TO GREEN --- */
/* ---------------------------------- */

/* --- Core Styling & Typography --- */
body {
Â  Â  margin: 0;
Â  Â  font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
Â  Â  background: #0a0a0a;Â 
Â  Â  color: #00FF00; /* Main text color: Bright Green */
Â  Â  line-height: 1.6;
}
header {
Â  Â  background: #111111;Â 
Â  Â  padding: 15px 30px;
Â  Â  color: #00FF00;
Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);Â 
Â  Â  border-bottom: 1px solid #004400;
Â  Â  position:sticky;
Â  Â  top:0;
Â  Â  z-index:1000;Â 
}
main {padding: 30px 40px;}
h2, h3, h4 {color: #00CC00; margin-top: 0;} /* Green Accent */
.verified {
Â  Â  color: #00CC00;
Â  Â  font-weight: bold;
Â  Â  margin-left: 5px;
Â  Â  background: rgba(0, 204, 0, 0.1);
Â  Â  padding: 2px 6px;
Â  Â  border-radius: 3px;
Â  Â  font-size: 0.8em;
}
.tab-content {display:none;}
#welcome-banner {
Â  Â  background: #004400; /* Darker Green */
Â  Â  color: #FFFFFF;
Â  Â  text-align: center;
Â  Â  padding: 15px;
Â  Â  margin-bottom: 25px;
Â  Â  border-radius: 8px;Â 
}

/* --- Header & Navigation (Desktop/Tablet) --- */
header {
Â  Â  display:flex;
Â  Â  justify-content:space-between;
Â  Â  align-items:center;
}
.header-left {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 30px;Â 
}
.logo-container {
Â  Â  display: flex;Â 
Â  Â  align-items: center;
Â  Â  gap: 15px;
}
.logo-container img {
Â  Â  height: 35px;
Â  Â  border-radius: 5px;
Â  Â  filter: drop-shadow(0 0 5px #00CC00);Â 
}

/* Search Bar Styling */
#search-bar {
Â  Â  position: relative;Â 
Â  Â  min-width: 250px;
}
#search-input {
Â  Â  padding: 8px 12px;
Â  Â  border-radius: 20px;Â 
Â  Â  background: #1e1e1e;
Â  Â  color: #00FF00;
Â  Â  border: 1px solid #004400;
Â  Â  width: 100%;
Â  Â  box-sizing: border-box;
Â  Â  transition: all 0.3s;
}
#search-input:focus {
Â  Â  background: #222222;
Â  Â  border-color: #00CC00;
Â  Â  box-shadow: 0 0 8px rgba(0, 204, 0, 0.5);
Â  Â  outline: none;
}

/* Search Results Dropdown Styling */
#search-results {
Â  Â  position: absolute;
Â  Â  top: 100%;Â 
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  background: #1e1e1e;
Â  Â  border: 1px solid #004400;
Â  Â  border-top: none;
Â  Â  border-radius: 0 0 10px 10px;
Â  Â  max-height: 250px;
Â  Â  overflow-y: auto;
Â  Â  z-index: 20;
Â  Â  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
}
.search-result-item {
Â  Â  padding: 10px 15px;
Â  Â  cursor: pointer;
Â  Â  border-bottom: 1px solid #001a00;
Â  Â  transition: background 0.2s;
}
.search-result-item:hover {
Â  Â  background: #003300;
Â  Â  color: #FFFFFF;
}


/* Tabs Styling (Desktop) */
.header-actions {
Â  Â  display: flex;Â 
Â  Â  gap: 10px;Â 
Â  Â  align-items: center;
}
.nav-tab {
Â  Â  cursor:pointer;
Â  Â  padding: 8px 15px;Â 
Â  Â  border-radius: 20px;Â 
Â  Â  border: 1px solid #004400;
Â  Â  font-size: 0.9em;Â 
Â  Â  transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
Â  Â  position: relative; /* For the notification badge */
}
.nav-tab.active {
Â  Â  background: #003300;
Â  Â  border-color: #00CC00;
Â  Â  box-shadow: 0 0 10px rgba(0, 204, 0, 0.5);
Â  Â  color: #FFFFFF;
}
.nav-tab:hover:not(.active) {
Â  Â  background: #1e1e1e;
Â  Â  border-color: #00CC00;
}
/* Notification Badge */
.notification-badge {
Â  Â  position: absolute;
Â  Â  top: -5px;
Â  Â  right: -5px;
Â  Â  background: red;
Â  Â  color: white;
Â  Â  border-radius: 50%;
Â  Â  padding: 3px 6px;
Â  Â  font-size: 0.7em;
Â  Â  font-weight: bold;
Â  Â  pointer-events: none; /* Allows click-through */
Â  Â  z-index: 5;
}

/* --- Forms & Inputs (General) --- */
input:not([type="file"], #search-input), textarea {
Â  Â  width: 100%;Â 
Â  Â  box-sizing: border-box;
Â  Â  padding: 10px;
Â  Â  margin-bottom: 15px;Â 
Â  Â  border-radius: 6px;
Â  Â  background: #1e1e1e;
Â  Â  color: #00FF00;
Â  Â  border: 1px solid #004400;
Â  Â  margin-top: 5px;
Â  Â  resize: vertical;
Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus:not([type="file"], #search-input), textarea:focus {
Â  Â  border-color: #00CC00;
Â  Â  box-shadow: 0 0 5px rgba(0, 204, 0, 0.4);
Â  Â  outline: none;
}
/* File input styling is subtle */
input[type="file"] {margin-top:10px; margin-bottom: 15px; background: #1e1e1e; color: #00FF00; padding: 10px; border-radius: 6px; border: 1px solid #004400;}

button {
Â  Â  cursor:pointer;
Â  Â  padding:10px 18px;Â 
Â  Â  border-radius: 20px;Â 
Â  Â  background: #006600; /* Standard Button Green */
Â  Â  color: #FFFFFF;
Â  Â  border: none;
Â  Â  margin-top: 5px;
Â  Â  transition: background 0.3s, box-shadow 0.3s;
Â  Â  font-weight: bold;
}
button:hover {
Â  Â  background: #008800;
Â  Â  box-shadow: 0 4px 10px rgba(0, 204, 0, 0.4);
}
button:active {
Â  Â  background: #004400;
}
/* New button styles for Settings */
.settings-button {
Â  Â  width: 100%;Â 
Â  Â  display: block;
Â  Â  margin-top: 10px;
}


#new-post {
Â  Â  background: #1e1e1e;
Â  Â  padding: 20px;
Â  Â  border-radius: 10px;
Â  Â  margin-bottom: 30px;
Â  Â  border: 1px solid #004400;
}
#new-post button {margin-top: 10px; width: 100%;}

/* Follow/Unfollow Button Specific Styling */
#follow-button.unfollow {
Â  Â  background: #CC0000; /* Red for Unfollow */
}
#follow-button.unfollow:hover {
Â  Â  background: #FF3333;
}

/* --- DM Specific Styling --- */
.chat-messages {
Â  Â  /* Adjust margin for mobile fixed footer */
Â  Â  max-height: 400px;Â 
Â  Â  overflow-y: auto;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 15px;
Â  Â  padding: 10px;
Â  Â  background: #0d0d0d;
Â  Â  border-radius: 8px;
Â  Â  border: 1px solid #004400;
}
/* ... (Keep other styles like post, profile, gallery) ... */


/* --- Mobile Navigation Bar (NEW) --- */
#mobile-nav {
Â  Â  display: none; /* Hidden by default (desktop) */
Â  Â  position: fixed;
Â  Â  bottom: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  background: #111111;
Â  Â  border-top: 1px solid #004400;
Â  Â  box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
Â  Â  z-index: 2000;
Â  Â  padding-bottom: env(safe-area-inset-bottom); /* For modern phones */
}

.mobile-tab-container {
Â  Â  display: flex;
Â  Â  justify-content: space-around;
Â  Â  align-items: center;
Â  Â  height: 60px;
}

.mobile-nav-item {
Â  Â  cursor: pointer;
Â  Â  flex: 1;
Â  Â  text-align: center;
Â  Â  padding: 5px 0;
Â  Â  color: #666666; /* Default inactive color */
Â  Â  font-size: 0.75em;
Â  Â  transition: color 0.3s;
Â  Â  position: relative;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  gap: 2px;
}
.mobile-nav-item .material-icons {
Â  Â  font-size: 24px;
}

.mobile-nav-item.active {
Â  Â  color: #00CC00; /* Active green color */
Â  Â  font-weight: bold;
}
.mobile-nav-item:hover {
Â  Â  color: #00FF00;
}
/* Mobile Notification Badge */
.mobile-notification-badge {
Â  Â  position: absolute;
Â  Â  top: 0px;
Â  Â  right: 20%;
Â  Â  background: red;
Â  Â  color: white;
Â  Â  border-radius: 50%;
Â  Â  padding: 2px 5px;
Â  Â  font-size: 0.6em;
Â  Â  font-weight: bold;
}
/* Content padding adjustment for mobile footer */
@media (max-width: 768px) {
Â  Â  main {
Â  Â  Â  Â  padding-bottom: 80px; /* Make space for the fixed footer */
Â  Â  }
}


/* --- Media Queries for Mobile Experience --- */
@media (max-width: 768px) {
Â  Â  /* Hide Desktop elements */
Â  Â  .header-actions {
Â  Â  Â  Â  display: none !important;
Â  Â  }
Â  Â  #search-bar {
Â  Â  Â  Â  min-width: 100px; /* Allow search bar to shrink */
Â  Â  Â  Â  width: 60%;
Â  Â  }
Â  Â  header {
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  }
Â  Â  .header-left {
Â  Â  Â  Â  gap: 15px;
Â  Â  }
Â  Â  .logo-container img {
Â  Â  Â  Â  height: 28px;
Â  Â  }
Â  Â  main {
Â  Â  Â  Â  padding: 15px 15px;
Â  Â  }

Â  Â  /* Show Mobile Navigation */
Â  Â  #mobile-nav {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  /* Hide footer on mobile */
Â  Â  footer {
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  /* Adjust DM section height for smaller screens */
Â  Â  .chat-messages {
Â  Â  Â  Â  max-height: 350px;
Â  Â  }
}


/* --- Post, Profile, Gallery Styles (Kept for completeness) --- */
.post {
Â  Â  display:flex;
Â  Â  flex-direction: column;Â 
Â  Â  background:#1e1e1e;
Â  Â  padding: 20px;
Â  Â  margin-bottom: 15px;
Â  Â  border-radius: 10px;
Â  Â  border: 1px solid #004400;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}
.post-header {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 15px;
Â  Â  margin-bottom: 15px;
}
.post-content {
Â  Â  margin-bottom: 15px;
Â  Â  white-space: pre-wrap;Â 
}
.post-image-container {
Â  Â  max-width: 100%;
Â  Â  margin: 10px 0 15px 0;
Â  Â  border-radius: 8px;
Â  Â  overflow: hidden;
Â  Â  border: 1px solid #004400;
}
.post-image {
Â  Â  width: 100%;
Â  Â  height: auto;
Â  Â  display: block;
Â  Â  object-fit: contain;
}
.post-actions {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 20px;
Â  Â  margin-top: 10px;
Â  Â  border-top: 1px dashed #004400;
Â  Â  padding-top: 10px;
}
.post-actions button {
Â  Â  padding: 5px 10px;
Â  Â  margin-top: 0;
Â  Â  font-size: 0.9em;
Â  Â  background: #333333;
Â  Â  color: #00FF00;
}
.post-actions button:hover {
Â  Â  background: #005500;
Â  Â  box-shadow: none;
}
.reaction-count {
Â  Â  margin-left: -15px;Â 
Â  Â  font-size: 0.9em;
Â  Â  color: #00CC00;
}
.post img, .profile-image-small {
Â  Â  width: 45px;
Â  Â  height: 45px;
Â  Â  border-radius: 50%;
Â  Â  border: 2px solid #00CC00;
Â  Â  object-fit:cover;
Â  Â  background: #0d0d0d;Â 
}
#profile-pic-display {width: 90px; height: 90px;}
.comments-section {
Â  Â  margin-top: 20px;
Â  Â  padding: 10px 0;
Â  Â  border-top: 1px solid #004400;
Â  Â  border-bottom: 1px solid #004400;
}
.comment {
Â  Â  background: #0d0d0d;
Â  Â  padding: 8px 12px;
Â  Â  margin-bottom: 6px;
Â  Â  border-left: 3px solid #00CC00;
Â  Â  border-radius: 4px;
Â  Â  font-size: 0.9em;
}
.comment-user {
Â  Â  font-weight: bold;
Â  Â  color: #00CC00;
}
.comment-input-area {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  margin-top: 15px;
}
.comment-input-area input {
Â  Â  flex-grow: 1;
Â  Â  margin-bottom: 0;
Â  Â  padding: 8px;
Â  Â  border-radius: 4px;
}
.comment-input-area button {
Â  Â  margin-top: 0;
Â  Â  padding: 8px 15px;
Â  Â  white-space: nowrap;
Â  Â  background: #00CC00;
}
.comment-input-area button:hover {
Â  Â  background: #00FF00;
}
#profile, #view-profile {
Â  Â  background: #1e1e1e;
Â  Â  padding: 25px;
Â  Â  border-radius: 10px;
Â  Â  border: 1px solid #004400;
}
#view-profile-content #profile-pic-view {
Â  Â  width: 120px;
Â  Â  height: 120px;
Â  Â  border-radius: 50%;
Â  Â  border: 3px solid #00CC00;
Â  Â  background: #0d0d0d;
Â  Â  margin-bottom: 10px;
}
.clickable-username {
Â  Â  cursor: pointer;
Â  Â  text-decoration: none;Â 
Â  Â  color: #00CC00;
Â  Â  transition: color 0.2s, text-decoration 0.2s;
}
.clickable-username:hover {
Â  Â  color: #00FF00;
Â  Â  text-decoration: underline;
}
.post-timestamp {
Â  Â  font-size: 0.8em;
Â  Â  color: #555555;
Â  Â  margin-left: 10px;
}
.status-container {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 10px;
Â  Â  margin-bottom: 15px;
}
.active-dot {
Â  Â  width: 12px;
Â  Â  height: 12px;
Â  Â  background: #00FF00; /* Bright Green */
Â  Â  border-radius: 50%;
Â  Â  box-shadow: 0 0 8px #00FF00;
}
.last-online-text {
Â  Â  font-size: 0.9em;
Â  Â  color: #777777;
}
.gallery-container {
Â  Â  display: grid;
Â  Â  grid-template-columns: repeat(4, 1fr);Â 
Â  Â  gap: 15px;
Â  Â  margin-top: 15px;
Â  Â  padding: 10px;
Â  Â  background: #111111;
Â  Â  border-radius: 8px;
}
@media (max-width: 600px) {
Â  Â  .gallery-container {
Â  Â  Â  Â  grid-template-columns: repeat(3, 1fr); /* 3 columns on small screens */
Â  Â  Â  Â  gap: 10px;
Â  Â  }
}
.gallery-slot {
Â  Â  background: #222222;
Â  Â  border: 1px solid #004400;
Â  Â  border-radius: 6px;
Â  Â  padding: 5px;
Â  Â  text-align: center;
Â  Â  overflow: hidden;
}
.gallery-image-display {
Â  Â  width: 100%;
Â  Â  aspect-ratio: 1 / 1;Â 
Â  Â  object-fit: cover;
Â  Â  margin-bottom: 5px;
Â  Â  border-radius: 4px;
Â  Â  border: 1px solid #00CC00;
Â  Â  cursor: pointer;
Â  Â  transition: transform 0.3s, opacity 0.3s;
}
.gallery-image-display:hover {
Â  Â  opacity: 0.8;
Â  Â  transform: scale(1.02);
}
#messages-list {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 10px;
}
.chat-summary {
Â  Â  background: #1e1e1e;
Â  Â  padding: 15px;
Â  Â  border-radius: 8px;
Â  Â  border-left: 5px solid #00CC00;
Â  Â  cursor: pointer;
Â  Â  transition: background 0.2s;
}
.chat-summary:hover {
Â  Â  background: #222222;
}
.message {
Â  Â  padding: 10px 15px;
Â  Â  border-radius: 15px;
Â  Â  max-width: 70%;
Â  Â  word-wrap: break-word;
Â  Â  font-size: 0.95em;
Â  Â  line-height: 1.4;
Â  Â  position: relative;
}
.message-time {
Â  Â  display: block;
Â  Â  font-size: 0.75em;
Â  Â  color: #555555;
Â  Â  margin-top: 5px;
Â  Â  text-align: right;
}
.sent {
Â  Â  background: #005500; /* Darker Green for self */
Â  Â  color: #FFFFFF;
Â  Â  align-self: flex-end;
Â  Â  border-top-right-radius: 5px;
}
.received {
Â  Â  background: #333333;
Â  Â  color: #00FF00;
Â  Â  align-self: flex-start;
Â  Â  border-top-left-radius: 5px;
}
#send-message-area {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  margin-top: 20px;
}
#send-message-area input {
Â  Â  flex-grow: 1;
Â  Â  margin-bottom: 0;
}
#send-message-area button {
Â  Â  margin-top: 0;
Â  Â  padding: 10px 20px;
}
#notifications-display {
Â  Â  background: #1e1e1e;
Â  Â  padding: 15px;
Â  Â  border-radius: 8px;
Â  Â  border: 1px solid #004400;
}
.notification-item {
Â  Â  padding: 10px;
Â  Â  border-bottom: 1px dashed #004400;
}
</style>
</head>
<body>

<header>
Â  Â  <div class="header-left">
Â  Â  Â  Â  <div class="logo-container">
Â  Â  Â  Â  Â  Â  <img src="https://see.fontimg.com/api/rf5/vXL4/YTM3ZmYyMWFkMzNiNGY5MGEwY2ZmZTZmNDhiZGI4NzkudHRm/VHIzdk1lZGlh/chimpanzee-website-report.png?r=fs&h=65&w=1000&fg=E8E4E4&bg=27E2A1&tb=1&s=65"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â alt="Tr3vMedia Icon 1">
Â  Â  Â  Â  Â  Â  <img src="https://scontent-iad3-2.xx.fbcdn.net/v/t39.30808-6/596009832_838710972097270_9022730636766278745_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=FV-kAQTMc9sQ7kNvwtnXUJ&_nc_oc=AdnMy32z6EqV3KBKYoxV9lXa4sxDC5HGtKjqXOn1Ft5DhugILwP1VuHdODGDfKtXeMswLEwyf_07cIoNby3di58u&_nc_zt=23&_nc_ht=scontent-iad3-2.xx&_nc_gid=ffAPLrP0wQ4lRnuf3eL46g&oh=00_Afk9OB0-t0OJNQksLxcPV1gJpw_C1Z8IwkKu4li6rX9bgA&oe=6940AF3A"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â alt="Tr3vMedia Icon 2">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="search-bar">
Â  Â  Â  Â  Â  Â  <input type="text" id="search-input" placeholder="Search usernames..." onkeyup="searchUsers()">
Â  Â  Â  Â  Â  Â  <div id="search-results"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="header-actions" id="header-tabs"></div>
</header>

<div id="welcome-banner"></div>

<main id="main-content">
Â  Â  <div id="auth" class="tab-content">
Â  Â  Â  Â  <h2>Login</h2>
Â  Â  Â  Â  <input type="text" id="login-username" placeholder="Username">
Â  Â  Â  Â  <input type="password" id="login-password" placeholder="Password">
Â  Â  Â  Â  <button onclick="login()">Login</button>
Â  Â  Â  Â  <p>Or <span class="clickable-username" onclick="showSignup()">Sign Up</span></p>
Â  Â  </div>

Â  Â  <div id="signup" class="tab-content">
Â  Â  Â  Â  <h2>Sign Up </h2>
Â  Â  Â  Â  <input type="text" id="signup-username" placeholder="Username">
Â  Â  Â  Â  <input type="password" id="signup-password" placeholder="Password">
Â  Â  Â  Â  <button onclick="signup()">Create Account</button>
Â  Â  Â  Â  <p>Or <span class="clickable-username" onclick="showLogin()">Login</span></p>
Â  Â  </div>

Â  Â  <div id="home" class="tab-content">
Â  Â  Â  Â  <div id="new-post">
Â  Â  Â  Â  Â  Â  <textarea id="post-text" rows="3" placeholder="What's on your mind?"></textarea>
Â  Â  Â  Â  Â  Â  <label for="post-image-upload">Add Image (Optional):</label>
Â  Â  Â  Â  Â  Â  <input type="file" id="post-image-upload" accept="image/*" onchange="previewPostImage()">
Â  Â  Â  Â  Â  Â  <div id="post-image-preview" class="post-image-container" style="display:none; height: 150px; background: #000000;">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="post-image-tag" class="post-image" style="max-height: 100%; object-fit: contain;">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button onclick="addPost()">Post</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="posts"></div>
Â  Â  </div>

Â  Â  <div id="profile" class="tab-content">
Â  Â  Â  Â  <h2>My Profile</h2>
Â  Â  Â  Â  <img id="profile-pic-display" class="profile-image-small" src="" alt="Profile Picture"><br>
Â  Â  Â  Â  <label>Main Profile Picture:</label>
Â  Â  Â  Â  <input type="file" id="profile-upload" accept="image/*" onchange="uploadProfilePic()">
Â  Â  Â  Â  <textarea id="profile-bio" placeholder="Write your bio..."></textarea><br>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p>Username: <span id="my-profile-username"></span> <span id="owner-tag-me"></span></p>
Â  Â  Â  Â  <p>Total Posts: <span id="my-profile-posts-count"></span></p>
Â  Â  Â  Â  <p>Total Reactions Received: <span id="my-profile-likes-count"></span></p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <hr style="border-top: 1px solid #004400; margin: 20px 0;">

Â  Â  Â  Â  <h3>ğŸ¤ Following: <span id="my-profile-following-count">0</span> | Followers: <span id="my-profile-followers-count">0</span></h3>

Â  Â  Â  Â  <hr style="border-top: 1px solid #004400; margin: 20px 0;">

Â  Â  Â  Â  <h3>ğŸ–¼ï¸ Gallery (8 Images)</h3>
Â  Â  Â  Â  <p style="font-size:0.9em; color:#00CC00;">Click the current image to upload a replacement.</p>
Â  Â  Â  Â  <div class="gallery-container" id="my-gallery-edit">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button onclick="saveProfile()" style="margin-top: 30px;">Save Profile & Bio</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="view-profile" class="tab-content">
Â  Â  Â  Â  <div id="view-profile-content">
Â  Â  Â  Â  Â  Â  <img id="profile-pic-view" src="" alt="User Profile Picture"><br>
Â  Â  Â  Â  Â  Â  <h2 id="view-username"></h2>
Â  Â  Â  Â  Â  Â  <p id="view-owner-tag"></p>

Â  Â  Â  Â  Â  Â  <div id="view-user-status" class="status-container"></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="follow-button" onclick="toggleFollow()"></button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="startDM(viewingUsername)">Message</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <p style="margin-top: 15px;">Bio: <span id="view-bio"></span></p>
Â  Â  Â  Â  Â  Â  <p>Posts: <span id="view-posts-count"></span></p>
Â  Â  Â  Â  Â  Â  <p>Reactions Received: <span id="view-likes-received"></span></p>
Â  Â  Â  Â  Â  Â  <h3>ğŸ¤ Following: <span id="view-following-count">0</span> | Followers: <span id="view-followers-count">0</span></h3>

Â  Â  Â  Â  Â  Â  <hr style="border-top: 1px solid #004400; margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <h3>ğŸ–¼ï¸ Gallery</h3>
Â  Â  Â  Â  Â  Â  <div class="gallery-container" id="view-gallery">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <hr style="border-top: 1px solid #004400; margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <h3>User Posts</h3>
Â  Â  Â  Â  Â  Â  <div id="view-user-posts"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button onclick="showTab('home')" style="margin-top: 30px;">Back to Feed</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="messages" class="tab-content">
Â  Â  Â  Â  <h2>Direct Messages</h2>
Â  Â  Â  Â  <div id="message-view">
Â  Â  Â  Â  Â  Â  <h3>Chats:</h3>
Â  Â  Â  Â  Â  Â  <div id="messages-list">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="conversation-container" style="display: none; margin-top: 30px;">
Â  Â  Â  Â  Â  Â  <h3 id="chat-header"></h3>
Â  Â  Â  Â  Â  Â  <div id="chat-messages" class="chat-messages">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="send-message-area">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="message-input" placeholder="Type your message...">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="sendMessage()">Send</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="renderMessageList()" style="margin-top: 20px; width: auto; background: #333333;">&larr; Back to Chats</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="notifications" class="tab-content">
Â  Â  Â  Â  <h2>ğŸ”” NotificationsÂ </h2>
Â  Â  Â  Â  <div id="notifications-display">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>


Â  Â  <div id="settings" class="tab-content">
Â  Â  Â  Â  <h2>Settings</h2>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h3>Account Management</h3>
Â  Â  Â  Â  <label>Change username: <input type="text" id="change-username"></label><br>
Â  Â  Â  Â  <button onclick="changeUsername()">Save New Username</button>
Â  Â  Â  Â  <button onclick="logout()" class="settings-button" style="background: #CC0000;">Logout</button>

Â  Â  Â  Â  <hr style="border-top: 1px solid #004400; margin: 30px 0;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h3>ğŸŒ Cross-Device Sync (Manual)</h3>
Â  Â  Â  Â  <p style="font-size: 0.9em; color: #00CC00; line-height: 1.4;">
Â  Â  Â  Â  Â  Â  To synchronize data between devices (e.g., PC and Mobile), use the Export button on the device with the *newest* data,Â 
Â  Â  Â  Â  Â  Â  and use the Import button on the device with the *older* data.
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <button onclick="exportData()" class="settings-button" style="background: #333333;">Export Data (Copy to Clipboard)</button>
Â  Â  Â  Â  <button onclick="importData()" class="settings-button" style="background: #0088AA;">Import Data (Paste & Overwrite)</button>
Â  Â  Â  Â Â 
Â  Â  </div>
</main>

<footer>&copy; 2025 Tr3vMedia â€” All Rights Reserved</footer>

<nav id="mobile-nav">
Â  Â  <div class="mobile-tab-container">
Â  Â  Â  Â  <div class="mobile-nav-item" onclick="showTab('home')">
Â  Â  Â  Â  Â  Â  <span class="material-icons">home</span>
Â  Â  Â  Â  Â  Â  Home
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mobile-nav-item" id="mobile-messages-tab" onclick="showTab('messages')">
Â  Â  Â  Â  Â  Â  <span class="material-icons">message</span>
Â  Â  Â  Â  Â  Â  Messages
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mobile-nav-item" id="mobile-notifications-tab" onclick="showTab('notifications')">
Â  Â  Â  Â  Â  Â  <span class="material-icons">notifications</span>
Â  Â  Â  Â  Â  Â  Notifications
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mobile-nav-item" onclick="showTab('profile')">
Â  Â  Â  Â  Â  Â  <span class="material-icons">person</span>
Â  Â  Â  Â  Â  Â  Profile
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mobile-nav-item" onclick="showTab('settings')">
Â  Â  Â  Â  Â  Â  <span class="material-icons">settings</span>
Â  Â  Â  Â  Â  Â  Settings
Â  Â  Â  Â  </div>
Â  Â  </div>
</nav>

<script>
// --- Global Constants & State ---
const DEFAULT_PIC = 'https://via.placeholder.com/60';
const DEFAULT_GALLERY_ITEM = 'https://via.placeholder.com/150x150?text=Empty+Slot';
const REACTIONS = ['like', 'heart', 'star'];Â 
const GALLERY_SIZE = 8;Â 

let currentPostImage = null;Â 
let viewingUsername = null;Â 
let currentChatPartner = null;Â 

// Helper function to format date
function formatTimestamp(timestamp) {
Â  Â  const now = new Date();
Â  Â  const then = new Date(timestamp);
Â  Â  const diff = now - then;

Â  Â  if (diff < 60000) return 'Just now';Â 
Â  Â  if (diff < 3600000) return Math.round(diff / 60000) + 'm ago';Â 
Â  Â  if (diff < 86400000) return Math.round(diff / 3600000) + 'h ago';Â 
Â  Â  if (diff < 604800000) return Math.round(diff / 86400000) + 'd ago';
Â  Â Â 
Â  Â  return then.toLocaleDateString();Â 
}

// Helper to create a standardized conversation ID (alphabetical sorting ensures consistency)
function getChatID(user1, user2) {
Â  Â  return [user1, user2].sort().join('_');
}

// ------------------ Data Setup ------------------

// Define the absolute default data
const DEFAULT_USER_DATA = {
Â  Â  'Tr3vN0x': {
Â  Â  Â  Â  password:'ownerpass',Â 
Â  Â  Â  Â  profilePic:DEFAULT_PIC,Â 
Â  Â  Â  Â  bio:'Owner of Tr3vMedia',Â 
Â  Â  Â  Â  gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM),Â 
Â  Â  Â  Â  followers: ['TestUser1'],Â 
Â  Â  Â  Â  following: ['TestUser1'],Â 
Â  Â  Â  Â  isActive: false,Â 
Â  Â  Â  Â  lastOnline: Date.now() - 600000,Â 
Â  Â  Â  Â  notifications: [],Â 
Â  Â  Â  Â  posts:[
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'Welcome to Tr3vMedia! This site just got a whole lot cooler. Check out this placeholder!',Â 
Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: 'https://via.placeholder.com/400x200?text=Site+Launch+Image',Â 
Â  Â  Â  Â  Â  Â  Â  Â  date: Date.now(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  reactions: {like: [], heart: [], star: []},
Â  Â  Â  Â  Â  Â  Â  Â  comments: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {user: 'TestUser1', text: 'Looks awesome!'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {user: 'Tr3vN0x', text: 'Thanks! Enjoy the new features.'}
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ]
Â  Â  },
Â  Â  'TestUser1': {
Â  Â  Â  Â  password:'password',Â 
Â  Â  Â  Â  profilePic:DEFAULT_PIC,Â 
Â  Â  Â  Â  bio:'Just a friendly user.',Â 
Â  Â  Â  Â  gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM).map((_, i) => i === 0 ? 'https://via.placeholder.com/150x150?text=Cool+Pic' : DEFAULT_GALLERY_ITEM),Â 
Â  Â  Â  Â  followers: ['Tr3vN0x'],Â 
Â  Â  Â  Â  following: ['Tr3vN0x'],Â 
Â  Â  Â  Â  isActive: false,Â 
Â  Â  Â  Â  lastOnline: Date.now() - 10000000,Â 
Â  Â  Â  Â  notifications: [],Â 
Â  Â  Â  Â  posts:[
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'Testing the new clean style overhaul. Looking very polished!',Â 
Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: null,
Â  Â  Â  Â  Â  Â  Â  Â  date: Date.now() - 5000000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  reactions: {like: ['Tr3vN0x'], heart: [], star: []},
Â  Â  Â  Â  Â  Â  Â  Â  comments: []
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ]
Â  Â  }
};

const DEFAULT_MESSAGES_DATA = {
Â  Â  [getChatID('Tr3vN0x', 'TestUser1')]: [
Â  Â  Â  Â  { sender: 'TestUser1', text: 'Hey Tr3v, love the new DM feature!', date: Date.now() - 3600000 },
Â  Â  Â  Â  { sender: 'Tr3vN0x', text: 'Thanks! Let me know if you run into any bugs.', date: Date.now() - 3500000 }
Â  Â  ]
};

// Function to initialize or merge dataÂ 
function initializeOrMergeData() {
Â  Â  let currentUsers = {};
Â  Â  let currentMessages = {};
Â  Â  let dataChanged = false;

Â  Â  // Load existing data from localStorage
Â  Â  try {
Â  Â  Â  Â  const storedUsers = localStorage.getItem('users');
Â  Â  Â  Â  if (storedUsers) {
Â  Â  Â  Â  Â  Â  currentUsers = JSON.parse(storedUsers);
Â  Â  Â  Â  }
Â  Â  } catch (e) { console.error("Error parsing stored users.", e); }

Â  Â  try {
Â  Â  Â  Â  const storedMessages = localStorage.getItem('messages');
Â  Â  Â  Â  if (storedMessages) {
Â  Â  Â  Â  Â  Â  currentMessages = JSON.parse(storedMessages);
Â  Â  Â  Â  }
Â  Â  } catch (e) { console.error("Error parsing stored messages.", e); }
Â  Â Â 
Â  Â  let mergedUsers = {...currentUsers};
Â  Â  let mergedMessages = {...currentMessages};
Â  Â Â 
Â  Â  // 1. Inject default users if missing
Â  Â  for (const defaultUser in DEFAULT_USER_DATA) {
Â  Â  Â  Â  if (!mergedUsers[defaultUser]) {
Â  Â  Â  Â  Â  Â  mergedUsers[defaultUser] = DEFAULT_USER_DATA[defaultUser];
Â  Â  Â  Â  Â  Â  dataChanged = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 2. Ensure all data structure properties are present for all users
Â  Â  for (const username of Object.keys(mergedUsers)) {
Â  Â  Â  Â  const user = mergedUsers[username];
Â  Â  Â  Â  if (!user.notifications) { user.notifications = []; dataChanged = true; }
Â  Â  Â  Â  if (!user.followers) { user.followers = []; dataChanged = true; }
Â  Â  Â  Â  if (!user.following) { user.following = []; dataChanged = true; }
Â  Â  Â  Â  if (!user.lastRead) { user.lastRead = {}; dataChanged = true; } // New property for messages read status
Â  Â  Â  Â  if (!user.gallery || user.gallery.length !== GALLERY_SIZE) {Â 
Â  Â  Â  Â  Â  Â  user.gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);Â 
Â  Â  Â  Â  Â  Â  dataChanged = true;Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 3. Inject default messages if missing
Â  Â  for (const chatID in DEFAULT_MESSAGES_DATA) {
Â  Â  Â  Â  if (!mergedMessages[chatID]) {
Â  Â  Â  Â  Â  Â  mergedMessages[chatID] = DEFAULT_MESSAGES_DATA[chatID];
Â  Â  Â  Â  Â  Â  dataChanged = true;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 4. Save if any changes were made
Â  Â  if (dataChanged) {
Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(mergedUsers));
Â  Â  Â  Â  localStorage.setItem('messages', JSON.stringify(mergedMessages));
Â  Â  }
Â  Â Â 
Â  Â  return dataChanged;
}

// Function to safely get all users (always triggers a merge first)
function getAllUsers() {
Â  Â  initializeOrMergeData();Â 
Â  Â  return JSON.parse(localStorage.getItem('users'));
}

// Function to safely get all messages (always triggers a merge first)
function getAllMessages() {
Â  Â  initializeOrMergeData();
Â  Â  return JSON.parse(localStorage.getItem('messages'));
}


// ------------------ Data Export/Import (THE CROSS-PLATFORM FIX) ------------------

function exportData() {
Â  Â  const data = {
Â  Â  Â  Â  users: localStorage.getItem('users'),
Â  Â  Â  Â  messages: localStorage.getItem('messages'),
Â  Â  Â  Â  currentUser: localStorage.getItem('currentUser')Â 
Â  Â  };
Â  Â Â 
Â  Â  const dataString = JSON.stringify(data);

Â  Â  // Use modern Clipboard API if available, otherwise fallback to deprecated method
Â  Â  if (navigator.clipboard && window.isSecureContext) {
Â  Â  Â  Â  navigator.clipboard.writeText(dataString).then(() => {
Â  Â  Â  Â  Â  Â  alert("Data exported! The entire app data has been copied to your clipboard. Paste this into the 'Import Data' prompt on your other device.");
Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  console.error('Could not copy text: ', err);
Â  Â  Â  Â  Â  Â  alert("Could not copy data to clipboard automatically. Please check the console for the data string and copy it manually.");
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  // Fallback for older browsers or non-secure contexts (e.g., local files)
Â  Â  Â  Â  prompt("Data Exported (Copy the text below):", dataString);
Â  Â  }
}

function importData() {
Â  Â  const dataString = prompt("Paste the exported data string here. WARNING: This will overwrite your current app data.");
Â  Â Â 
Â  Â  if (!dataString) return;Â 

Â  Â  try {
Â  Â  Â  Â  const importedData = JSON.parse(dataString);

Â  Â  Â  Â  if (!importedData.users || !importedData.messages) {
Â  Â  Â  Â  Â  Â  alert("Import failed: The pasted data is missing required sections (users or messages).");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Apply imported data
Â  Â  Â  Â  localStorage.setItem('users', importedData.users);
Â  Â  Â  Â  localStorage.setItem('messages', importedData.messages);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Only set currentUser if the imported data has one (it should)
Â  Â  Â  Â  if (importedData.currentUser) {
Â  Â  Â  Â  Â  Â  localStorage.setItem('currentUser', importedData.currentUser);
Â  Â  Â  Â  }

Â  Â  Â  Â  alert("Data successfully imported! The app will now reload to apply the changes.");
Â  Â  Â  Â  location.reload();

Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Import failed: The pasted data is not valid JSON format. Please ensure you copied the entire string.");
Â  Â  Â  Â  console.error("Import Error:", e);
Â  Â  }
}

// ------------------ Auth Tabs ------------------
function showLogin() {document.getElementById('signup').style.display='none'; document.getElementById('auth').style.display='block';}
function showSignup() {document.getElementById('auth').style.display='none'; document.getElementById('signup').style.display='block';}

// ------------------ Signup / Login ------------------
function signup(){
Â  Â  const username = document.getElementById('signup-username').value.trim();
Â  Â  const password = document.getElementById('signup-password').value.trim();
Â  Â  if(!username||!password){alert("Fill all fields"); return;}
Â  Â Â 
Â  Â  const users = getAllUsers(); // Use new helper
Â  Â  if(users[username]){alert("Username taken"); return;}
Â  Â Â 
Â  Â  users[username]={
Â  Â  Â  Â  password,
Â  Â  Â  Â  profilePic:DEFAULT_PIC,
Â  Â  Â  Â  bio:'',
Â  Â  Â  Â  posts:[],
Â  Â  Â  Â  gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM),
Â  Â  Â  Â  followers: [],Â 
Â  Â  Â  Â  following: [],
Â  Â  Â  Â  isActive: false,Â 
Â  Â  Â  Â  lastOnline: Date.now(),Â 
Â  Â  Â  Â  notifications: [],
Â  Â  Â  Â  lastRead: {}
Â  Â  };Â 
Â  Â Â 
Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  alert("Account created! Login now.");
Â  Â  showLogin();
}

function login(){
Â  Â  const username = document.getElementById('login-username').value.trim();
Â  Â  const password = document.getElementById('login-password').value.trim();
Â  Â  const users = getAllUsers(); // Use new helper

Â  Â  if(!users[username] || users[username].password!==password){alert("Invalid credentials"); return;}
Â  Â Â 
Â  Â  // Update active status when logging in
Â  Â  users[username].isActive = true;Â 
Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â Â 
Â  Â  localStorage.setItem('currentUser', username);
Â  Â  initApp();
}

// ------------------ App Init ------------------
function initApp(){
Â  Â  document.getElementById('auth').style.display='none';
Â  Â  document.getElementById('signup').style.display='none';
Â  Â Â 
Â  Â  document.getElementById('welcome-banner').innerText=`Hello ${localStorage.getItem('currentUser')}!`;
Â  Â Â 
Â  Â  // Desktop Tabs
Â  Â  document.getElementById('header-tabs').innerHTML=`
Â  Â  Â  Â  <div class="nav-tab" onclick="showTab('home')">Home</div>
Â  Â  Â  Â  <div class="nav-tab" id="messages-tab" onclick="showTab('messages')">Messages</div>
Â  Â  Â  Â  <div class="nav-tab" id="notifications-tab" onclick="showTab('notifications')">Notifications</div>
Â  Â  Â  Â  <div class="nav-tab" onclick="showTab('profile')">Profile</div>
Â  Â  Â  Â  <div class="nav-tab" onclick="showTab('settings')">Settings</div>
Â  Â  Â  Â  <div class="nav-tab" onclick="logout()">Logout</div>`;
Â  Â Â 
Â  Â  loadUser();
Â  Â  updateNotificationBadges();Â 
Â  Â  showTab('home');Â 
}

// ------------------ Logout ------------------
function logout(){
Â  Â  const users = getAllUsers(); // Use new helper
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  if (users[currentUser]) 
Â  Â  {
Â  Â  Â  Â  users[currentUser].isActive = false;Â 
Â  Â  Â  Â  users[currentUser].lastOnline = Date.now();Â 
Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  }
Â  Â Â 
Â  Â  localStorage.removeItem('currentUser');
Â  Â  location.reload();Â 
}

// ------------------ Tab Management ------------------

// Function to update the notification badges on both desktop and mobile
function updateNotificationBadges() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  if (!currentUser) return;

Â  Â  const users = getAllUsers();
Â  Â  const messages = getAllMessages();

Â  Â  // 1. Notifications Tab
Â  Â  const unreadNotifications = users[currentUser].notifications.filter(n => !n.read).length;
Â  Â  const desktopNotifTab = document.getElementById('notifications-tab');
Â  Â  const mobileNotifTab = document.getElementById('mobile-notifications-tab');
Â  Â Â 
Â  Â  if (desktopNotifTab) {
Â  Â  Â  Â  // Clear existing badge
Â  Â  Â  Â  desktopNotifTab.querySelectorAll('.notification-badge').forEach(badge => badge.remove());
Â  Â  Â  Â  if (unreadNotifications > 0) {
Â  Â  Â  Â  Â  Â  desktopNotifTab.innerHTML += `<span class="notification-badge">${unreadNotifications}</span>`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (mobileNotifTab) {
Â  Â  Â  Â  mobileNotifTab.querySelectorAll('.mobile-notification-badge').forEach(badge => badge.remove());
Â  Â  Â  Â  if (unreadNotifications > 0) {
Â  Â  Â  Â  Â  Â  mobileNotifTab.innerHTML += `<span class="mobile-notification-badge">${unreadNotifications}</span>`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 2. Messages Tab
Â  Â  let unreadChats = 0;
Â  Â  for (const chatID in messages) {
Â  Â  Â  Â  const chat = messages[chatID];
Â  Â  Â  Â  const isParticipant = chatID.includes(currentUser);
Â  Â  Â  Â  if (isParticipant) {
Â  Â  Â  Â  Â  Â  const lastMessage = chat[chat.length - 1];
Â  Â  Â  Â  Â  Â  const otherUser = chatID.split('_').find(u => u !== currentUser);
Â  Â  Â  Â  Â  Â  const lastReadTimestamp = users[currentUser].lastRead?.[otherUser] || 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (lastMessage && lastMessage.sender !== currentUser && lastMessage.date > lastReadTimestamp) {
Â  Â  Â  Â  Â  Â  Â  Â  unreadChats++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const desktopMsgTab = document.getElementById('messages-tab');
Â  Â  const mobileMsgTab = document.getElementById('mobile-messages-tab');

Â  Â  if (desktopMsgTab) {
Â  Â  Â  Â  desktopMsgTab.querySelectorAll('.notification-badge').forEach(badge => badge.remove());
Â  Â  Â  Â  if (unreadChats > 0) {
Â  Â  Â  Â  Â  Â  desktopMsgTab.innerHTML += `<span class="notification-badge">${unreadChats}</span>`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (mobileMsgTab) {
Â  Â  Â  Â  mobileMsgTab.querySelectorAll('.mobile-notification-badge').forEach(badge => badge.remove());
Â  Â  Â  Â  if (unreadChats > 0) {
Â  Â  Â  Â  Â  Â  mobileMsgTab.innerHTML += `<span class="mobile-notification-badge">${unreadChats}</span>`;
Â  Â  Â  Â  }
Â  Â  }
}


function showTab(tabId, data = null) {
Â  Â  // Hide all content sections
Â  Â  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
Â  Â Â 
Â  Â  // Remove active class from desktop and mobile tabs
Â  Â  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
Â  Â  document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));

Â  Â  // Show the selected section
Â  Â  const targetElement = document.getElementById(tabId);
Â  Â  if (targetElement) {
Â  Â  Â  Â  targetElement.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  console.error(`Tab element with ID '${tabId}' not found.`);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Add active class to corresponding desktop tab
Â  Â  const desktopTab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
Â  Â  if (desktopTab) {
Â  Â  Â  Â  desktopTab.classList.add('active');
Â  Â  }
Â  Â  // Add active class to corresponding mobile tab
Â  Â  const mobileTab = document.querySelector(`.mobile-nav-item[onclick*="showTab('${tabId}')"]`);
Â  Â  if (mobileTab) {
Â  Â  Â  Â  mobileTab.classList.add('active');
Â  Â  }
Â  Â Â 
Â  Â  // Specific tab logic
Â  Â  if (tabId === 'home') {
Â  Â  Â  Â  renderPosts();
Â  Â  } else if (tabId === 'profile') {
Â  Â  Â  Â  renderMyProfile();
Â  Â  } else if (tabId === 'view-profile' && data) {
Â  Â  Â  Â  renderViewProfile(data);
Â  Â  } else if (tabId === 'messages') {
Â  Â  Â  Â  renderMessageList();
Â  Â  } else if (tabId === 'notifications') {
Â  Â  Â  Â  renderNotifications();
Â  Â  }

Â  Â  // Scroll to the top of the main content area
Â  Â  document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' });
}

// ------------------ Posts & Feed ------------------
function renderPosts(){
Â  Â  const users = getAllUsers();
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const myFollowing = users[currentUser].following;
Â  Â  const postsContainer = document.getElementById('posts');
Â  Â  postsContainer.innerHTML = '';
Â  Â Â 
Â  Â  let allPosts = [];
Â  Â  for(const username in users){
Â  Â  Â  Â  // Only show posts from self and followed users (for a simple feed implementation)
Â  Â  Â  Â  if(username === currentUser || myFollowing.includes(username)){
Â  Â  Â  Â  Â  Â  users[username].posts.forEach((post, postIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  allPosts.push({username, post, postIndex});
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Sort by date descending (newest first)
Â  Â  allPosts.sort((a, b) => b.post.date - a.post.date);

Â  Â  allPosts.forEach(({username, post, postIndex}) => {
Â  Â  Â  Â  const isOwner = username === currentUser;
Â  Â  Â  Â  const postEl = document.createElement('div');
Â  Â  Â  Â  postEl.className = 'post';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reactions & Counts
Â  Â  Â  Â  let reactionButtons = REACTIONS.map(reaction => {
Â  Â  Â  Â  Â  Â  const count = post.reactions[reaction].length;
Â  Â  Â  Â  Â  Â  const reacted = post.reactions[reaction].includes(currentUser);
Â  Â  Â  Â  Â  Â  return `<button onclick="toggleReaction('${username}', ${postIndex}, '${reaction}')" style="${reacted ? 'background:#00CC00; color:white;' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  ${getReactionEmoji(reaction)} ${count > 0 ? count : ''}
Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  }).join('');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Total Reactions
Â  Â  Â  Â  const totalReactions = REACTIONS.reduce((sum, r) => sum + post.reactions[r].length, 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Comments rendering
Â  Â  Â  Â  let commentsHtml = post.comments.map(comment => `
Â  Â  Â  Â  Â  Â  <div class="comment">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment-user clickable-username" onclick="showTab('view-profile', '${comment.user}')">${comment.user}</span>: ${comment.text}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `).join('');

Â  Â  Â  Â  postEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="post-header">
Â  Â  Â  Â  Â  Â  Â  Â  <img class="profile-image-small" src="${users[username].profilePic}" alt="Profile Picture">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="clickable-username" onclick="showTab('view-profile', '${username}')">${username}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isOwner ? '<span class="verified">Owner</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="post-timestamp"> &mdash; ${formatTimestamp(post.date)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="post-content">${post.text.replace(/\n/g, '<br>')}</div>
Â  Â  Â  Â  Â  Â  ${post.imageUrl ? `<div class="post-image-container"><img class="post-image" src="${post.imageUrl}" alt="Post Image"></div>` : ''}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="post-actions">
Â  Â  Â  Â  Â  Â  Â  Â  ${reactionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  <span class="reaction-count">(${totalReactions} total reactions)</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="comments-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Comments (${post.comments.length})</h4>
Â  Â  Â  Â  Â  Â  Â  Â  ${commentsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="comment-input-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="comment-input-${username}-${postIndex}" placeholder="Add a comment...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="addComment('${username}', ${postIndex})">Post</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  postsContainer.appendChild(postEl);
Â  Â  });
}

function getReactionEmoji(reaction) {
Â  Â  switch (reaction) {
Â  Â  Â  Â  case 'like': return 'ğŸ‘';
Â  Â  Â  Â  case 'heart': return 'â¤ï¸';
Â  Â  Â  Â  case 'star': return 'â­';
Â  Â  Â  Â  default: return '';
Â  Â  }
}

function previewPostImage() {
Â  Â  const input = document.getElementById('post-image-upload');
Â  Â  const previewContainer = document.getElementById('post-image-preview');
Â  Â  const previewTag = document.getElementById('post-image-tag');
Â  Â Â 
Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function (e) {
Â  Â  Â  Â  Â  Â  previewTag.src = e.target.result;
Â  Â  Â  Â  Â  Â  currentPostImage = e.target.result;Â 
Â  Â  Â  Â  Â  Â  previewContainer.style.display = 'block';
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(input.files[0]);
Â  Â  } else {
Â  Â  Â  Â  previewContainer.style.display = 'none';
Â  Â  Â  Â  previewTag.src = '';
Â  Â  Â  Â  currentPostImage = null;
Â  Â  }
}

function addPost() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const postText = document.getElementById('post-text').value.trim();
Â  Â Â 
Â  Â  if (!postText && !currentPostImage) {
Â  Â  Â  Â  alert("Post cannot be empty.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const users = getAllUsers();
Â  Â Â 
Â  Â  // Create a new post object
Â  Â  const newPost = {
Â  Â  Â  Â  text: postText,
Â  Â  Â  Â  imageUrl: currentPostImage, // Base64 data or null
Â  Â  Â  Â  date: Date.now(),
Â  Â  Â  Â  reactions: {like: [], heart: [], star: []},
Â  Â  Â  Â  comments: []
Â  Â  };

Â  Â  // Add to the beginning of the user's posts array
Â  Â  users[currentUser].posts.unshift(newPost);
Â  Â Â 
Â  Â  localStorage.setItem('users', JSON.stringify(users));

Â  Â  // Clear the form
Â  Â  document.getElementById('post-text').value = '';
Â  Â  document.getElementById('post-image-upload').value = null; // Clear file input
Â  Â  document.getElementById('post-image-preview').style.display = 'none';
Â  Â  document.getElementById('post-image-tag').src = '';
Â  Â  currentPostImage = null;

Â  Â  renderPosts();Â 
}

function toggleReaction(postUser, postIndex, reaction) {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const users = getAllUsers();
Â  Â  const post = users[postUser].posts[postIndex];

Â  Â  if (!post) return;

Â  Â  const currentReactions = post.reactions[reaction];

Â  Â  if (currentReactions.includes(currentUser)) {
Â  Â  Â  Â  // User un-reacted
Â  Â  Â  Â  post.reactions[reaction] = currentReactions.filter(u => u !== currentUser);
Â  Â  } else {
Â  Â  Â  Â  // User reacted: remove any existing reaction first
Â  Â  Â  Â  REACTIONS.forEach(r => {
Â  Â  Â  Â  Â  Â  post.reactions[r] = post.reactions[r].filter(u => u !== currentUser);
Â  Â  Â  Â  });
Â  Â  Â  Â  // Add new reaction
Â  Â  Â  Â  post.reactions[reaction].push(currentUser);

Â  Â  Â  Â  // Notify the post owner (unless it's self-reaction)
Â  Â  Â  Â  if (postUser !== currentUser) {
Â  Â  Â  Â  Â  Â  addNotification(postUser, `${currentUser} reacted with a ${getReactionEmoji(reaction)} to your post.`);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  // Re-render the feed to update counts/buttons
Â  Â  renderPosts();Â 
}

function addComment(postUser, postIndex) {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const commentInput = document.getElementById(`comment-input-${postUser}-${postIndex}`);
Â  Â  const commentText = commentInput.value.trim();

Â  Â  if (!commentText) return;

Â  Â  const users = getAllUsers();
Â  Â  const post = users[postUser].posts[postIndex];

Â  Â  if (post) {
Â  Â  Â  Â  post.comments.push({
Â  Â  Â  Â  Â  Â  user: currentUser,
Â  Â  Â  Â  Â  Â  text: commentText
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Notify the post owner (unless it's self-comment)
Â  Â  Â  Â  if (postUser !== currentUser) {
Â  Â  Â  Â  Â  Â  addNotification(postUser, `${currentUser} commented on your post: "${commentText.substring(0, 30)}..."`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  commentInput.value = '';Â 
Â  Â  Â  Â  renderPosts();Â 
Â  Â  }
}


// ------------------ Profile Management ------------------
function loadUser() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  if (!currentUser) {
Â  Â  Â  Â  showLogin();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const users = getAllUsers();
Â  Â  const user = users[currentUser];

Â  Â  // Set initial profile display elements
Â  Â  document.getElementById('profile-pic-display').src = user.profilePic;
Â  Â  document.getElementById('profile-bio').value = user.bio;
Â  Â  document.getElementById('my-profile-username').innerText = currentUser;
Â  Â  document.getElementById('owner-tag-me').innerHTML = (currentUser === 'Tr3vN0x' ? '<span class="verified">Owner</span>' : '');

Â  Â  // Initialize gallery edit slots
Â  Â  const galleryContainer = document.getElementById('my-gallery-edit');
Â  Â  galleryContainer.innerHTML = '';
Â  Â  for (let i = 0; i < GALLERY_SIZE; i++) {
Â  Â  Â  Â  const slot = document.createElement('div');
Â  Â  Â  Â  slot.className = 'gallery-slot';
Â  Â  Â  Â  slot.innerHTML = `
Â  Â  Â  Â  Â  Â  <img id="gallery-image-${i}" class="gallery-image-display" src="${user.gallery[i]}" alt="Gallery Image ${i}" onclick="triggerGalleryUpload(${i})">
Â  Â  Â  Â  Â  Â  <input type="file" id="gallery-upload-${i}" accept="image/*" style="display:none;" onchange="uploadGalleryPic(${i})">
Â  Â  Â  Â  `;
Â  Â  Â  Â  galleryContainer.appendChild(slot);
Â  Â  }
}

function renderMyProfile() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const users = getAllUsers();
Â  Â  const user = users[currentUser];

Â  Â  // Calculate total reactions
Â  Â  let totalReactions = 0;
Â  Â  user.posts.forEach(post => {
Â  Â  Â  Â  REACTIONS.forEach(r => {
Â  Â  Â  Â  Â  Â  totalReactions += post.reactions[r].length;
Â  Â  Â  Â  });
Â  Â  });

Â  Â  document.getElementById('profile-pic-display').src = user.profilePic;
Â  Â  document.getElementById('profile-bio').value = user.bio;
Â  Â  document.getElementById('my-profile-posts-count').innerText = user.posts.length;
Â  Â  document.getElementById('my-profile-likes-count').innerText = totalReactions;
Â  Â  document.getElementById('my-profile-following-count').innerText = user.following.length;
Â  Â  document.getElementById('my-profile-followers-count').innerText = user.followers.length;
Â  Â Â 
Â  Â  // Refresh gallery images in the edit view
Â  Â  for (let i = 0; i < GALLERY_SIZE; i++) {
Â  Â  Â  Â  document.getElementById(`gallery-image-${i}`).src = user.gallery[i];
Â  Â  }
}

function saveProfile() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const users = getAllUsers();
Â  Â Â 
Â  Â  users[currentUser].bio = document.getElementById('profile-bio').value;
Â  Â Â 
Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  alert("Profile and Bio saved!");
}

function uploadProfilePic() {
Â  Â  const input = document.getElementById('profile-upload');
Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function (e) {
Â  Â  Â  Â  Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  Â  Â  Â  Â  const users = getAllUsers();
Â  Â  Â  Â  Â  Â  users[currentUser].profilePic = e.target.result;
Â  Â  Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  Â  Â  renderMyProfile(); // Re-render to update the display
Â  Â  Â  Â  Â  Â  alert("Profile picture updated!");
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(input.files[0]);
Â  Â  }
}

function triggerGalleryUpload(index) {
Â  Â  document.getElementById(`gallery-upload-${index}`).click();
}

function uploadGalleryPic(index) {
Â  Â  const input = document.getElementById(`gallery-upload-${index}`);
Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function (e) {
Â  Â  Â  Â  Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  Â  Â  Â  Â  const users = getAllUsers();
Â  Â  Â  Â  Â  Â  users[currentUser].gallery[index] = e.target.result;
Â  Â  Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  Â  Â  renderMyProfile();Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(input.files[0]);
Â  Â  }
}

// ------------------ View Profile & Follow Logic ------------------

function renderViewProfile(username) {
Â  Â  const users = getAllUsers();
Â  Â  const user = users[username];
Â  Â  const currentUser = localStorage.getItem('currentUser');

Â  Â  if (!user) {
Â  Â  Â  Â  alert("User not found.");
Â  Â  Â  Â  showTab('home');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  viewingUsername = username; // Set global state for follow/message actions

Â  Â  document.getElementById('view-username').innerText = username;
Â  Â  document.getElementById('view-bio').innerText = user.bio || 'No bio set.';
Â  Â  document.getElementById('profile-pic-view').src = user.profilePic;
Â  Â  document.getElementById('view-owner-tag').innerHTML = (username === 'Tr3vN0x' ? '<span class="verified">Owner</span>' : '');

Â  Â  // User Status
Â  Â  const statusContainer = document.getElementById('view-user-status');
Â  Â  statusContainer.innerHTML = '';
Â  Â  if (user.isActive) {
Â  Â  Â  Â  statusContainer.innerHTML = '<div class="active-dot"></div><span style="color:#00FF00;">Active Now</span>';
Â  Â  } else {
Â  Â  Â  Â  statusContainer.innerHTML = `<span class="last-online-text">Last Online: ${formatTimestamp(user.lastOnline)}</span>`;
Â  Â  }

Â  Â  // Follow Button
Â  Â  const followButton = document.getElementById('follow-button');
Â  Â  if (username === currentUser) {
Â  Â  Â  Â  followButton.style.display = 'none'; // Cannot follow self
Â  Â  } else {
Â  Â  Â  Â  followButton.style.display = 'inline-block';
Â  Â  Â  Â  const isFollowing = users[currentUser].following.includes(username);
Â  Â  Â  Â  if (isFollowing) {
Â  Â  Â  Â  Â  Â  followButton.innerText = 'Unfollow';
Â  Â  Â  Â  Â  Â  followButton.classList.add('unfollow');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  followButton.innerText = 'Follow';
Â  Â  Â  Â  Â  Â  followButton.classList.remove('unfollow');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Counts
Â  Â  let totalReactions = 0;
Â  Â  user.posts.forEach(post => {
Â  Â  Â  Â  REACTIONS.forEach(r => {
Â  Â  Â  Â  Â  Â  totalReactions += post.reactions[r].length;
Â  Â  Â  Â  });
Â  Â  });
Â  Â  document.getElementById('view-posts-count').innerText = user.posts.length;
Â  Â  document.getElementById('view-likes-received').innerText = totalReactions;
Â  Â  document.getElementById('view-following-count').innerText = user.following.length;
Â  Â  document.getElementById('view-followers-count').innerText = user.followers.length;
Â  Â Â 
Â  Â  // Gallery View
Â  Â  const galleryContainer = document.getElementById('view-gallery');
Â  Â  galleryContainer.innerHTML = user.gallery.map((img, i) => `
Â  Â  Â  Â  <div class="gallery-slot">
Â  Â  Â  Â  Â  Â  <img class="gallery-image-display" src="${img}" alt="Gallery Image ${i}" style="cursor: default;">
Â  Â  Â  Â  </div>
Â  Â  `).join('');

Â  Â  // User Posts View
Â  Â  const userPostsContainer = document.getElementById('view-user-posts');
Â  Â  userPostsContainer.innerHTML = '';
Â  Â  user.posts.forEach((post, postIndex) => {
Â  Â  Â  Â  // Simple post preview for profile view (no comments/actions for simplicity)
Â  Â  Â  Â  const postEl = document.createElement('div');
Â  Â  Â  Â  postEl.className = 'post';
Â  Â  Â  Â  postEl.style.marginBottom = '10px';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const totalPostReactions = REACTIONS.reduce((sum, r) => sum + post.reactions[r].length, 0);

Â  Â  Â  Â  postEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <p style="font-size:0.9em; color:#00CC00; font-weight:bold;">${formatTimestamp(post.date)}</p>
Â  Â  Â  Â  Â  Â  <div class="post-content">${post.text.substring(0, 150)}${post.text.length > 150 ? '...' : ''}</div>
Â  Â  Â  Â  Â  Â  ${post.imageUrl ? `<div class="post-image-container" style="max-height:100px; margin-top:0;"><img class="post-image" src="${post.imageUrl}" alt="Post Image"></div>` : ''}
Â  Â  Â  Â  Â  Â  <p style="font-size:0.8em; margin-top:5px;">Reactions: ${totalPostReactions} | Comments: ${post.comments.length}</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  userPostsContainer.appendChild(postEl);
Â  Â  });
}


function toggleFollow() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const users = getAllUsers();
Â  Â  const targetUser = viewingUsername;

Â  Â  if (targetUser === currentUser || !users[targetUser]) return;

Â  Â  const isFollowing = users[currentUser].following.includes(targetUser);

Â  Â  if (isFollowing) {
Â  Â  Â  Â  // Unfollow
Â  Â  Â  Â  users[currentUser].following = users[currentUser].following.filter(u => u !== targetUser);
Â  Â  Â  Â  users[targetUser].followers = users[targetUser].followers.filter(u => u !== currentUser);
Â  Â  Â  Â  alert(`You have unfollowed ${targetUser}.`);
Â  Â  } else {
Â  Â  Â  Â  // Follow
Â  Â  Â  Â  users[currentUser].following.push(targetUser);
Â  Â  Â  Â  users[targetUser].followers.push(currentUser);
Â  Â  Â  Â  addNotification(targetUser, `${currentUser} started following you.`);
Â  Â  Â  Â  alert(`You are now following ${targetUser}.`);
Â  Â  }

Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  renderViewProfile(targetUser); // Re-render to update button state and counts
}


// ------------------ Search ------------------
function searchUsers() {
Â  Â  const input = document.getElementById('search-input');
Â  Â  const resultsDiv = document.getElementById('search-results');
Â  Â  const query = input.value.trim().toLowerCase();
Â  Â  resultsDiv.innerHTML = '';

Â  Â  if (query.length < 2) {
Â  Â  Â  Â  resultsDiv.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const users = getAllUsers();
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const matches = [];

Â  Â  for (const username in users) {
Â  Â  Â  Â  if (username.toLowerCase().includes(query) && username !== currentUser) {
Â  Â  Â  Â  Â  Â  matches.push(username);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (matches.length > 0) {
Â  Â  Â  Â  matches.forEach(username => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'search-result-item';
Â  Â  Â  Â  Â  Â  item.innerText = username;
Â  Â  Â  Â  Â  Â  item.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  showTab('view-profile', username);
Â  Â  Â  Â  Â  Â  Â  Â  input.value = ''; // Clear input on selection
Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  resultsDiv.appendChild(item);
Â  Â  Â  Â  });
Â  Â  Â  Â  resultsDiv.style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  resultsDiv.style.display = 'none';
Â  Â  }
}

// Global click listener to hide search results when clicking outside
document.addEventListener('click', function(event) {
Â  Â  const searchBar = document.getElementById('search-bar');
Â  Â  const resultsDiv = document.getElementById('search-results');
Â  Â  if (searchBar && resultsDiv && !searchBar.contains(event.target)) {
Â  Â  Â  Â  resultsDiv.style.display = 'none';
Â  Â  }
});

// ------------------ Direct Messages (DM) ------------------

function renderMessageList() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const messages = getAllMessages();
Â  Â  const users = getAllUsers();
Â  Â  const messageListContainer = document.getElementById('messages-list');
Â  Â  const conversationContainer = document.getElementById('conversation-container');
Â  Â Â 
Â  Â  currentChatPartner = null; // Reset chat state
Â  Â  conversationContainer.style.display = 'none';
Â  Â  messageListContainer.innerHTML = '';
Â  Â Â 
Â  Â  // Get all unique chat partners
Â  Â  const chatPartners = new Set();
Â  Â  for (const chatID in messages) {
Â  Â  Â  Â  if (chatID.includes(currentUser)) {
Â  Â  Â  Â  Â  Â  chatPartners.add(chatID.split('_').find(u => u !== currentUser));
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const sortedPartners = Array.from(chatPartners).sort(); // Sort alphabetically

Â  Â  if (sortedPartners.length === 0) {
Â  Â  Â  Â  messageListContainer.innerHTML = '<p style="color:#777;">No active conversations. Search for a user and click "Message" to start one!</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  sortedPartners.forEach(partner => {
Â  Â  Â  Â  const chatID = getChatID(currentUser, partner);
Â  Â  Â  Â  const chat = messages[chatID];
Â  Â  Â  Â  const lastMessage = chat[chat.length - 1];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const lastReadTimestamp = users[currentUser].lastRead?.[partner] || 0;
Â  Â  Â  Â  const isUnread = lastMessage && lastMessage.sender !== currentUser && lastMessage.date > lastReadTimestamp;

Â  Â  Â  Â  const summaryEl = document.createElement('div');
Â  Â  Â  Â  summaryEl.className = 'chat-summary';
Â  Â  Â  Â  summaryEl.onclick = () => viewConversation(partner);
Â  Â  Â  Â Â 
Â  Â  Â  Â  summaryEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color: ${isUnread ? '#00FF00' : '#00CC00'};">${partner} ${isUnread ? '<span style="color:red; margin-left:10px;">â€¢ New</span>' : ''}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8em; color:#777;">${lastMessage ? formatTimestamp(lastMessage.date) : ''}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p style="margin:5px 0 0 0; font-size:0.9em; color:#999; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
Â  Â  Â  Â  Â  Â  Â  Â  ${lastMessage ? `${lastMessage.sender === currentUser ? 'You' : lastMessage.sender}: ${lastMessage.text}` : 'Start the conversation!'}
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  messageListContainer.appendChild(summaryEl);
Â  Â  });
}

function startDM(partnerUsername) {
Â  Â  // Ensure the partner exists
Â  Â  if (!getAllUsers()[partnerUsername]) {
Â  Â  Â  Â  alert('User does not exist.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  // Switch to the messages tab and view the conversation
Â  Â  showTab('messages');
Â  Â  viewConversation(partnerUsername);
}


function viewConversation(partnerUsername) {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const messages = getAllMessages();
Â  Â  const users = getAllUsers();
Â  Â  const chatID = getChatID(currentUser, partnerUsername);
Â  Â  const chat = messages[chatID] || [];

Â  Â  const messageListView = document.getElementById('message-view');
Â  Â  const conversationContainer = document.getElementById('conversation-container');
Â  Â  const chatMessagesDiv = document.getElementById('chat-messages');

Â  Â  currentChatPartner = partnerUsername; // Set global state for send function

Â  Â  messageListView.style.display = 'none';
Â  Â  conversationContainer.style.display = 'block';
Â  Â  document.getElementById('chat-header').innerText = `Chat with ${partnerUsername}`;
Â  Â  chatMessagesDiv.innerHTML = '';
Â  Â Â 
Â  Â  chat.forEach(msg => {
Â  Â  Â  Â  const msgEl = document.createElement('div');
Â  Â  Â  Â  msgEl.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
Â  Â  Â  Â  msgEl.innerHTML = `
Â  Â  Â  Â  Â  Â  ${msg.text}
Â  Â  Â  Â  Â  Â  <span class="message-time">${formatTimestamp(msg.date)}</span>
Â  Â  Â  Â  `;
Â  Â  Â  Â  chatMessagesDiv.appendChild(msgEl);
Â  Â  });

Â  Â  // Scroll to bottom
Â  Â  chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
Â  Â Â 
Â  Â  // Mark messages as read for this user
Â  Â  if (chat.length > 0) {
Â  Â  Â  Â  const lastMessageDate = chat[chat.length - 1].date;
Â  Â  Â  Â  users[currentUser].lastRead = users[currentUser].lastRead || {};
Â  Â  Â  Â  users[currentUser].lastRead[partnerUsername] = lastMessageDate;
Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  updateNotificationBadges(); // Refresh badges after marking as read
Â  Â  }
}


function sendMessage() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const messageInput = document.getElementById('message-input');
Â  Â  const messageText = messageInput.value.trim();

Â  Â  if (!messageText || !currentChatPartner) return;
Â  Â Â 
Â  Â  const messages = getAllMessages();
Â  Â  const chatID = getChatID(currentUser, currentChatPartner);

Â  Â  // Initialize chat if it doesn't exist
Â  Â  if (!messages[chatID]) {
Â  Â  Â  Â  messages[chatID] = [];
Â  Â  }

Â  Â  // Add new message
Â  Â  messages[chatID].push({
Â  Â  Â  Â  sender: currentUser,
Â  Â  Â  Â  text: messageText,
Â  Â  Â  Â  date: Date.now()
Â  Â  });
Â  Â Â 
Â  Â  localStorage.setItem('messages', JSON.stringify(messages));
Â  Â  messageInput.value = ''; // Clear input

Â  Â  // Re-render the conversation to show the new message
Â  Â  viewConversation(currentChatPartner);
Â  Â Â 
Â  Â  // Add notification to the receiver
Â  Â  addNotification(currentChatPartner, `${currentUser} sent you a new message: "${messageText.substring(0, 30)}..."`, 'messages');
}

// ------------------ Notifications ------------------

function addNotification(targetUser, message, linkTo = 'notifications') {
Â  Â  const users = getAllUsers();
Â  Â  if (users[targetUser]) {
Â  Â  Â  Â  users[targetUser].notifications.unshift({
Â  Â  Â  Â  Â  Â  message,
Â  Â  Â  Â  Â  Â  date: Date.now(),
Â  Â  Â  Â  Â  Â  read: false,
Â  Â  Â  Â  Â  Â  link: linkToÂ 
Â  Â  Â  Â  });
Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  updateNotificationBadges();
Â  Â  }
}

function renderNotifications() {
Â  Â  const currentUser = localStorage.getItem('currentUser');
Â  Â  const users = getAllUsers();
Â  Â  const notifications = users[currentUser].notifications;
Â  Â  const container = document.getElementById('notifications-display');
Â  Â  container.innerHTML = '';
Â  Â Â 
Â  Â  if (notifications.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<p style="color:#777;">You have no new notifications.</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  notifications.forEach((n, index) => {
Â  Â  Â  Â  const itemEl = document.createElement('div');
Â  Â  Â  Â  itemEl.className = 'notification-item';
Â  Â  Â  Â  itemEl.style.background = n.read ? 'transparent' : '#001a00';Â 
Â  Â  Â  Â  itemEl.style.cursor = 'pointer';

Â  Â  Â  Â  itemEl.onclick = () => {
Â  Â  Â  Â  Â  Â  // Mark as read and link to the relevant tab
Â  Â  Â  Â  Â  Â  users[currentUser].notifications[index].read = true;
Â  Â  Â  Â  Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  Â  Â  Â  Â  updateNotificationBadges();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (n.link === 'messages') {
Â  Â  Â  Â  Â  Â  Â  Â  showTab('messages');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Simple notification, just re-render to update the 'read' state
Â  Â  Â  Â  Â  Â  Â  Â  renderNotifications();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  itemEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <span style="font-weight: ${n.read ? 'normal' : 'bold'}; color: ${n.read ? '#AAAAAA' : '#00FF00'};">${n.message}</span>
Â  Â  Â  Â  Â  Â  <span style="display:block; font-size:0.8em; color:#555; margin-top:5px;">${formatTimestamp(n.date)}</span>
Â  Â  Â  Â  `;
Â  Â  Â  Â  container.appendChild(itemEl);
Â  Â  });
}


// ------------------ Settings ------------------
function changeUsername() {
Â  Â  const oldUsername = localStorage.getItem('currentUser');
Â  Â  const newUsername = document.getElementById('change-username').value.trim();
Â  Â Â 
Â  Â  if (!newUsername) { alert("Please enter a new username."); return; }
Â  Â  if (newUsername === oldUsername) { alert("Username is the same."); return; }
Â  Â Â 
Â  Â  const users = getAllUsers();
Â  Â  if (users[newUsername]) { alert("This username is already taken."); return; }

Â  Â  // 1. Transfer user data
Â  Â  const userData = users[oldUsername];
Â  Â  users[newUsername] = userData;
Â  Â  delete users[oldUsername];

Â  Â  // 2. Update references in posts (reactions, comments)
Â  Â  for (const userKey in users) {
Â  Â  Â  Â  users[userKey].posts.forEach(post => {
Â  Â  Â  Â  Â  Â  // Reactions
Â  Â  Â  Â  Â  Â  REACTIONS.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  const index = post.reactions[r].indexOf(oldUsername);
Â  Â  Â  Â  Â  Â  Â  Â  if (index !== -1) { post.reactions[r][index] = newUsername; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // Comments
Â  Â  Â  Â  Â  Â  post.comments.forEach(comment => {
Â  Â  Â  Â  Â  Â  Â  Â  if (comment.user === oldUsername) { comment.user = newUsername; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  // Followers/Following
Â  Â  Â  Â  let followIndex = users[userKey].following.indexOf(oldUsername);
Â  Â  Â  Â  if (followIndex !== -1) { users[userKey].following[followIndex] = newUsername; }
Â  Â  Â  Â  followIndex = users[userKey].followers.indexOf(oldUsername);
Â  Â  Â  Â  if (followIndex !== -1) { users[userKey].followers[followIndex] = newUsername; }
Â  Â  Â  Â  // Notifications
Â  Â  Â  Â  users[userKey].notifications.forEach(n => {
Â  Â  Â  Â  Â  Â  // Simple text replacement for notification messages
Â  Â  Â  Â  Â  Â  n.message = n.message.replace(oldUsername, newUsername);
Â  Â  Â  Â  });
Â  Â  Â  Â  // Last Read (DM Status)
Â  Â  Â  Â  if (users[userKey].lastRead && users[userKey].lastRead[oldUsername]) {
Â  Â  Â  Â  Â  Â  users[userKey].lastRead[newUsername] = users[userKey].lastRead[oldUsername];
Â  Â  Â  Â  Â  Â  delete users[userKey].lastRead[oldUsername];
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 3. Update messages (sender and chat IDs)
Â  Â  const messages = getAllMessages();
Â  Â  const newMessages = {};
Â  Â  for (const chatID in messages) {
Â  Â  Â  Â  const participants = chatID.split('_');
Â  Â  Â  Â  const isParticipant = participants.includes(oldUsername);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isParticipant) {
Â  Â  Â  Â  Â  Â  // Update sender in messages
Â  Â  Â  Â  Â  Â  messages[chatID].forEach(msg => {
Â  Â  Â  Â  Â  Â  Â  Â  if (msg.sender === oldUsername) { msg.sender = newUsername; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // Create new chat ID
Â  Â  Â  Â  Â  Â  const otherUser = participants.find(u => u !== oldUsername) || newUsername;
Â  Â  Â  Â  Â  Â  const newChatID = getChatID(newUsername, otherUser);
Â  Â  Â  Â  Â  Â  newMessages[newChatID] = messages[chatID];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  newMessages[chatID] = messages[chatID];
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 4. Save and reload
Â  Â  localStorage.setItem('users', JSON.stringify(users));
Â  Â  localStorage.setItem('messages', JSON.stringify(newMessages));
Â  Â  localStorage.setItem('currentUser', newUsername);
Â  Â Â 
Â  Â  alert(`Username changed from ${oldUsername} to ${newUsername}. The app will now reload.`);
Â  Â  location.reload();
}


// ------------------ Main Execution ------------------
document.addEventListener('DOMContentLoaded', () => {
Â  Â  // Ensure default data is present (or merged) on load
Â  Â  initializeOrMergeData(); 
Â  Â Â 
Â  Â  if (localStorage.getItem('currentUser')) {
Â  Â  Â  Â  initApp();
Â  Â  } else {
Â  Â  Â  Â  showLogin();
Â  Â  }
});
</script>
</body>
</html>
