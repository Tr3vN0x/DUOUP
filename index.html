<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DuoUp - Social Gaming</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/3UQx9gR.png">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    --duoup-primary: #00FFFF;
    --duoup-secondary: #FF5733;
    --duoup-accent: #8A2BE2;
    --duoup-dark: #050510;
    --duoup-light: #F0F8FF;
    --duoup-muted: #80809C;
    --font-main: 'Rajdhani', sans-serif;
    --font-header: 'Orbitron', sans-serif;
    --status-online: #38A169;
    --status-offline: #E53E3E;
}
html, body { margin: 0; height: 100%; background-color: var(--duoup-dark); background-image: radial-gradient(circle at top center, rgba(255,87,51,0.08) 0%, rgba(5,5,16,0.8) 40%, var(--duoup-dark) 100%); font-family: var(--font-main); color: var(--duoup-light); }
h1,h2,h3 { font-family: var(--font-header); margin:0; color: var(--duoup-light); }
h2 { display:flex; align-items:baseline; border-bottom:2px solid var(--duoup-secondary); padding-bottom:5px; margin-bottom:20px; font-size:1.8em; background: linear-gradient(90deg, var(--duoup-primary), var(--duoup-accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
#userCount { color: var(--duoup-secondary); font-size:0.55em; font-weight:600; text-shadow:0 0 5px var(--duoup-secondary); margin-left:10px; letter-spacing:1px; -webkit-background-clip: unset; -webkit-text-fill-color: unset; }
a { color: var(--duoup-primary); text-decoration:none; transition:0.2s; }
a:hover { text-shadow:0 0 8px var(--duoup-primary); }
button { cursor:pointer; border:none; border-radius:5px; transition: background 0.2s, transform 0.1s, box-shadow 0.3s; }
header { position:fixed; top:0; width:100%; height:60px; background:rgba(20,20,38,0.98); display:flex; align-items:center; justify-content:space-between; padding:0 15px; z-index:1000; border-bottom:3px solid var(--duoup-secondary); }
header .logo { display:flex; align-items:center; gap:10px; }
header h1 { font-size:2em; font-weight:700; color: var(--duoup-primary); text-shadow:0 0 10px var(--duoup-primary); }
header h1 span { color: var(--duoup-secondary); text-shadow:0 0 5px var(--duoup-secondary),0 0 15px rgba(255,87,51,0.8); }
header nav { display:flex; align-items:center; gap:15px; flex-wrap:wrap; }
#logoutBtnHeader { background: var(--duoup-secondary); color: var(--duoup-dark); padding:6px 12px; font-weight:bold; display:flex; align-items:center; gap:5px; box-shadow:0 0 10px rgba(255,87,51,0.5); }
#notificationBadge { color: var(--duoup-secondary); font-weight:bold; }
#auth-section { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding-top:60px; }
form:not(#duoSearchForm) { display:flex; flex-direction:column; background:#141426; padding:25px; border-radius:12px; margin:10px; width:90%; max-width:360px; box-shadow:0 0 20px rgba(0,255,255,0.15); }
#profileEditForm { background:none; box-shadow:none; padding:0; max-width:500px; width:100%; margin:0; }
input:not(#searchQuery), textarea { margin:8px 0; padding:12px; border-radius:6px; border:1px solid var(--duoup-primary); background:#2D2D44; color:var(--duoup-light); font-family: var(--font-main); }
textarea { resize:none; min-height:80px; }
button:not(.google-btn):not(#duoSearchForm button) { margin-top:10px; padding:12px; font-weight:bold; background:linear-gradient(90deg, var(--duoup-primary), var(--duoup-accent)); color: var(--duoup-dark); text-transform:uppercase; box-shadow:0 0 15px rgba(0,255,255,0.5); }
button:not(.google-btn):not(#duoSearchForm button):hover { background:linear-gradient(90deg, var(--duoup-accent), var(--duoup-secondary)); transform:translateY(-2px); box-shadow:0 0 20px rgba(255,87,51,0.8); }
#duoSearchForm button { background:linear-gradient(90deg, var(--duoup-primary), var(--duoup-accent)); color: var(--duoup-dark); font-weight:bold; box-shadow:0 0 10px rgba(0,255,255,0.3); }
.google-btn { background: linear-gradient(90deg, #DB4437, #EA4335); color:white; width:90%; max-width:360px; display:flex; align-items:center; justify-content:center; gap:10px; margin-top:15px; }
.google-btn:hover { background: linear-gradient(90deg, #EA4335, #DB4437); transform:translateY(-2px); }
#app-section { width:100%; padding-top:60px; }
.container { max-width:1200px; margin:20px auto; padding:0 15px; width:100%; }
.results-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:20px; width:100%; }
.duo-card { background:linear-gradient(145deg,#1A1A2E,#2D2D44); color: var(--duoup-light); border-radius:12px; overflow:hidden; border:1px solid #3A3A52; transition:.3s; box-shadow:0 4px 8px rgba(0,0,0,0.4); }
.duo-card:hover { transform:translateY(-5px); box-shadow:0 0 10px var(--duoup-primary),0 0 20px var(--duoup-secondary),0 0 30px var(--duoup-accent); border-color: var(--duoup-accent); }
.card-header { display:flex; align-items:center; padding:10px 15px; border-bottom:1px solid #3A3A52; }
.avatar { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:15px; background: var(--duoup-secondary); color: var(--duoup-dark); font-family: var(--font-header); font-size:1.5em; border:2px solid var(--duoup-primary); overflow:hidden; box-shadow:0 0 10px var(--duoup-primary); }
.avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
.bio { padding:10px 15px; font-size:0.9em; color: var(--duoup-muted); }
.action-button { width:100%; padding:12px; background:linear-gradient(90deg, var(--duoup-primary), var(--duoup-accent)); color: var(--duoup-dark); font-weight:bold; border-radius:0 0 12px 12px; text-transform:uppercase; }
.duo-request-card { border-top:5px solid var(--duoup-secondary); }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:2000; }

/* MODAL STYLES (for both chat and request) */
.chat-container, #requestModalContent {
    background: #141426;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.chat-container { width:90%; max-width:420px; height:80%; display:flex; flex-direction:column; }
.chat-header { padding:10px 15px; background:#1A1A2E; display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--duoup-primary); color: var(--duoup-light);}
.status-dot { width:8px; height:8px; border-radius:50%; margin-right:8px; display:inline-block;}
.status-dot.online { background: var(--status-online); }
.status-dot.offline { background: var(--status-offline); }
.message-area { flex:1; padding:10px; overflow-y:auto; }
.message { max-width:80%; margin-bottom:10px; }
.message.self { margin-left:auto; }
.message-content { padding:8px 12px; border-radius:12px; }
.message.other .message-content { background:linear-gradient(135deg, #2D2D44, #3A3A52); color:white; }
.message.self .message-content { background:linear-gradient(135deg, var(--duoup-primary), var(--duoup-accent)); color: var(--duoup-dark); }

/* CHAT INPUT */
.chat-input-area { display:flex; padding:10px; gap:5px; }
.chat-input { flex:1; padding:10px; border-radius:6px; border:none; background:#2D2D44; color:white; }
.send-button { padding:10px 15px; border:none; background:linear-gradient(90deg, var(--duoup-primary), var(--duoup-accent)); color: var(--duoup-dark); font-weight:bold; border-radius:6px; }

/* DUO REQUEST MODAL STYLES */
#requestModalContent { width: 90%; max-width: 400px; padding: 20px; display: flex; flex-direction: column; }
#requestModalContent h3 { color: var(--duoup-secondary); border-bottom: 2px solid var(--duoup-primary); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.5em; }
#requestModalContent button { margin-top: 15px; }
#requestMessage { min-height: 100px; max-height: 150px; background: #1A1A2E; }

@media(max-width:500px){ header h1 { font-size:1.6em; } .results-grid { grid-template-columns:1fr; } }
</style>
</head>
<body>

<header style="display:none;" id="mainHeader">
    <div class="logo">
        <img src="https://i.imgur.com/3UQx9gR.png" alt="DuoUp" width="40" style="border-radius:8px;"/>
        <h1>DUO<span>UP</span></h1>
    </div>
    <nav>
        <a href="#" onclick="showSection('home')">Duo Search</a>
        <a href="#" onclick="showSection('profile')">Profile</a>
        <a href="#" onclick="showSection('messages')">Messages <span id="notificationBadge"></span></a>
        <button id="logoutBtnHeader"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </nav>
</header>

<div id="auth-section">
    <h2>Welcome to DuoUp</h2>
    <form id="signin">
        <h3>Sign In</h3>
        <input id="signin-email" type="email" placeholder="Email" required>
        <input id="signin-password" type="password" placeholder="Password" required>
        <button type="submit">Sign In</button>
    </form>

    <form id="signup">
        <h3>New Player? Sign Up</h3>
        <input id="signup-email" type="email" placeholder="Email" required>
        <input id="signup-password" type="password" placeholder="Password" required>
        <button type="submit">Create Account</button>
    </form>

    <button class="google-btn">
        <i class="fab fa-google"></i> Continue with Google
    </button>
</div>

<div id="app-section" style="display:none; width:100%; padding-top:60px;">
    <div id="home-section" class="container">
        <h2 id="homeSectionHeader">Duo Search <span id="userCount"></span></h2> 
        <form id="duoSearchForm" style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="searchQuery" placeholder="Search by Username, Game, or Platform" style="flex-grow:1; padding:12px; border:1px solid var(--duoup-primary); border-radius:6px; background:#2D2D44; color:var(--duoup-light); font-family: var(--font-main);">
            <button type="submit" style="padding:12px 20px;"><i class="fas fa-search"></i> Find Duo</button>
        </form>
        <div class="results-grid" id="usersGrid"></div>
    </div>

    <div id="profile-section" class="container" style="display:none;">
        <h2 style="margin-bottom:25px;">Profile Management</h2>
        <div style="display:flex; gap:30px; flex-wrap:wrap;">
            <form id="profileEditForm">
                <h3>Edit Details</h3>
                <input class="profile-field" id="profile-username" placeholder="Username">
                <input class="profile-field" id="profile-platform" placeholder="Platform">
                <input class="profile-field" id="profile-games" placeholder="Games">
                <input class="profile-field" id="profile-playstyle" placeholder="Playstyle">
                <textarea class="profile-field" id="profile-about" placeholder="About Me"></textarea>
                <label style="margin-top:10px; color: var(--duoup-muted);">Upload/Update Profile Photo:</label>
                <input type="file" id="profile-photo" style="margin-top:5px;">
                <button type="button" onclick="updateProfile()">Save Profile</button>
            </form>
            <div style="flex-grow:1; min-width:300px; max-width:320px;">
                <h3>Your Current Duo Card Preview</h3>
                <div id="profilePreviewContainer"></div>
            </div>
        </div>
    </div>

    <div id="messages-section" class="container" style="display:none;">
        <h2>Messages & Duo Requests</h2>
        <div id="messages-container" class="messages-container">
            <h3>Pending Requests</h3>
            <div class="results-grid" id="requestsGrid"></div>
            <h3>Your Accepted Duos (Click to Chat)</h3>
            <div class="results-grid" id="duosGrid"></div>
        </div>
    </div>
</div>

<div id="chatModal" class="modal">
    <div class="chat-container">
        <div id="chatHeader" class="chat-header"></div>
        <div id="messageArea" class="message-area"></div>
        <div class="chat-input-area">
            <input id="chatInput" class="chat-input" placeholder="Type message">
            <button class="send-button" onclick="sendMessage()">Send</button>
            <span onclick="closeChat()" style="cursor:pointer; padding:10px; color: var(--duoup-light);"><i class="fas fa-times"></i></span>
        </div>
    </div>
</div>

<div id="requestModal" class="modal">
    <div id="requestModalContent">
        <h3>Send Duo Request to <span id="requestRecipientName"></span></h3>
        <textarea id="requestMessage" placeholder="Type your personal message here. This will be sent as a first message to break the ice!" maxlength="500"></textarea>
        <button id="sendRequestBtn" onclick="sendDuoRequestWithModal()">
            <i class="fas fa-paper-plane"></i> Send Request & Message
        </button>
        <button onclick="closeRequestModal()" style="background: #3A3A52; color: var(--duoup-light); margin-top: 10px;">
            Cancel
        </button>
    </div>
</div>

<script type="module">
// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1Ee1Q",
  authDomain: "duoup-1111.firebaseapp.com",
  projectId: "duoup-1111",
  storageBucket: "duoup-1111.appspot.com",
  messagingSenderId: "571801881791",
  appId: "1:571801881791:web:b01ee56f83b7c5f247fe7c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

// ---------------- AUTH ----------------
document.getElementById("signin").addEventListener("submit", async e=>{
    e.preventDefault();
    const email = document.getElementById("signin-email").value;
    const pass = document.getElementById("signin-password").value;
    try { await signInWithEmailAndPassword(auth,email,pass); } 
    catch(err){ alert(err.message); }
});
document.getElementById("signup").addEventListener("submit", async e=>{
    e.preventDefault();
    const email = document.getElementById("signup-email").value;
    const pass = document.getElementById("signup-password").value;
    try { await createUserWithEmailAndPassword(auth,email,pass); } 
    catch(err){ alert(err.message); }
});
document.querySelector(".google-btn").addEventListener("click", async ()=>{
    try { await signInWithPopup(auth,provider); } 
    catch(err){ alert(err.message); }
});
document.getElementById("logoutBtnHeader").addEventListener("click", ()=>signOut(auth));

// ---------------- UI ----------------
function showSection(section){ 
    document.getElementById("home-section").style.display=section==="home"?"block":"none";
    document.getElementById("profile-section").style.display=section==="profile"?"block":"none";
    document.getElementById("messages-section").style.display=section==="messages"?"block":"none";
}

// ---------------- AUTH STATE ----------------
let currentUser=null;
onAuthStateChanged(auth, user=>{
    if(user){
        currentUser=user;
        document.getElementById("auth-section").style.display="none";
        document.getElementById("mainHeader").style.display="flex";
        document.getElementById("app-section").style.display="block";
        loadUsers();
        loadProfile();
        loadMessages();
    } else {
        currentUser=null;
        document.getElementById("auth-section").style.display="flex";
        document.getElementById("mainHeader").style.display="none";
        document.getElementById("app-section").style.display="none";
    }
});

// ---------------- LOAD USERS ----------------
const usersGrid=document.getElementById("usersGrid");
async function loadUsers(){
    const q=query(collection(db,"users"));
    onSnapshot(q,snap=>{
        const users=[];
        snap.forEach(doc=>{ if(doc.id!==currentUser.uid) users.push({id:doc.id,...doc.data()}); });
        renderUsersGrid(users);
    });
}
function renderUsersGrid(users){
    document.getElementById("userCount").textContent=`${users.length} Players Found`;
    usersGrid.innerHTML="";
    users.forEach(u=>{
        const card=document.createElement("div"); card.className="duo-card";
        card.innerHTML=`<div class="card-header"><div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:u.username?.[0]}</div><strong>${u.username||"Unknown"}</strong></div>
        <div class="bio">Platform: ${u.platform||'N/A'}<br>Games: ${u.games||'N/A'}<br>Playstyle: ${u.playstyle||'N/A'}</div>
        <button class="action-button" onclick="openRequestModal('${u.id}','${u.username}')"><i class="fas fa-paper-plane"></i> Send Duo Request</button>`;
        usersGrid.appendChild(card);
    });
}

// ---------------- PROFILE ----------------
async function loadProfile(){
    const docRef=doc(db,"users",currentUser.uid);
    const docSnap=await getDoc(docRef);
    if(docSnap.exists()){
        const data=docSnap.data();
        document.getElementById("profile-username").value=data.username||"";
        document.getElementById("profile-platform").value=data.platform||"";
        document.getElementById("profile-games").value=data.games||"";
        document.getElementById("profile-playstyle").value=data.playstyle||"";
        document.getElementById("profile-about").value=data.about||"";
        renderProfilePreview(data);
    }
}
function renderProfilePreview(data){
    const container=document.getElementById("profilePreviewContainer");
    container.innerHTML=`<div class="duo-card"><div class="card-header"><div class="avatar">${data.photoURL?`<img src="${data.photoURL}">`:data.username?.[0]}</div><strong>${data.username||"Me"}</strong></div>
    <div class="bio">Platform: ${data.platform||'N/A'}<br>Games: ${data.games||'N/A'}<br>Playstyle: ${data.playstyle||'N/A'}</div></div>`;
}
async function updateProfile(){
    const docRef=doc(db,"users",currentUser.uid);
    let photoURL="";
    const photoFile=document.getElementById("profile-photo").files[0];
    if(photoFile){
        const storageRef=ref(storage,`profilePhotos/${currentUser.uid}`);
        await uploadBytes(storageRef,photoFile);
        photoURL=await getDownloadURL(storageRef);
    }
    await setDoc(docRef,{
        username: document.getElementById("profile-username").value,
        platform: document.getElementById("profile-platform").value,
        games: document.getElementById("profile-games").value,
        playstyle: document.getElementById("profile-playstyle").value,
        about: document.getElementById("profile-about").value,
        photoURL: photoURL||undefined
    },{merge:true});
    alert("Profile Updated!");
    loadProfile();
}

// ---------------- DUO REQUEST MODAL ----------------
let currentRecipientId=null;
function openRequestModal(userId,username){
    currentRecipientId=userId;
    document.getElementById("requestRecipientName").textContent=username;
    document.getElementById("requestModal").style.display="flex";
}
function closeRequestModal(){
    document.getElementById("requestModal").style.display="none";
    document.getElementById("requestMessage").value="";
}
async function sendDuoRequestWithModal(){
    const msg=document.getElementById("requestMessage").value.trim();
    if(!msg){ alert("Please write a message!"); return; }
    await addDoc(collection(db,"messages"),{
        fromUid: currentUser.uid,
        toUid: currentRecipientId,
        message: msg,
        timestamp: serverTimestamp(),
        status: "pending"
    });
    closeRequestModal();
    alert("Duo Request Sent!");
}

// ---------------- MESSAGES ----------------
const requestsGrid=document.getElementById("requestsGrid");
const duosGrid=document.getElementById("duosGrid");
function loadMessages(){
    const q=query(collection(db,"messages"),where("toUid","==",currentUser.uid));
    onSnapshot(q,snap=>{
        requestsGrid.innerHTML=""; duosGrid.innerHTML="";
        let pendingCount=0;
        snap.forEach(doc=>{
            const msg=doc.data();
            if(msg.status==="pending"){ 
                pendingCount++;
                const card=document.createElement("div"); card.className="duo-card duo-request-card";
                card.innerHTML=`<div class="card-header"><div class="avatar">?</div><strong>${msg.fromUid}</strong></div>
                <div class="bio">${msg.message}</div>`;
                requestsGrid.appendChild(card);
            } else if(msg.status==="accepted"){
                const card=document.createElement("div"); card.className="duo-card action-button";
                card.innerHTML=`<div class="card-header"><div class="avatar">?</div><strong>${msg.fromUid}</strong></div>`;
                card.onclick=()=>openChat(msg.fromUid);
                duosGrid.appendChild(card);
            }
        });
        document.getElementById("notificationBadge").textContent=pendingCount?pendingCount:"";
    });
}

// ---------------- CHAT ----------------
let chatWithUid=null;
function openChat(uid){
    chatWithUid=uid;
    document.getElementById("chatModal").style.display="flex";
    document.getElementById("chatHeader").innerHTML=`Chat with <strong>${uid}</strong> <span class="status-dot online"></span>`;
}
function closeChat(){ document.getElementById("chatModal").style.display="none"; chatWithUid=null; }
async function sendMessage(){
    const msg=document.getElementById("chatInput").value.trim();
    if(!msg || !chatWithUid) return;
    await addDoc(collection(db,"messages"),{
        fromUid: currentUser.uid,
        toUid: chatWithUid,
        message: msg,
        timestamp: serverTimestamp(),
        status: "accepted"
    });
    document.getElementById("chatInput").value="";
}
</script>

</body>
</html>
