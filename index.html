<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP - Friends & Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; margin:auto; padding:20px; }
.hidden { display:none; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.flex { display:flex; gap:15px; flex-wrap:wrap; }
.card { width:260px; padding:15px; border:2px solid cyan; border-radius:14px; background:#111; box-shadow:0 0 10px cyan; }
.avatar { width:48px; height:48px; border-radius:50%; border:2px solid cyan; object-fit:cover; }
.user { display:flex; gap:10px; align-items:center; }
.status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-left:5px; }
.input { width:100%; padding:8px; margin:5px 0; background:#000; border:2px solid cyan; color:white; border-radius:6px; }

/* Chat Styles */
#chatWindow { display:flex; flex-direction:column; max-height:400px; overflow-y:auto; padding:10px; border:2px solid cyan; border-radius:12px; background:#111; }
.message-bubble { padding:10px; border-radius:12px; max-width:70%; margin:5px; word-wrap:break-word; display:flex; gap:10px; align-items:flex-end; }
.message-outgoing { background:#00ffff; color:black; align-self:flex-end; box-shadow:0 0 5px #00ffff; }
.message-incoming { background:#555; color:white; align-self:flex-start; box-shadow:0 0 3px #333; }
.message-header { font-size:0.75em; color:gray; margin-bottom:2px; }
.message-avatar { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.message-content { display:flex; flex-direction:column; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
  <button class="neon-btn" onclick="showTab('requests')">Requests</button>
  <button class="neon-btn" onclick="showTab('friends')">Friends</button>
  <button class="neon-btn" onclick="logout()">Logout</button>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
</div>

<!-- CHAT -->
<div id="chatPage" class="container hidden">
  <h2 id="chatWith"></h2>
  <div id="chatWindow"></div>
  <input id="chatInput" class="input" placeholder="Type a message">
  <button class="neon-btn" onclick="sendMessage()">Send</button>
  <button class="neon-btn" onclick="closeChat()">Back</button>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const suggestedTab = document.getElementById("suggestedTab");
const requestsTab = document.getElementById("requestsTab");
const friendsTab = document.getElementById("friendsTab");

const chatPage = document.getElementById("chatPage");
const chatWindow = document.getElementById("chatWindow");
const chatInput = document.getElementById("chatInput");

let currentChatUser = null;
let currentChatUserData = null;

// ---------------- LOGIN ----------------
function loginWithGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}

// ---------------- AUTH STATE ----------------
auth.onAuthStateChanged(async user => {
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    chatPage.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");

  // create profile if not exists
  const userSnap = await db.collection("users").doc(user.uid).get();
  if(!userSnap.exists){
    await db.collection("users").doc(user.uid).set({
      uid:user.uid,
      nickname:user.displayName||"Player",
      email:user.email,
      friends:[],
      profileImageUrl:user.photoURL||DEFAULT_AVATAR
    });
  }
  welcome.innerText = "Welcome, " + (userSnap.data()?.nickname || user.displayName);

  loadSuggested();
  loadRequests();
  listenFriends();
});

// ---------------- LOGOUT ----------------
function logout(){ auth.signOut(); }

// ---------------- TABS ----------------
function showTab(tab){
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(tab+"Tab").classList.remove("hidden");
}

// ---------------- SUGGESTED ----------------
function loadSuggested(){
  suggestedTab.innerHTML="";
  const currentUserId = auth.currentUser.uid;
  db.collection("users").get().then(snap=>{
    snap.forEach(doc=>{
      if(doc.id===currentUserId) return;
      db.collection("users").doc(currentUserId).get().then(me=>{
        const friends = me.data().friends || [];
        if(friends.includes(doc.id)) return;
        const u = doc.data();
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<div class="user">
          <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
        </div>
        <button class="neon-btn" onclick="sendRequest('${doc.id}')">DUO UP</button>`;
        suggestedTab.appendChild(card);
      });
    });
  });
}

// ---------------- FRIEND REQUESTS ----------------
function loadRequests(){
  requestsTab.innerHTML="";
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(snap=>{
      if(snap.empty){ requestsTab.innerHTML="<p>No requests</p>"; }
      snap.forEach(r=>{
        db.collection("users").doc(r.data().senderId).get().then(u=>{
          const d = u.data();
          const card = document.createElement("div");
          card.className="card";
          card.innerHTML=`<div class="user">
            <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
            <strong>${d.nickname}</strong>
          </div>
          <button class="neon-btn" onclick="acceptRequest('${r.id}','${u.id}')">Accept</button>
          <button class="neon-btn" onclick="rejectRequest('${r.id}')">Reject</button>`;
          requestsTab.appendChild(card);
        });
      });
    });
}

// ---------------- FRIENDS ----------------
function listenFriends(){
  const userRef = db.collection("users").doc(auth.currentUser.uid);
  userRef.onSnapshot(doc=>{
    friendsTab.innerHTML="";
    const friends = doc.data().friends||[];
    if(friends.length===0){ friendsTab.innerHTML="<p>No friends yet</p>"; return; }
    friends.forEach(fid=>{
      db.collection("users").doc(fid).get().then(u=>{
        const d = u.data();
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<div class="user">
          <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${d.nickname}</strong>
        </div>
        <button class="neon-btn" onclick="openChat('${fid}')">Chat</button>`;
        friendsTab.appendChild(card);
      });
    });
  });
}

// ---------------- FRIEND REQUEST ACTIONS ----------------
function sendRequest(receiverId){
  db.collection("friendRequests").add({
    senderId:auth.currentUser.uid,
    receiverId:receiverId,
    status:"pending",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>alert("Friend request sent!"));
}

function acceptRequest(requestId, senderId){
  db.collection("friendRequests").doc(requestId).update({status:"accepted"});
  const batch = db.batch();
  const meRef = db.collection("users").doc(auth.currentUser.uid);
  const senderRef = db.collection("users").doc(senderId);
  batch.update(meRef, {friends:firebase.firestore.FieldValue.arrayUnion(senderId)});
  batch.update(senderRef, {friends:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)});
  batch.commit();
}

function rejectRequest(requestId){
  db.collection("friendRequests").doc(requestId).update({status:"rejected"});
}

// ---------------- CHAT ----------------
function openChat(friendId){
  currentChatUser = friendId;
  dashboard.classList.add("hidden");
  chatPage.classList.remove("hidden");
  db.collection("users").doc(friendId).get().then(doc=>{
    currentChatUserData = doc.data();
    chatWith.innerText = "Chat with "+currentChatUserData.nickname;
    loadMessages();
  });
}

function loadMessages(){
  if(!currentChatUser) return;
  chatWindow.innerHTML="";
  const currentUid = auth.currentUser.uid;
  db.collection("messages")
    .where("participants","array-contains",currentUid)
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      chatWindow.innerHTML="";
      snapshot.forEach(doc=>{
        const m = doc.data();
        if(!m.participants.includes(currentChatUser)) return;
        const isOutgoing = m.senderId===currentUid;
        const bubble = document.createElement("div");
        bubble.className="message-bubble "+(isOutgoing?"message-outgoing":"message-incoming");
        const avatarUrl = isOutgoing?auth.currentUser.photoURL||DEFAULT_AVATAR:currentChatUserData.profileImageUrl||DEFAULT_AVATAR;
        bubble.innerHTML=`<img class="message-avatar" src="${avatarUrl}">
          <div class="message-content">
            <div class="message-header">${isOutgoing?"You":currentChatUserData.nickname} - ${m.timestamp?.toDate().toLocaleTimeString()||""}</div>
            <div>${m.content}</div>
          </div>`;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      });
    });
}

function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !currentChatUser) return;
  const currentUid = auth.currentUser.uid;
  db.collection("messages").add({
    senderId:currentUid,
    receiverId:currentChatUser,
    participants:[currentUid,currentChatUser],
    content:text,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  chatInput.value="";
}

function closeChat(){
  currentChatUser=null;
  currentChatUserData=null;
  chatPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
}
</script>
</body>
</html>
