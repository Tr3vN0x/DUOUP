<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Profiles & Friends</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<style>
/* ... (Existing Styles) ... */

/* New styles for Profile Editor */
.profile-section { margin-bottom: 20px; padding: 15px; border: 1px solid #333; border-radius: 8px; background: #1a1a1a; }
.profile-section h3 { color: cyan; border-bottom: 1px solid magenta; padding-bottom: 5px; }
.profile-section label { color: #aaa; display: block; margin-bottom: 5px; font-size: 0.9em; }
.profile-input, .profile-select, .profile-textarea {
    padding: 8px; border: 1px solid #444; background: #222; color: white; border-radius: 4px; font-family: inherit; outline: none; width: 100%; box-sizing: border-box;
}
.profile-textarea { resize: vertical; }
.avatar-large { width: 100px; height: 100px; border-radius: 50%; border: 3px solid magenta; object-fit: cover; margin-bottom: 10px; }
.profile-field-group { display: flex; gap: 20px; flex-wrap: wrap; }
.profile-field-group > div { flex: 1 1 45%; min-width: 200px; }

</style>
</head>
<body>

<div class="header"><div class="icon-container">âš¡</div><h1>DUO UP</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Find your perfect partner and dominate the cyber-arena.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>
<div style="margin-bottom:20px;">
<button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
<button class="neon-btn" onclick="showTab('requests')">Requests</button>
<button id="friendsBtn" class="neon-btn" onclick="showTab('friends')">Friends <span id="unreadBadge" class="unread-badge hidden">0</span></button>
<button class="neon-btn" onclick="showTab('messaging')">Messaging</button>
<button class="neon-btn" onclick="showTab('profile')">Profile</button>
<button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="suggestedTab" class="card-container"></div>
<div id="requestsTab" class="flex hidden"></div>
<div id="friendsTab" class="flex hidden"></div>

<div id="messagingTab" class="hidden" style="display:flex; height:600px; border:2px solid magenta; background:#111; border-radius:12px;">
<div id="chatList" style="width:30%; padding:10px; border-right:1px solid #333; overflow-y:auto;">
<h3>Active Duos</h3>
<div id="activeDuoList">No friends to chat with.</div>
</div>

<div id="chatWindow" style="width:70%; display:flex; flex-direction:column; padding:10px;">
<h3 id="chatHeader" style="border-bottom:1px solid cyan; padding-bottom:5px;">Select a Duo</h3>
<div id="messageDisplay" style="flex-grow:1; overflow-y:auto; padding:10px; background:#0b0b0b; border-radius:6px; margin-bottom:10px;"></div>
<div id="messageInputArea" class="hidden" style="display:flex; gap:10px;">
<input type="text" id="messageInput" placeholder="Type your message...">
<button class="neon-btn" id="sendMessageBtn">Send</button>
</div>
</div>
</div>

<div id="profileTab" class="hidden">
    <h2>Cyber-Profile Editor</h2>

    <div class="profile-section">
        <h3>Avatar & Identity</h3>
        <div style="text-align: center; margin-bottom: 15px;">
            <img id="profileAvatar" class="avatar-large" src="">
            <input type="file" id="profileImageUpload" style="display: none;" accept="image/*" onchange="document.getElementById('profileImageFile').textContent = this.files[0].name;">
            <button class="neon-btn" onclick="document.getElementById('profileImageUpload').click()">Upload New Image</button>
            <p id="profileImageFile" style="font-size: 0.8em; color: #555; margin-top: 5px;">No file selected.</p>
        </div>

        <div class="profile-field-group">
            <div>
                <label>Nickname (Locked):</label>
                <input type="text" id="profileNickname" class="profile-input" disabled style="background: #000; color: #888;">
            </div>
            <div>
                <label>Bio/Tagline:</label>
                <textarea id="profileBio" rows="2" class="profile-textarea"></textarea>
            </div>
        </div>
    </div>

    <div class="profile-field-group profile-section">
        <div>
            <h3>Skill Metrics</h3>
            <label>Self-Assessed Skill Rating (1-5):</label>
            <select id="profileSkillRating" class="profile-select">
                <option value="1">â­ (Rookie)</option>
                <option value="2">â­â­ (Competent)</option>
                <option value="3">â­â­â­ (Skilled)</option>
                <option value="4">â­â­â­â­ (Elite)</option>
                <option value="5">â­â­â­â­â­ (Legendary)</option>
            </select>
        </div>
        <div>
            <h3>Current Status</h3>
            <label>Status:</label>
            <select id="profileStatus" class="profile-select">
                <option value="Online">Online</option>
                <option value="In Game">In Game</option>
                <option value="LFD">Looking For Duo (LFD)</option>
            </select>
        </div>
    </div>

    <div class="profile-section">
        <h3>Duo Preferences</h3>
        <label>Primary Games/Platforms (Comma-separated, e.g., Apex, PC, COD, PS5):</label>
        <input type="text" id="profileGames" class="profile-input" placeholder="e.g. Valorant, PC, Ranked, Destiny 2">
        <label style="margin-top: 10px;">Duo Preference (What are you looking for?):</label>
        <textarea id="profileLFD" rows="2" class="profile-textarea" placeholder="e.g. Serious climb, casual fun, high KD only."></textarea>
    </div>

    <button class="neon-btn" style="border-color: #00ff00; box-shadow: 0 0 10px #00ff00;" onclick="saveProfile()">Save Profile Changes</button>
    <p id="saveMessage" style="color: #00ff00; margin-top: 10px;"></p>
</div>
</div>

<script>
// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
Â  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
Â  authDomain: "duoup-cfae6.firebaseapp.com",
Â  projectId: "duoup-cfae6",
Â  storageBucket: "duoup-cfae6.appspot.com",
Â  messagingSenderId: "812263060524",
Â  appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
Â  measurementId: "G-46B67F90FK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// ğŸ’¡ ADDED STORAGE REFERENCE
const storage = firebase.storage();


// ---------- CONSTANTS & UTILS ----------
const OWNER_UID = "DecuxiBRxoSwb8wKMmaHQKql9HQ2";
const SPECIAL_UID = "kHsYFJVHCGfQzI16nJH0mg1rv7u1"; // #1 Fish
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
let currentUser=null, currentChatUid=null, unsubscribeMessages=null;
function getChatId(a,b){ return [a,b].sort().join('_'); }

// ---------- AUTH ----------
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message)); }
function logout(){ if(unsubscribeMessages) unsubscribeMessages(); auth.signOut(); }

auth.onAuthStateChanged(async user=>{
Â  Â  if(!user){ loginPage.classList.remove("hidden"); dashboard.classList.add("hidden"); return; }
Â  Â  loginPage.classList.add("hidden"); dashboard.classList.remove("hidden"); currentUser=user;

Â  Â  const userRef = db.collection("users").doc(user.uid);
Â  Â  if(!(await userRef.get()).exists){
        // Initialize new user data, including the new fields
Â  Â  Â  Â  await userRef.set({
            uid:user.uid,
            nickname:user.displayName||"Player",
            bio:"",
            friends:[],
            profileImageUrl:user.photoURL||DEFAULT_AVATAR,
            skillRating:3,
            status:"Online",
            games:"", // New field
            lfd: "" // New field
        });
Â  Â  }
Â  Â  const data = (await userRef.get()).data();
Â  Â  document.getElementById("welcome").innerHTML = `Welcome, ${data.nickname}${user.uid===OWNER_UID?'<span class="owner-badge-box">OWNER</span>':''}`;
Â  Â  loadSuggested(); loadRequests(); loadFriends();
});

// ---------- BADGES & CARD RENDERING ----------
function getSpecialBadge(uid){
Â  Â  if(uid === OWNER_UID) return '<span class="owner-badge-box">OWNER</span>';
Â  Â  if(uid === SPECIAL_UID) return '<span class="owner-badge-box" style="background:#00ff00; color:#0b0b0b; border:2px solid #00ff00; box-shadow:0 0 10px #00ff00;">#1 Fish</span>';
Â  Â  return '';
}

function renderCard(d,type,reqId=null){
Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'card';
Â  Â  if(d.uid === SPECIAL_UID) card.classList.add('card-special'); // glowing border

Â  Â  card.innerHTML = `<div class="card-content">
Â  Â  Â  Â  <img src="${d.profileImageUrl||DEFAULT_AVATAR}" class="avatar">
Â  Â  Â  Â  <h3>${d.nickname}${getSpecialBadge(d.uid)}</h3>
Â  Â  Â  Â  <p style="font-size:0.8em; color:#aaa;">${d.bio||'No bio set.'}</p>
Â  Â  Â  Â  <div class="skill-rating">${'â­'.repeat(d.skillRating||3)}${'â˜†'.repeat(5-(d.skillRating||3))}</div>
Â  Â  Â  Â  <div class="status-indicator status-${(d.status||'Online').toLowerCase().replace(' ','')}">${d.status||'Online'}</div>
Â  Â  </div>`;

Â  Â  let buttons = [];
Â  Â  if(type==='suggest'){ const btn=document.createElement('button'); btn.className='neon-btn'; btn.textContent='Send Request'; btn.onclick=()=>sendFriendRequest(d.uid); buttons.push(btn);}
Â  Â  else if(type==='request'){ const accept=document.createElement('button'); accept.className='neon-btn'; accept.textContent='Accept'; accept.onclick=()=>acceptFriend(reqId,d.uid); const decline=document.createElement('button'); decline.className='neon-btn remove'; decline.textContent='Decline'; decline.onclick=()=>declineFriend(reqId); buttons.push(accept,decline);}
Â  Â  else if(type==='friend'){ const chatBtn=document.createElement('button'); chatBtn.className='neon-btn'; chatBtn.textContent='Chat'; chatBtn.onclick=()=>startChat(d.uid,d.nickname); buttons.push(chatBtn);}
Â  Â  buttons.forEach(b=>card.appendChild(b));
Â  Â  return card;
}

// ---------- SUGGESTED, REQUESTS & FRIENDS (Restored/Updated) ----------
async function loadSuggested(){
Â  Â  const container=document.getElementById('suggestedTab'); container.innerHTML='';
Â  Â  const snapshot=await db.collection('users').get();
Â  Â  const myDoc=(await db.collection('users').doc(currentUser.uid).get()).data();
Â  Â  const myFriends=new Set(myDoc.friends||[]);
Â  Â  const myRequestsSent=new Set((await db.collection('friendRequests').where('senderId','==',currentUser.uid).get()).docs.map(d=>d.data().receiverId));
Â  Â  snapshot.docs.forEach(doc=>{ const d=doc.data(); if(d.uid===currentUser.uid||myFriends.has(d.uid)||myRequestsSent.has(d.uid))return; container.appendChild(renderCard(d,'suggest')); });
Â  Â  if(container.childElementCount===0) container.innerHTML='<p>No new suggested partners found.</p>';
}

async function sendFriendRequest(toUid){
Â  Â  const reqId=getChatId(currentUser.uid,toUid);
Â  Â  const reqRef=db.collection('friendRequests').doc(reqId);
Â  Â  if((await reqRef.get()).exists){ alert("Request already sent!"); return; }
Â  Â  const myDoc=(await db.collection('users').doc(currentUser.uid).get()).data();
Â  Â  if((myDoc.friends||[]).includes(toUid)){ alert("Already friends!"); return; }
Â  Â  await reqRef.set({senderId:currentUser.uid, receiverId:toUid, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
Â  Â  alert("Friend request sent!"); loadSuggested();
}

async function loadRequests(){
    const container=document.getElementById('requestsTab'); container.innerHTML='';
    const snapshot=await db.collection('friendRequests').where('receiverId','==',currentUser.uid).get();
    if(snapshot.empty){ container.innerHTML='<p>No friend requests.</p>'; return; }
    const userDocs=await Promise.all(snapshot.docs.map(doc=>db.collection('users').doc(doc.data().senderId).get()));
    snapshot.docs.forEach((doc,i)=>{ const fromUser=userDocs[i].data(); if(!fromUser)return; container.appendChild(renderCard(fromUser,'request',doc.id)); });
}

async function acceptFriend(reqId,friendUid){ await db.collection('friendRequests').doc(reqId).delete(); await db.collection('users').doc(currentUser.uid).update({friends:firebase.firestore.FieldValue.arrayUnion(friendUid)}); await db.collection('users').doc(friendUid).update({friends:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)}); loadRequests(); loadFriends(); loadSuggested(); }
async function declineFriend(reqId){ await db.collection('friendRequests').doc(reqId).delete(); loadRequests(); loadSuggested(); }


async function loadFriends(){
Â  Â  const container=document.getElementById('friendsTab'); container.innerHTML='';
Â  Â  const userDoc=(await db.collection('users').doc(currentUser.uid).get()).data();
Â  Â  const friendUids=userDoc.friends||[];
Â  Â  if(friendUids.length===0){ container.innerHTML='<p>No friends yet.</p>'; document.getElementById('activeDuoList').innerHTML='No friends to chat with.'; return; }
Â  Â  const friendDocs=await Promise.all(friendUids.map(f=>db.collection('users').doc(f).get()));
Â  Â  const chatList=document.getElementById('activeDuoList'); chatList.innerHTML='';
Â  Â  friendDocs.forEach(fDoc=>{ const f=fDoc.data(); if(!f)return; container.appendChild(renderCard(f,'friend')); const chatBtn=document.createElement('button'); chatBtn.className='neon-btn chat-item-btn'; chatBtn.textContent=f.nickname; chatBtn.onclick=()=>startChat(f.uid,f.nickname); chatList.appendChild(chatBtn); });
}

// ---------- MESSAGING (Restored) ----------
async function startChat(friendUid,nickname){
    showTab('messaging'); if(unsubscribeMessages) unsubscribeMessages();
    currentChatUid=friendUid; const chatId=getChatId(currentUser.uid,friendUid); const chatRef=db.collection('chats').doc(chatId);
    if(!(await chatRef.get()).exists) await chatRef.set({participants:[currentUser.uid,friendUid].sort()});
    const header=document.getElementById('chatHeader'); const display=document.getElementById('messageDisplay'); const inputArea=document.getElementById('messageInputArea'); const msgInput=document.getElementById('messageInput'); const sendBtn=document.getElementById('sendMessageBtn');
    header.textContent=`Chat with ${nickname}`; display.innerHTML='<p style="text-align:center;color:#555;">Connecting...</p>'; inputArea.classList.remove('hidden');
    sendBtn.onclick=()=>sendMessage(chatId,msgInput.value); msgInput.onkeydown=(e)=>{ if(e.key==='Enter')sendMessage(chatId,msgInput.value); };
    unsubscribeMessages=chatRef.collection('messages').orderBy('createdAt','asc').onSnapshot(snap=>{ display.innerHTML=''; if(snap.empty){ display.innerHTML='<p style="text-align:center;color:#555;">No messages yet.</p>'; } snap.forEach(doc=>{ const data=doc.data(); const mine=data.senderId===currentUser.uid; const el=document.createElement('div'); el.className=mine?'message-mine':'message-other'; const bubble=document.createElement('span'); bubble.className='message-bubble'; bubble.textContent=data.content; el.appendChild(bubble); display.appendChild(el); }); display.scrollTop=display.scrollHeight; },err=>{ display.innerHTML='<p style="text-align:center;color:red;">Error loading chat.</p>'; });
}
async function sendMessage(chatId,content){
    content=content.trim(); if(!content)return; const msgInput=document.getElementById('messageInput');
    await db.collection('chats').doc(chatId).collection('messages').add({senderId:currentUser.uid,content:content,createdAt:firebase.firestore.FieldValue.serverTimestamp()}); msgInput.value=''; msgInput.focus();
}

// ---------- ğŸ’¡ PROFILE EDITOR (NEW LOGIC) ----------

// Function to handle image upload to Firebase Storage
async function handleImageUpload(file) {
    const storageRef = storage.ref();
    const fileRef = storageRef.child(`avatars/${currentUser.uid}/${file.name}`);
    const uploadTask = fileRef.put(file);

    return new Promise((resolve, reject) => {
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById('saveMessage').textContent = `Upload is ${Math.round(progress)}% complete...`;
            }, 
            (error) => {
                console.error("Upload failed", error);
                document.getElementById('saveMessage').textContent = 'Image upload failed!';
                reject(null);
            }, 
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
                    document.getElementById('saveMessage').textContent = 'Upload complete.';
                    resolve(downloadURL);
                });
            }
        );
    });
}

async function loadProfile() {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (!userDoc.exists) return;
    const data = userDoc.data();

    // Load static data
    document.getElementById('profileAvatar').src = data.profileImageUrl || DEFAULT_AVATAR;
    document.getElementById('profileNickname').value = data.nickname || '';

    // Load editable data
    document.getElementById('profileBio').value = data.bio || '';
    document.getElementById('profileSkillRating').value = data.skillRating || 3;
    document.getElementById('profileStatus').value = data.status || 'Online';
    document.getElementById('profileGames').value = data.games || ''; // New field
    document.getElementById('profileLFD').value = data.lfd || ''; // New field
    document.getElementById('saveMessage').textContent = '';
    document.getElementById('profileImageFile').textContent = 'No file selected.';

    // Set initial status background color
    document.getElementById('profileStatus').className = `profile-select status-${(data.status||'Online').toLowerCase().replace(' ','')}`;
    document.getElementById('profileStatus').onchange = (e) => {
        e.target.className = `profile-select status-${e.target.value.toLowerCase().replace(' ','')}`;
    };
}

async function saveProfile() {
    const fileInput = document.getElementById('profileImageUpload');
    let imageUrl = null;
    document.getElementById('saveMessage').style.color = '#fff';

    if (fileInput.files.length > 0) {
        imageUrl = await handleImageUpload(fileInput.files[0]);
        if (!imageUrl) {
            document.getElementById('saveMessage').style.color = 'red';
            return;
        }
    }
    
    // Gather data from inputs
    const nickname = document.getElementById('profileNickname').value.trim(); // Still check, even if disabled
    const bio = document.getElementById('profileBio').value.trim();
    const skillRating = parseInt(document.getElementById('profileSkillRating').value);
    const status = document.getElementById('profileStatus').value;
    const games = document.getElementById('profileGames').value.trim(); // New field
    const lfd = document.getElementById('profileLFD').value.trim(); // New field
    const saveMessageEl = document.getElementById('saveMessage');

    if (!nickname) {
        saveMessageEl.textContent = 'Nickname cannot be empty!';
        saveMessageEl.style.color = 'red';
        return;
    }

    try {
        const updateData = {
            nickname: nickname,
            bio: bio,
            skillRating: skillRating,
            status: status,
            games: games, // Save new field
            lfd: lfd // Save new field
        };

        if (imageUrl) {
            updateData.profileImageUrl = imageUrl;
            // Update the displayed avatar immediately
            document.getElementById('profileAvatar').src = imageUrl;
        }

        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // Final success message and cleanup
        saveMessageEl.textContent = 'Profile successfully updated!';
        saveMessageEl.style.color = '#00ff00';
        document.getElementById('profileImageFile').textContent = 'No file selected.';
        fileInput.value = ''; // Clear file input
        
        // Refresh dashboard elements
        document.getElementById("welcome").innerHTML = `Welcome, ${nickname}${currentUser.uid===OWNER_UID?'<span class="owner-badge-box">OWNER</span>':''}`;
        loadFriends();
        loadSuggested();
        
    } catch (error) {
        console.error("Error saving profile:", error);
        saveMessageEl.textContent = 'Error saving profile! Check Firestore/Storage rules.';
        saveMessageEl.style.color = 'red';
    }
}


// ---------- TABS (Restored/Updated) ----------
function hideAllTabs(){ ["suggestedTab","requestsTab","friendsTab","profileTab","messagingTab"].forEach(t=>document.getElementById(t).classList.add('hidden')); }
function showTab(tab){ 
    hideAllTabs(); 
    const el=document.getElementById(tab+'Tab'); 
    if(el) el.classList.remove('hidden'); 
    
    // Special load function calls
    if(tab==='suggested') loadSuggested(); 
    else if(tab==='requests') loadRequests(); // Restored
    else if(tab==='friends') loadFriends(); 
    else if(tab==='profile') loadProfile(); // Call loadProfile
    
    // Cleanup messaging listener
    else if(tab!=='messaging'&&unsubscribeMessages){ 
        unsubscribeMessages(); 
        unsubscribeMessages=null; 
    }
}
</script>
</body>
</html>
