<script>
// ---------- CONFIG ----------
const OWNER_UID = "DecuxiBRxoSwb8wKMmaHQKql9HQ2"; 
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

let currentUser = null;
let currentChatUid = null;
let unsubscribeMessages = null;

const tabs = ["suggested", "requests", "friends", "messaging", "profile"];

// ---------- FIREBASE ----------
const firebaseConfig = { /* your firebase config */ };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------- HELPERS ----------
const getChatId = (a, b) => [a, b].sort().join('_');
const getOwnerBadge = uid => uid === OWNER_UID ? '<span class="owner-badge-box">OWNER</span>' : '';
const renderSkillRating = r => `<div class="skill-rating">${'⭐'.repeat(r)}${'☆'.repeat(5-r)}</div>`;
const renderStatus = s => {
    const c = s === 'Online' ? 'status-online' : s === 'In Game' ? 'status-ingame' : 'status-lfd';
    return `<div class="status-indicator ${c}">${s}</div>`;
};

// ---------- CARD RENDERING ----------
function createCard(user, type, reqId = null) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <div class="card-content">
            <img src="${user.profileImageUrl || DEFAULT_AVATAR}" class="avatar">
            <h3>${user.nickname}${getOwnerBadge(user.uid)}</h3>
            ${renderSkillRating(user.skillRating || 3)}
            ${renderStatus(user.status || 'Online')}
        </div>
    `;
    
    const btnContainer = document.createElement('div');
    if (type === 'suggest') {
        const btn = document.createElement('button');
        btn.className = 'neon-btn';
        btn.textContent = 'Send Request';
        btn.onclick = () => sendFriendRequest(user.uid);
        btnContainer.appendChild(btn);
    } else if (type === 'request') {
        const accept = document.createElement('button');
        accept.className = 'neon-btn';
        accept.textContent = 'Accept';
        accept.onclick = () => acceptFriend(reqId, user.uid);
        const decline = document.createElement('button');
        decline.className = 'neon-btn remove';
        decline.textContent = 'Decline';
        decline.onclick = () => declineFriend(reqId);
        btnContainer.appendChild(accept);
        btnContainer.appendChild(decline);
    } else if (type === 'friend') {
        const chatBtn = document.createElement('button');
        chatBtn.className = 'neon-btn';
        chatBtn.textContent = 'Chat';
        chatBtn.onclick = () => startChat(user.uid, user.nickname);
        btnContainer.appendChild(chatBtn);
    }

    card.appendChild(btnContainer);
    return card;
}

// ---------- AUTH ----------
function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
function logout() { if(unsubscribeMessages) unsubscribeMessages(); auth.signOut(); }

auth.onAuthStateChanged(async user => {
    if (!user) { loginPage.classList.remove('hidden'); dashboard.classList.add('hidden'); return; }
    loginPage.classList.add('hidden'); dashboard.classList.remove('hidden'); 
    currentUser = user;

    const userRef = db.collection('users').doc(user.uid);
    if (!(await userRef.get()).exists) {
        await userRef.set({
            uid: user.uid,
            nickname: user.displayName || "Player",
            bio: "",
            games: [],
            gameDetails: {},
            friends: [],
            profileImageUrl: user.photoURL || DEFAULT_AVATAR,
            skillRating: 3,
            status: "Online"
        });
    }
    document.getElementById("welcome").innerHTML = `Welcome, ${(await userRef.get()).data().nickname}${user.uid===OWNER_UID?getOwnerBadge(user.uid):''}`;

    loadTab('suggested'); // Load initial tab
});

// ---------- TAB MANAGEMENT ----------
function hideAllTabs() { tabs.forEach(t => document.getElementById(t+'Tab').classList.add('hidden')); }

function showTab(tab) {
    hideAllTabs();
    const el = document.getElementById(tab+'Tab');
    if(el) el.classList.remove('hidden');

    if(tab === 'suggested') loadSuggested();
    else if(tab === 'requests') loadRequests();
    else if(tab === 'friends') loadFriends();
    else if(tab === 'profile') loadProfile();
    else if(tab !== 'messaging' && unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages = null; }
}

// ---------- SUGGESTED ----------
async function loadSuggested() {
    const container = document.getElementById('suggestedTab'); container.innerHTML = '';
    const snapshot = await db.collection('users').get();
    const myDoc = (await db.collection('users').doc(currentUser.uid).get()).data();
    const myFriends = new Set(myDoc.friends || []);
    const myRequestsSent = new Set((await db.collection('friendRequests').where('senderId', '==', currentUser.uid).get()).docs.map(d=>d.data().receiverId));

    snapshot.docs.forEach(doc => {
        const user = doc.data();
        if(user.uid===currentUser.uid || myFriends.has(user.uid) || myRequestsSent.has(user.uid)) return;
        container.appendChild(createCard(user, 'suggest'));
    });

    if(container.childElementCount===0) container.innerHTML='<p>No new suggested partners found.</p>';
}

// ---------- FRIEND REQUESTS ----------
async function sendFriendRequest(toUid){
    const reqId = getChatId(currentUser.uid, toUid);
    const reqRef = db.collection('friendRequests').doc(reqId);
    if((await reqRef.get()).exists){ alert("Request already sent!"); return; }
    await reqRef.set({ senderId: currentUser.uid, receiverId: toUid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    alert("Friend request sent!");
    loadSuggested();
}

async function loadRequests() {
    const container = document.getElementById('requestsTab'); container.innerHTML = '';
    const snapshot = await db.collection('friendRequests').where('receiverId','==',currentUser.uid).get();
    if(snapshot.empty){ container.innerHTML='<p>No friend requests.</p>'; return; }
    const userDocs = await Promise.all(snapshot.docs.map(doc => db.collection('users').doc(doc.data().senderId).get()));
    snapshot.docs.forEach((doc,i) => { const user = userDocs[i].data(); if(!user) return; container.appendChild(createCard(user, 'request', doc.id)); });
}

async function acceptFriend(reqId, friendUid){
    await db.collection('friendRequests').doc(reqId).delete();
    await db.collection('users').doc(currentUser.uid).update({friends: firebase.firestore.FieldValue.arrayUnion(friendUid)});
    await db.collection('users').doc(friendUid).update({friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
    loadTab('requests');
    loadTab('friends');
    loadTab('suggested');
}

async function declineFriend(reqId){ await db.collection('friendRequests').doc(reqId).delete(); loadTab('requests'); loadTab('suggested'); }

// ---------- FRIENDS ----------
async function loadFriends(){
    const container = document.getElementById('friendsTab'); container.innerHTML='';
    const userDoc = (await db.collection('users').doc(currentUser.uid).get()).data();
    const friendUids = userDoc.friends || [];
    const chatList = document.getElementById('activeDuoList'); chatList.innerHTML='';

    if(friendUids.length===0){ container.innerHTML='<p>No friends yet.</p>'; chatList.innerHTML='No friends to chat with.'; return; }

    const friendDocs = await Promise.all(friendUids.map(f => db.collection('users').doc(f).get()));
    friendDocs.forEach(fDoc => {
        const f = fDoc.data(); if(!f) return;
        container.appendChild(createCard(f,'friend'));
        const chatBtn = document.createElement('button'); chatBtn.className='neon-btn chat-item-btn';
        chatBtn.textContent = f.nickname; chatBtn.onclick = ()=>startChat(f.uid,f.nickname);
        chatList.appendChild(chatBtn);
    });
}

// ---------- MESSAGING ----------
async function startChat(friendUid,nickname){
    showTab('messaging'); if(unsubscribeMessages) unsubscribeMessages();
    currentChatUid = friendUid; 
    const chatId = getChatId(currentUser.uid, friendUid);
    const chatRef = db.collection('chats').doc(chatId);
    if(!(await chatRef.get()).exists) await chatRef.set({participants:[currentUser.uid,friendUid].sort()});

    const header = document.getElementById('chatHeader');
    const display = document.getElementById('messageDisplay');
    const inputArea = document.getElementById('messageInputArea');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendMessageBtn');

    header.textContent = `Chat with ${nickname}`;
    display.innerHTML = '<p style="text-align:center;color:#555;">Connecting...</p>';
    inputArea.classList.remove('hidden');

    sendBtn.onclick = () => sendMessage(chatId, msgInput.value);
    msgInput.onkeydown = e => { if(e.key==='Enter') sendMessage(chatId,msgInput.value); };

    unsubscribeMessages = chatRef.collection('messages').orderBy('createdAt','asc').onSnapshot(snap=>{
        display.innerHTML = '';
        if(snap.empty) display.innerHTML='<p style="text-align:center;color:#555;">No messages yet.</p>';
        snap.forEach(doc => {
            const data = doc.data();
            const el = document.createElement('div');
            el.className = data.senderId===currentUser.uid ? 'message-mine':'message-other';
            const bubble = document.createElement('span');
            bubble.className='message-bubble';
            bubble.textContent = data.content;
            el.appendChild(bubble); display.appendChild(el);
        });
        display.scrollTop = display.scrollHeight;
    }, err=>{ display.innerHTML='<p style="text-align:center;color:red;">Error loading chat.</p>'; });
}

async function sendMessage(chatId, content){
    content = content.trim(); if(!content) return;
    const msgInput = document.getElementById('messageInput');
    await db.collection('chats').doc(chatId).collection('messages').add({
        senderId: currentUser.uid, content, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgInput.value = ''; msgInput.focus();
}

// ---------- PROFILE ----------
async function loadProfile() {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if(!userDoc.exists) return;
    const data = userDoc.data();
    document.getElementById('profileAvatar').src = data.profileImageUrl || DEFAULT_AVATAR;
    document.getElementById('profileNickname').value = data.nickname || '';
    document.getElementById('profileBio').value = data.bio || '';
    document.getElementById('profileSkillRating').value = data.skillRating || 3;
    document.getElementById('profileStatus').value = data.status || 'Online';
    document.getElementById('saveMessage').textContent='';
}

async function saveProfile() {
    const nickname = document.getElementById('profileNickname').value.trim();
    const bio = document.getElementById('profileBio').value.trim();
    const skillRating = parseInt(document.getElementById('profileSkillRating').value);
    const status = document.getElementById('profileStatus').value;
    const saveMessageEl = document.getElementById('saveMessage');

    if(!nickname){ saveMessageEl.textContent='Nickname cannot be empty!'; saveMessageEl.style.color='red'; return; }

    try{
        await db.collection('users').doc(currentUser.uid).update({nickname, bio, skillRating, status});
        document.getElementById("welcome").innerHTML = `Welcome, ${nickname}${currentUser.uid===OWNER_UID?getOwnerBadge(currentUser.uid):''}`;
        saveMessageEl.textContent='Profile successfully updated!'; saveMessageEl.style.color='#00ff00';
        loadTab('friends'); loadTab('suggested');
    } catch(e){
        console.error(e); saveMessageEl.textContent='Error saving profile!'; saveMessageEl.style.color='red';
    }
}
</script>
