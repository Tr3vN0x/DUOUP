<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Profiles & Friends (Direct Add + Chat)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<style>
/* --- BASE STYLES --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none !important; }
.header { background:#111; border-bottom:3px solid cyan; box-shadow:0 0 20px rgba(0,255,255,0.5); padding:10px 0; margin-bottom:20px; display:flex; align-items:center; justify-content:center; }
.header h1 { font-size:2.5em; color:#fff; text-shadow:0 0 5px cyan,0 0 10px cyan,0 0 15px magenta; margin:0; }
.icon-container { margin-right:15px; font-size:2.5em; color:cyan; text-shadow:0 0 5px cyan,0 0 10px magenta; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; transition:all 0.2s ease-in-out; text-transform:uppercase; font-family:'Orbitron',sans-serif; white-space: nowrap; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.neon-btn:disabled { border-color: #555; box-shadow: none; color: #555; cursor: not-allowed; }
.neon-btn.remove { border-color:red; box-shadow:0 0 10px red; }
.neon-btn.remove:hover { border-color:orange; box-shadow:0 0 15px orange; }
.neon-btn.add { border-color:lime; box-shadow:0 0 10px lime; }
.neon-btn.add:hover { border-color:green; box-shadow:0 0 15px green; }
#messageInput, #profileBio, #profileSkillRating, #profileStatus, #searchInput, #statusFilter, #skillFilter, #profileNickname, #newUsernameInput { flex-grow:1; padding:10px; border:1px solid cyan; background:#181818; color:white; border-radius:6px; font-family:inherit; outline:none; }
#profileBio { resize: vertical; }
.flex { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
.card-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; }
.card {
    width: 100%;
    max-width: 320px; 
    padding: 15px;
    border: 3px solid transparent; 
    border-radius: 6px;
    background: #181818; 
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), inset 0 0 5px rgba(0, 255, 255, 0.2);
    border-image-source: linear-gradient(45deg, cyan, magenta, cyan);
    border-image-slice: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}
/* ... (Other card styles omitted for brevity) ... */
.avatar { width:60px; height:60px; border-radius:50%; border:3px solid magenta; object-fit:cover; margin-bottom:10px; }
.status-online { background-color:#00cc00; color:#0b0b0b; box-shadow:0 0 5px #00ff00; }
.status-ingame { background-color:#ffaa00; color:#0b0b0b; box-shadow:0 0 5px #ffaa00; }
.status-lfd { background-color:#00aaff; color:#0b0b0b; box-shadow:0 0 5px #00aaff; }

/* --- MESSAGING SPECIFIC STYLES --- */
#messagingTab { display: flex; gap: 20px; height: 70vh; }
#chatList { width: 300px; padding: 15px; border: 2px solid cyan; border-radius: 8px; background: #1a1a1a; overflow-y: auto; }
#activeDuoList { margin-top: 10px; }
.chat-entry { padding: 10px; border-bottom: 1px dashed #333; cursor: pointer; transition: background 0.2s; }
.chat-entry:hover { background: #2a2a2a; }
.chat-entry.active { background: #004444; border-left: 5px solid lime; font-weight: bold; }
.last-message-snippet { font-size: 0.8em; color: #bbb; }
#chatWindow { flex-grow: 1; display: flex; flex-direction: column; border: 2px solid magenta; border-radius: 8px; background: #1a1a1a; }
#chatHeader { padding: 10px; border-bottom: 2px solid magenta; margin: 0; background: #330033; }
#messageDisplay { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.message { max-width: 70%; padding: 8px 12px; border-radius: 15px; font-size: 0.9em; }
.message.sent { background: #005555; align-self: flex-end; border-bottom-right-radius: 5px; }
.message.received { background: #333333; align-self: flex-start; border-bottom-left-radius: 5px; }
#messageInputArea { padding: 10px; border-top: 2px solid magenta; background: #0b0b0b; }
</style>
</head>
<body>

<div class="header"><div class="icon-container">⚡</div><h1>DUO UP (Direct)</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Find your perfect partner and dominate the cyber-arena.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>

<div id="navigationBar" style="margin-bottom:20px;">
    <button class="neon-btn" onclick="showTab('allUsers')">Suggested</button>
    <button class="neon-btn" onclick="showTab('search')">Find Players</button>
    <button id="friendsBtn" class="neon-btn" onclick="showTab('friends')">Duos</button>
    <button class="neon-btn" onclick="showTab('messaging')">Messaging</button>
    <button class="neon-btn" onclick="showTab('profile')">Profile</button>
    <button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="allUsersTab" class="card-container"></div>
<div id="searchTab" class="hidden container">
    <h2>Player Search Filter</h2>
    <div id="searchControls" style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
        <input type="text" id="searchInput" placeholder="Search by Nickname or Bio..." onkeyup="filterSearchResults()">
        <label style="color:cyan;">Filter Status:</label>
        <select id="statusFilter" onchange="filterSearchResults()">
            <option value="">Any Status</option>
            <option value="Online">Online</option>
            <option value="In Game">In Game</option>
            <option value="LFD">Looking For Duo (LFD)</option>
        </select>
        <label style="color:cyan;">Min Skill:</label>
        <select id="skillFilter" onchange="filterSearchResults()">
            <option value="0">Any Skill</option>
            <option value="1">⭐ 1+</option>
            <option value="2">⭐⭐ 2+</option>
            <option value="3">⭐⭐⭐ 3+</option>
            <option value="4">⭐⭐⭐⭐ 4+</option>
            <option value="5">⭐⭐⭐⭐⭐ 5</option>
        </select>
    </div>
    <div id="searchResults" class="card-container"></div>
</div>

<div id="friendsTab" class="flex hidden"></div>

<div id="messagingTab" class="hidden">
    <div id="chatList">
        <h3>Active Duos</h3>
        <div id="activeDuoList">No Duos to chat with.</div>
    </div>
    <div id="chatWindow">
        <h3 id="chatHeader">Select a Duo</h3>
        <div id="messageDisplay"></div>
        <div id="messageInputArea" class="hidden">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button class="neon-btn" id="sendMessageBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>
<div id="viewProfileTab" class="hidden container">
    <button class="neon-btn" onclick="showTab('allUsers')">← Back to Suggested</button>
    <div id="viewProfileContent" style="padding: 20px; border: 2px solid magenta; border-radius: 10px; background: #1a1a1a; margin-top: 20px;">
    </div>
</div>

<div id="profileTab" class="hidden">
    </div>

<script>
// ---------- FIREBASE INIT (YOUR CONFIG) ----------
const firebaseConfig = {
  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain: "duoup-cfae6.firebaseapp.com",
  projectId: "duoup-cfae6",
  storageBucket: "duoup-cfae6.firebasestorage.app",
  messagingSenderId: "812263060524",
  appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
  measurementId: "G-46B67F90FK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const OWNER_UID = "DecuxiBRxoSwb8wKMmaHQql9HQ2"; 
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const GAMES_LIST = [
    { name: "Apex Legends", roles: ["Tank", "DPS", "Support", "Any"] },
    // ... (rest of GAMES_LIST)
];

// Global State
let currentUser = null, 
    currentChatUid = null, 
    unsubscribeMessages = null, 
    unsubscribeUnread = null; 
let currentProfileData = {}; 
let allUsersCache = [];    
let friendProfiles = {}; // Stores friend UID -> profile object mapping
let blockedUsers = {}; 


// ---------- AUTH & INITIALIZATION ----------
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message)); }
function logout(){ 
    if(unsubscribeMessages) unsubscribeMessages(); 
    if(unsubscribeUnread) unsubscribeUnread(); 
    auth.signOut(); 
}

auth.onAuthStateChanged(async user=>{
    if(!user){ 
        loginPage.classList.remove("hidden"); 
        dashboard.classList.add("hidden"); 
        return; 
    }
    
    loginPage.classList.add("hidden"); 
    dashboard.classList.remove("hidden"); 
    currentUser=user;
    
    // ... (User Setup Logic Omitted for brevity) ...

    // 2. Load Core Data
    await loadUserProfile(); 
    await loadBlocks(); 

    // 3. Load UI Data
    welcome.textContent=`Welcome, ${currentUser.displayName || currentUser.email}`;
    await loadAllUsers(); 
    await loadFriends();
    showTab('allUsers'); 
});


// ... (loadBlocks, loadUserProfile, saveProfile, showTab, renderUserCard functions Omitted for brevity) ...


// ---------- FRIENDSHIP FUNCTIONS (DIRECT ADD/REMOVE) ----------

async function addFriend(targetUid) {
    if (!currentUser) return;
    
    try {
        await db.collection("users").doc(currentUser.uid).update({
            friends: firebase.firestore.FieldValue.arrayUnion(targetUid)
        });
        
        alert(`Successfully added ${targetUid.substring(0, 8)}... as a Duo. (One-way friendship established.)`);
        
        await loadUserProfile();
        await loadFriends();
        loadAllUsers(); 
        
    } catch (e) {
        console.error("Add Friend Error:", e);
        alert("Add Duo Failed: " + (e.message || "Check Security Rules."));
    }
}

async function removeFriend(friendId) {
    if (!currentUser) return;

    try {
        await db.collection("users").doc(currentUser.uid).update({
            friends: firebase.firestore.FieldValue.arrayRemove(friendId)
        });
        
        alert(`Successfully removed ${friendId.substring(0, 8)}... from Duos.`);
        
        await loadUserProfile();
        await loadFriends();
        loadAllUsers(); 
        
    } catch (e) {
        console.error("Remove Friend Error:", e);
        alert("Remove Duo Failed: " + (e.message || "Check Security Rules."));
    }
}

/**
 * Loads the current user's friends, stores their profiles, and renders the Duos tab.
 */
async function loadFriends() {
    const friendsTab = document.getElementById('friendsTab');
    const friendUids = currentProfileData.friends || [];
    friendsTab.innerHTML = "<h3>Your Duo Partners</h3>";
    friendProfiles = {}; // Reset cache

    if (friendUids.length === 0) {
        friendsTab.innerHTML += "<p>You have no Duo Partners yet. Find someone in Suggested or Search!</p>";
        return;
    }

    const friendPromises = friendUids.map(uid => db.collection("users").doc(uid).get());
    const friendDocs = await Promise.all(friendPromises);

    friendDocs.forEach(doc => {
        if (!doc.exists) return;
        const friendData = doc.data();
        friendProfiles[doc.id] = friendData;
        friendsTab.appendChild(renderUserCard(doc, friendData));
    });
    
    // If on messaging tab, refresh the chat list
    if (document.getElementById('messagingTab').classList.contains('hidden') === false) {
        loadChatList();
    }
}


// ---------- MESSAGING FUNCTIONS (NEW) ----------

/**
 * Generates a consistent Chat Document ID based on two UIDs.
 * @param {string} uid1 
 * @param {string} uid2 
 * @returns {string} Canonical Chat ID (e.g., smallerUID_largerUID)
 */
function getCanonicalChatId(uid1, uid2) {
    // Sort UIDs alphabetically to ensure the ID is always the same regardless of who starts the chat
    const participants = [uid1, uid2].sort();
    return participants.join('_');
}

/**
 * Loads the list of friends into the messaging sidebar.
 */
function loadChatList() {
    const duoList = document.getElementById('activeDuoList');
    duoList.innerHTML = '';
    
    const friendUids = currentProfileData.friends || [];

    if (friendUids.length === 0) {
        duoList.innerHTML = "<p>No Duos to chat with. Add friends first!</p>";
        return;
    }

    // Use the cached friend profiles
    friendUids.forEach(uid => {
        const profile = friendProfiles[uid];
        if (!profile) return;
        
        const entry = document.createElement('div');
        entry.className = 'chat-entry';
        entry.textContent = profile.nickname || `@${profile.username}`;
        
        // Placeholder for last message/timestamp (requires reading the 'chats' collection later)
        entry.innerHTML = `
            <div>${profile.nickname || `@${profile.username}`}</div>
            <div class="last-message-snippet">Click to start chatting...</div>
        `;
        entry.onclick = () => startChat(uid, profile);
        duoList.appendChild(entry);
    });
}

/**
 * Starts a chat with a specific user, setting up the real-time listener.
 * @param {string} targetUid The UID of the friend being chatted with.
 * @param {object} targetProfile The profile data of the friend.
 */
async function startChat(targetUid, targetProfile) {
    if (unsubscribeMessages) {
        unsubscribeMessages(); // Stop listening to the previous chat
    }
    
    currentChatUid = targetUid;
    const chatId = getCanonicalChatId(currentUser.uid, targetUid);
    
    document.getElementById('chatHeader').textContent = `Chatting with: @${targetProfile.username}`;
    document.getElementById('messageInputArea').classList.remove('hidden');
    document.getElementById('messageDisplay').innerHTML = '';

    // Set up the real-time listener for the messages subcollection
    const chatRef = db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "asc");

    unsubscribeMessages = chatRef.onSnapshot(snapshot => {
        const display = document.getElementById('messageDisplay');
        display.innerHTML = ''; // Clear display on update

        snapshot.forEach(doc => {
            const msg = doc.data();
            const messageEl = document.createElement('div');
            messageEl.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageEl.textContent = msg.text;
            display.appendChild(messageEl);
        });

        // Scroll to the bottom of the chat window
        display.scrollTop = display.scrollHeight;
    }, error => {
        console.error("Error listening to messages:", error);
        document.getElementById('messageDisplay').innerHTML = `<p style="color:red;">Error loading chat: ${error.message}</p>`;
    });
    
    // Highlight the active chat entry (Basic placeholder)
    document.querySelectorAll('.chat-entry').forEach(el => el.classList.remove('active'));
    // Find the entry that was just clicked and add the 'active' class
    // (A more robust solution would require adding the UID to the chat-entry element)
}

/**
 * Sends a message to the currently active chat.
 */
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const messageText = input.value.trim();

    if (!messageText || !currentChatUid) return;

    const chatId = getCanonicalChatId(currentUser.uid, currentChatUid);
    const chatDocRef = db.collection("chats").doc(chatId);

    try {
        // 1. Write the message to the messages subcollection
        await chatDocRef.collection("messages").add({
            senderId: currentUser.uid,
            text: messageText,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. Update the chat header document (for sorting/previews)
        await chatDocRef.set({
            participants: [currentUser.uid, currentChatUid].sort(),
            lastMessage: messageText,
            lastTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        input.value = ''; // Clear the input field

    } catch (e) {
        alert("Failed to send message: " + (e.message || "Check Messaging Security Rules."));
        console.error("Message Send Error:", e);
    }
}

// Ensure loadChatList is called when switching to the messaging tab
document.querySelector('#navigationBar button:nth-child(4)').onclick = () => {
    showTab('messaging');
    loadChatList();
};

// ... (Other remaining placeholder functions omitted for brevity) ...

</script>
</body>
</html>
