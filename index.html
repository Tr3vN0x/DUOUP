<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; margin:auto; padding:20px; }
.hidden { display:none; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.flex { display:flex; gap:15px; flex-wrap:wrap; }
.card { width:260px; padding:15px; border:2px solid cyan; border-radius:14px; background:#111; box-shadow:0 0 10px cyan; }
.avatar { width:40px; height:40px; border-radius:50%; border:2px solid cyan; object-fit:cover; }
.input { width:100%; padding:8px; margin:5px 0; background:#000; border:2px solid cyan; color:white; border-radius:6px; }

/* Chat */
#chatWindow { display:flex; flex-direction:column; max-height:400px; overflow-y:auto; padding:10px; border:2px solid cyan; border-radius:6px; background:#111; }
.message-bubble { padding:10px; border-radius:6px; max-width:70%; margin:5px; display:flex; flex-direction:column; word-wrap:break-word; }
.message-outgoing { background:#00ffff; color:black; align-self:flex-end; box-shadow:0 0 5px #00ffff; }
.message-incoming { background:#555; color:white; align-self:flex-start; box-shadow:0 0 3px #333; }
.message-header { font-size:0.7em; color:gray; margin-bottom:3px; display:flex; justify-content:space-between; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <div id="userList" class="flex"></div>
  <button class="neon-btn" onclick="logout()">Logout</button>
</div>

<!-- CHAT -->
<div id="chatPage" class="container hidden">
  <h2 id="chatWith"></h2>
  <div id="chatWindow"></div>
  <input id="chatInput" class="input" placeholder="Type a message">
  <button class="neon-btn" onclick="sendMessage()">Send</button>
  <button class="neon-btn" onclick="closeChat()">Back</button>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const chatPage = document.getElementById("chatPage");
const userList = document.getElementById("userList");
const chatWindow = document.getElementById("chatWindow");
const chatInput = document.getElementById("chatInput");

let currentChatUser = null;
let currentChatUserData = null;

// ------------- LOGIN -------------
function loginWithGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err=>alert(err.message));
}

// ------------- AUTH STATE -------------
auth.onAuthStateChanged(async user => {
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    chatPage.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  await ensureUserProfile(user);
  loadUsers();
});

async function ensureUserProfile(user){
  const userRef = db.collection("users").doc(user.uid);
  const snap = await userRef.get();
  if(!snap.exists){
    await userRef.set({
      uid: user.uid,
      nickname: user.displayName || "Player",
      email: user.email,
      profileImageUrl: user.photoURL || DEFAULT_AVATAR
    });
  }
  const profile = (await userRef.get()).data();
  document.getElementById("welcome").innerText = "Welcome, "+profile.nickname;
}

// ------------- LOGOUT -------------
function logout(){ auth.signOut(); }

// ------------- LOAD USERS -------------
function loadUsers(){
  const currentUid = auth.currentUser.uid;
  userList.innerHTML="";
  db.collection("users").get().then(snap=>{
    snap.forEach(doc=>{
      if(doc.id===currentUid) return;
      const u = doc.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="user">
          <img class="avatar" src="${u.profileImageUrl || DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
        </div>
        <button class="neon-btn" onclick="openChat('${doc.id}')">Message</button>`;
      userList.appendChild(card);
    });
  });
}

// ------------- CHAT -------------
function openChat(friendId){
  currentChatUser = friendId;
  dashboard.classList.add("hidden");
  chatPage.classList.remove("hidden");

  db.collection("users").doc(friendId).get().then(doc=>{
    currentChatUserData = doc.data();
    document.getElementById("chatWith").innerText = "Chat with "+currentChatUserData.nickname;
  });

  loadMessages();
  chatInput.focus();
}

// Listen for Enter key
chatInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});

// Load messages
function loadMessages(){
  if(!currentChatUser) return;
  const currentUid = auth.currentUser.uid;

  db.collection("messages")
    .where("participants", "array-contains", currentUid)
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      chatWindow.innerHTML="";
      snapshot.forEach(doc=>{
        const m = doc.data();
        if(!m.participants.includes(currentChatUser)) return;

        const isOutgoing = m.senderId === currentUid;
        const bubble = document.createElement("div");
        bubble.className = "message-bubble " + (isOutgoing ? "message-outgoing" : "message-incoming");

        const timeStr = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
        bubble.innerHTML = `
          <div class="message-header">
            <span>${isOutgoing ? "You" : currentChatUserData.nickname}</span>
            <span>${timeStr}</span>
          </div>
          <div>${m.content}</div>
        `;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        // Mark as seen if incoming
        if(!isOutgoing && !m.seen){
          doc.ref.update({seen:true});
        }
      });
    });
}

// Send message
function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !currentChatUser) return;

  const currentUid = auth.currentUser.uid;
  const senderAvatar = auth.currentUser.photoURL || DEFAULT_AVATAR;

  db.collection("messages").add({
    senderId: currentUid,
    receiverId: currentChatUser,
    participants: [currentUid, currentChatUser],
    content: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    seen: false,
    senderAvatar
  });

  chatInput.value="";
  chatInput.focus();
}

// Close chat
function closeChat(){
  currentChatUser = null;
  currentChatUserData = null;
  chatPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
}
</script>
</body>
</html>
