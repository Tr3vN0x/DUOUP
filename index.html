<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Auth Enabled MVP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- General and Reset --- */
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #15171e; 
            color: #f0f0f0;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            height: 100vh; 
            position: relative;
            display: flex;
            flex-direction: column;
            background: #1e1e2f; 
        }
        
        /* --- Authentication View Styles (NEW) --- */
        #auth-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 20px;
        }

        #auth-view h2 {
            color: #ffaa00;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-form {
            width: 100%;
            max-width: 350px;
            padding: 30px;
            background: #2a2a44;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .auth-form input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #3c3c5c;
            border-radius: 5px;
            background: #1e1e2f;
            color: white;
            font-size: 1em;
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        #auth-main-btn {
            background: #ffaa00;
            color: #1e1e2f;
        }

        #toggle-auth-btn {
            background: none;
            color: #5c6fff;
            margin-top: 15px;
            border: 1px solid #5c6fff;
        }
        
        #auth-message {
            color: #ff4560;
            margin-top: 10px;
            text-align: center;
        }

        /* --- Existing Styles (omitted for brevity) --- */
        #top-bar { display: none; } /* Hide until logged in */
        #bottom-nav { display: none; } /* Hide until logged in */
        /* ... all other styles from the previous full code update ... */
        
        /* --- Match Feed View Styles --- */
        .app-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            overflow-y: auto;
            padding-bottom: 80px; 
        }

        /* Only show the active view */
        #matching-view { display: flex; flex-direction: column; align-items: center; } 
        #top-bar.logged-in { display: flex; } 
        #bottom-nav.logged-in { display: flex; } 


        /* --- Paste ALL other CSS from the previous step HERE --- */
        /* --- Start of pasted CSS --- */

        /* --- Header & Top Bar --- */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #2a2a44;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        #top-bar h1 {
            color: #ffaa00;
            font-size: 1.5em;
            margin: 0;
        }
        .icon-btn {
            background: none;
            border: none;
            color: #f0f0f0;
            cursor: pointer;
            position: relative;
            padding: 5px;
        }
        .icon-btn .material-icons {
            font-size: 28px;
        }
        .icon-btn .badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ff4560; /* Highlight color */
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            transform: translate(50%, -50%);
        }

        /* --- Main Content Area (View Switching) --- */
        #content-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* --- 1. Match Feed View --- */
        #matching-view { display: flex; flex-direction: column; align-items: center; }
        #card-stack {
            position: relative;
            width: 90%;
            max-width: 400px;
            height: 550px; 
            margin: 20px 0;
        }
        /* Card styles remain the same for .gamer-card, .profile-img, .tag, etc. */
        .gamer-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #2a2a44; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            padding: 25px; display: flex; flex-direction: column; cursor: grab;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }
        .card-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #3c3c5c; padding-bottom: 15px; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #ff4560; }
        .username { margin: 0; font-size: 1.8em; flex-grow: 1; }
        .game-details { background: #1e1e2f; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .tag {
            display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-right: 8px; margin-top: 8px; color: #fff;
        }
        .role { background: #ff4560; } .rank { background: #5c6fff; } .platform { background: #ffaa00; } .vibe { background: #7c7c7c; }

        #action-buttons { display: flex; justify-content: space-around; width: 100%; max-width: 400px; padding: 10px; }
        .action-btn { padding: 15px 35px; border: none; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .skip { background: #5c6fff; color: white; }
        .request { background: #3dd022; color: white; }

        /* --- 2. Inbox/Chat List View --- */
        #inbox-view { padding: 10px; }
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #3c3c5c;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-list-item:hover { background: #2a2a44; }
        .chat-avatar-container { position: relative; margin-right: 15px; }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .online-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; background: #3dd022; border: 2px solid #1e1e2f; }
        .chat-details { flex-grow: 1; }
        .chat-details h3 { margin: 0; font-size: 1.1em; }
        .chat-details p { margin: 5px 0 0; color: #a0a0b0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { color: #ffaa00; font-size: 0.8em; }

        /* --- 3. Single Chat View (Floating) --- */
        #single-chat-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e1e2f; display: none; flex-direction: column; z-index: 20; 
        }
        .chat-header { display: flex; align-items: center; padding: 15px; background: #2a2a44; border-bottom: 1px solid #3c3c5c; }
        #chat-back-btn { background: none; border: none; color: #ffaa00; font-size: 1.2em; cursor: pointer; margin-right: 15px; }
        #messages-list { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        #message-form { display: flex; padding: 15px; background: #2a2a44; border-top: 1px solid #3c3c5c; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #3c3c5c; border-radius: 20px; background: #1e1e2f; color: white; margin-right: 10px; }
        #send-btn { padding: 10px 20px; background: #ffaa00; color: #1e1e2f; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* --- Fixed Bottom Navigation --- */
        #bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 600px;
            display: flex; justify-content: space-around; background: #2a2a44;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5); padding: 10px 0; z-index: 10;
        }
        .nav-item { text-align: center; color: #a0a0b0; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: #ffaa00; }
        .nav-item .material-icons { font-size: 28px; display: block; }
        .nav-item span { font-size: 0.7em; }

        /* --- End of pasted CSS --- */
    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="top-bar" class="logged-out">
            <h1>Duoup</h1>
            <button id="profile-btn" class="icon-btn">
                <span class="material-icons">person</span>
            </button>
        </div>

        <div id="content-area">
            
            <div id="auth-view" class="app-view" style="display: flex;">
                <h2>Welcome to Duoup</h2>
                
                <div class="auth-form">
                    <input type="text" id="auth-email" placeholder="Email" required>
                    <input type="password" id="auth-password" placeholder="Password" required>
                    
                    <button id="auth-main-btn">Sign Up</button>
                    <div id="auth-message"></div>
                    
                    <button id="toggle-auth-btn">Already have an account? Log In</button>
                </div>
            </div>
            
            <div id="matching-view" class="app-view">
                <div id="card-stack">
                    <div class="loading">Loading Gamer Cards...</div>
                </div>
                <div id="action-buttons">
                    <button id="skip-btn" class="action-btn skip" disabled>SKIP</button>
                    <button id="request-btn" class="action-btn request" disabled>DUO REQUEST</button>
                </div>
            </div>

            <div id="inbox-view" class="app-view">
                <h2>Your Duos</h2>
                <div id="chat-list">
                    <p>Log in to see your matches!</p>
                </div>
            </div>

            <div id="profile-view" class="app-view">
                <h2>Your Profile & Settings</h2>
                <button id="logout-btn" class="auth-form button" style="background: #ff4560;">Log Out</button>
            </div>
            
        </div>

        <div id="single-chat-view"> 
            <header class="chat-header">
                <button id="chat-back-btn">‚Üê Back</button>
                <h2 id="chat-partner-name">Chat with Duo</h2>
            </header>
            
            <div id="messages-list">
            </div>
            
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type your message..." required>
                <button type="submit" id="send-btn">Send</button>
            </form>
        </div>

        <div id="bottom-nav" class="logged-out">
            <div class="nav-item active" data-view="matching-view">
                <span class="material-icons">favorite</span>
                <span>Match</span>
            </div>
            <div class="nav-item" data-view="inbox-view">
                <span class="material-icons">chat</span>
                <span>Duos</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Your Keys) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
            authDomain: "duoup-cfae6.firebaseapp.com",
            projectId: "duoup-cfae6",
            storageBucket: "duoup-cfae6.firebasestorage.app",
            messagingSenderId: "812263060524",
            appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
            measurementId: "G-46B67F90FK"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- 2. GLOBAL STATE ---
        let currentUserId = null; 
        let isSigningUp = true; // Auth state
        // ... (other state variables)
        let cards = [];
        let currentIndex = 0;
        let currentChatId = null;
        let unsubscribeMessages = null;
        let unsubscribeChats = null;

        // --- 3. CORE DOM ELEMENTS (Updated) ---
        const contentAreaEl = document.getElementById('content-area');
        const bottomNavEl = document.getElementById('bottom-nav');
        const topBarEl = document.getElementById('top-bar');
        const authViewEl = document.getElementById('auth-view');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMainBtn = document.getElementById('auth-main-btn');
        const toggleAuthBtn = document.getElementById('toggle-auth-btn');
        const authMessageEl = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');
        
        // ... (other DOM elements remain the same)
        const chatListEl = document.getElementById('chat-list');
        const singleChatViewEl = document.getElementById('single-chat-view');
        const chatBackBtn = document.getElementById('chat-back-btn');
        const messageFormEl = document.getElementById('message-form');
        const requestBtn = document.getElementById('request-btn');
        const skipBtn = document.getElementById('skip-btn');


        // -----------------------------------------------------------------
        // A. AUTHENTICATION LOGIC (NEW)
        // -----------------------------------------------------------------

        // Helper to update the Auth UI
        function updateAuthUI() {
            authMainBtn.textContent = isSigningUp ? 'Sign Up' : 'Log In';
            toggleAuthBtn.textContent = isSigningUp 
                ? 'Already have an account? Log In' 
                : 'Need an account? Sign Up';
            authMessageEl.textContent = '';
        }
        
        toggleAuthBtn.addEventListener('click', () => {
            isSigningUp = !isSigningUp;
            updateAuthUI();
        });

        authMainBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessageEl.textContent = '';
            
            if (!email || password.length < 6) {
                authMessageEl.textContent = 'Please enter a valid email and a password of at least 6 characters.';
                return;
            }

            try {
                if (isSigningUp) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createInitialUserDocument(userCredential.user.uid, email);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                authMessageEl.textContent = 'Error: ' + error.message;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            console.log("User signed out.");
            // AuthStateChanged will handle the view switch
        });


        // Function to create the initial user profile in Firestore
        async function createInitialUserDocument(uid, email) {
            const userRef = db.collection('users').doc(uid);
            await userRef.set({
                email: email,
                username: email.split('@')[0], // Simple default username
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                profileImageUrl: 'https://via.placeholder.com/150',
                isPremium: false
            });
        }


        // -----------------------------------------------------------------
        // B. AUTH STATE HANDLER (NEW FLOW CONTROL)
        // -----------------------------------------------------------------

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                
                // Show App UI
                topBarEl.classList.add('logged-in');
                bottomNavEl.classList.add('logged-in');
                topBarEl.style.display = 'flex';
                bottomNavEl.style.display = 'flex';
                
                authViewEl.style.display = 'none';
                
                // Start app on the Match View
                switchView('matching-view');
                fetchGamerCards();

            } else {
                currentUserId = null;
                
                // Show Auth UI
                topBarEl.style.display = 'none';
                bottomNavEl.style.display = 'none';
                authViewEl.style.display = 'flex';
                
                // Hide all other views
                document.querySelectorAll('.app-view').forEach(view => {
                    if (view.id !== 'auth-view') {
                        view.style.display = 'none';
                    }
                });
                
                // Reset Auth inputs and state
                authEmailInput.value = '';
                authPasswordInput.value = '';
                isSigningUp = true;
                updateAuthUI();
                
                // Clean up listeners
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeChats) unsubscribeChats();
            }
        });


        // -----------------------------------------------------------------
        // C. REST OF THE APP LOGIC (UNCHANGED CORE FUNCTIONS)
        // -----------------------------------------------------------------

        // --- NAVIGATION LOGIC ---
        function switchView(viewId) {
            // ... (switchView logic remains the same, but now controls app views only)
            document.querySelectorAll('.app-view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'flex';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.querySelector(`.nav-item[data-view="${viewId}"]`);
            if (navItem) navItem.classList.add('active');

            if (viewId === 'matching-view' && cards.length === 0) {
                fetchGamerCards();
            }
            if (viewId === 'inbox-view') {
                fetchChatList();
            } else {
                if (unsubscribeChats) unsubscribeChats();
            }
        }

        bottomNavEl.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                switchView(navItem.dataset.view);
            }
        });

        // --- MATCH FEED LOGIC ---
        // (fetchGamerCards, renderCurrentCard, swipeCard, requestBtn listener logic remain the same)
        async function fetchGamerCards() {
            // ... (implementation of fetching cards) ...
        }
        
        // --- INBOX (CHAT LIST) LOGIC ---
        // (renderChatListItem and fetchChatList logic remain the same)
        async function fetchChatList() {
            // ... (implementation of fetching chat list) ...
        }

        // --- SINGLE CHAT VIEW LOGIC ---
        // (generateChatId, renderMessage, startChatListener, messageFormEl listener, chatBackBtn logic remain the same)
        function generateChatId(uid1, uid2) {
            const sortedUids = [uid1, uid2].sort();
            return sortedUids.join('_');
        }

        // --- CLIENT-SIDE TRANSACTION LOGIC (Accept Match) ---
        // (acceptFriendRequestAndCreateChat logic remains the same)
        async function acceptFriendRequestAndCreateChat(requestId, senderId, receiverId, gameSlug, senderName) {
            // ... (implementation of client-side transaction) ...
        }

        // Placeholder for functions that were omitted for brevity but required for full app function
        function renderCurrentCard() { /* ... */ }
        function swipeCard(action) { /* ... */ }
        function renderChatListItem(chat) { /* ... */ }
        function renderMessage(messageData) { /* ... */ }
        function startChatListener(chatId) { /* ... */ }

        // Initialize Auth UI on load
        updateAuthUI();
    </script>
</body>
</html>
