<script type="module">
// ----- Firebase Imports -----
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { 
  getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import { 
  getFirestore, collection, doc, setDoc, getDoc, updateDoc, getDocs, query, where, onSnapshot, serverTimestamp, addDoc, orderBy 
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

// ----- Firebase Config -----
const firebaseConfig = {
  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw", 
  authDomain: "duoup-cfae6.firebaseapp.com",
  projectId: "duoup-cfae6",
  storageBucket: "duoup-cfae6.appspot.com",
  messagingSenderId: "812263060524",
  appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
  measurementId: "G-46B67F90FK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

// ----- DOM Elements -----
const signinForm = document.getElementById("signin");
const signupForm = document.getElementById("signup");
const googleBtn = document.querySelector(".google-btn");
const authSection = document.getElementById("auth-section");
const appSection = document.getElementById("app-section");
const mainHeader = document.getElementById("mainHeader");
const logoutBtn = document.getElementById("logoutBtnHeader");
const usersGrid = document.getElementById("usersGrid");
const userCountElement = document.getElementById("userCount");
const requestsGrid = document.getElementById("requestsGrid");
const duosGrid = document.getElementById("duosGrid");
const chatModal = document.getElementById("chatModal");
const chatHeader = document.getElementById("chatHeader");
const messageArea = document.getElementById("messageArea");
const chatInput = document.getElementById("chatInput");
const duoSearchForm = document.getElementById("duoSearchForm");
const searchQueryInput = document.getElementById("searchQuery");
const profilePreviewContainer = document.getElementById("profilePreviewContainer");
const notificationBadge = document.getElementById("notificationBadge");

let allUsersData = [];
let activeChatId = "";
let activeFriendUid = "";

// ----- AUTH -----
signinForm.addEventListener("submit", async e => {
    e.preventDefault();
    try {
        await signInWithEmailAndPassword(auth, document.getElementById("signin-email").value, document.getElementById("signin-password").value);
    } catch(err){ alert(err.message); }
});

signupForm.addEventListener("submit", async e => {
    e.preventDefault();
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    try {
        const userCredential = await createUserWithEmailAndPassword(auth,email,password);
        await setDoc(doc(db,"users",userCredential.user.uid),{
            uid:userCredential.user.uid,
            username:"New Player",
            email,
            platform:"",
            games:"",
            playstyle:"",
            about:"",
            photoURL:"",
            mic:"",
            timestamp:serverTimestamp()
        });
    } catch(err){ alert(err.message); }
});

googleBtn.addEventListener("click", async ()=>{ 
    try{ await signInWithPopup(auth,provider); } catch(err){ alert(err.message); }
});

logoutBtn.addEventListener("click", async ()=>{ 
    await signOut(auth); 
});

// ----- PROFILE -----
async function loadProfile(){
    const user = auth.currentUser; if(!user) return;
    const docSnap = await getDoc(doc(db,"users",user.uid));
    const data = docSnap.exists()?docSnap.data():{};
    document.getElementById("profile-username").value = data.username || "";
    document.getElementById("profile-platform").value = data.platform || "";
    document.getElementById("profile-games").value = data.games || "";
    document.getElementById("profile-playstyle").value = data.playstyle || "";
    document.getElementById("profile-about").value = data.about || "";
    renderProfilePreview(data);
    setupProfileListeners(data);
}

// Profile preview
function renderProfilePreview(data){
    const username = document.getElementById("profile-username").value || data.username || 'New Player';
    const platform = document.getElementById("profile-platform").value || data.platform || 'N/A';
    const games = document.getElementById("profile-games").value || data.games || 'N/A';
    const playstyle = document.getElementById("profile-playstyle").value || data.playstyle || 'N/A';
    const photoURL = data.photoURL || '';
    profilePreviewContainer.innerHTML = `
        <div class="duo-card">
            <div class="card-header">
                <div class="avatar">${photoURL ? `<img src="${photoURL}">` : username[0]}</div>
                <strong>${username}</strong>
            </div>
            <div class="bio">
                Platform: ${platform}<br>
                Games: ${games}<br>
                Playstyle: ${playstyle}
            </div>
            <button class="action-button" disabled style="opacity:0.7; cursor:default;">Profile Preview</button>
        </div>
    `;
}

// Auto-save profile
function setupProfileListeners(initialData){
    const fields = document.querySelectorAll(".profile-field");
    fields.forEach(field=>{
        let timeout;
        field.addEventListener('input', ()=>{
            clearTimeout(timeout);
            timeout = setTimeout(async ()=>{
                const user = auth.currentUser;
                if(!user) return;
                const username = document.getElementById("profile-username").value;
                const platform = document.getElementById("profile-platform").value;
                const games = document.getElementById("profile-games").value;
                const playstyle = document.getElementById("profile-playstyle").value;
                const about = document.getElementById("profile-about").value;
                await updateDoc(doc(db,"users",user.uid), { username, platform, games, playstyle, about });
                renderProfilePreview({ username, platform, games, playstyle, about, photoURL: initialData.photoURL });
            },800);
        });
    });

    // Photo upload
    document.getElementById("profile-photo").addEventListener('change', async e=>{
        const file = e.target.files[0];
        if(file){
            const user = auth.currentUser;
            if(!user) return;
            const storageRef = ref(storage,`profiles/${user.uid}`);
            await uploadBytes(storageRef,file);
            const photoURL = await getDownloadURL(storageRef);
            await updateDoc(doc(db,"users",user.uid), { photoURL });
            loadProfile();
        }
    });
}

// ----- SECTIONS -----
function showSection(section){
    ["home","profile","messages"].forEach(s=>document.getElementById(s+"-section").style.display="none");
    document.getElementById(section+"-section").style.display="block";
    if(section==="profile") loadProfile();
}

// ----- DUO SEARCH -----
async function loadUsers(){
    usersGrid.innerHTML = "<p style='color:var(--duoup-muted)'>Loading users...</p>";
    const usersSnapshot = await getDocs(collection(db,"users"));
    allUsersData = [];
    usersGrid.innerHTML = "";
    let count = 0;
    usersSnapshot.forEach(docSnap=>{
        const data = docSnap.data();
        if(data.uid !== auth.currentUser.uid){ 
            allUsersData.push(data);
            usersGrid.innerHTML += createUserCard(data);
            count++;
        }
    });
    userCountElement.textContent = `${count} Players Online`;
}

// Search filter
duoSearchForm.addEventListener("submit", e=>{
    e.preventDefault();
    const query = searchQueryInput.value.toLowerCase();
    const filtered = allUsersData.filter(u=>{
        return u.username.toLowerCase().includes(query) || (u.games||'').toLowerCase().includes(query) || (u.platform||'').toLowerCase().includes(query);
    });
    usersGrid.innerHTML = "";
    if(filtered.length === 0){
        usersGrid.innerHTML = "<p style='color:var(--duoup-muted)'>No users found</p>";
    } else {
        filtered.forEach(u=>{ usersGrid.innerHTML += createUserCard(u); });
    }
});

// Create user card with "Send Request"
function createUserCard(data){
    return `
        <div class="duo-card">
            <div class="card-header">
                <div class="avatar">${data.photoURL ? `<img src="${data.photoURL}">` : data.username[0]}</div>
                <strong>${data.username}</strong>
            </div>
            <div class="bio">
                Platform: ${data.platform||'N/A'}<br>
                Games: ${data.games||'N/A'}<br>
                Playstyle: ${data.playstyle||'N/A'}
            </div>
            <button class="action-button" onclick="sendDuoRequest('${data.uid}','${data.username}')">Connect</button>
        </div>
    `;
}

// ----- DUO REQUESTS -----
async function sendDuoRequest(targetUid,targetName){
    const user = auth.currentUser;
    if(!user) return;
    await addDoc(collection(db,"duoRequests"),{
        fromUid: user.uid,
        toUid: targetUid,
        status: "pending",
        timestamp: serverTimestamp()
    });
    alert(`Duo request sent to ${targetName}`);
}

// Load pending requests and accepted duos
async function loadDuoRequests(){
    const user = auth.currentUser;
    if(!user) return;

    // Pending requests TO ME
    const q = query(collection(db,"duoRequests"), where("toUid","==",user.uid), orderBy("timestamp","desc"));
    onSnapshot(q,snap=>{
        requestsGrid.innerHTML = "";
        snap.forEach(docSnap=>{
            const data = docSnap.data();
            requestsGrid.innerHTML += `
                <div class="duo-card duo-request-card">
                    <div class="card-header">
                        <div class="avatar">?</div>
                        <strong>From User</strong>
                    </div>
                    <div class="bio">Click Accept or Decline</div>
                    <div style="display:flex; gap:5px; padding:10px;">
                        <button onclick="acceptRequest('${docSnap.id}','${data.fromUid}')">Accept</button>
                        <button onclick="declineRequest('${docSnap.id}')">Decline</button>
                    </div>
                </div>
            `;
        });
    });

    // Accepted duos
    const acceptedQuery = query(collection(db,"duoRequests"), where("status","==","accepted"), where("toUid","==",user.uid));
    onSnapshot(acceptedQuery,snap=>{
        duosGrid.innerHTML = "";
        snap.forEach(docSnap=>{
            const data = docSnap.data();
            duosGrid.innerHTML += `
                <div class="duo-card" onclick="openChat('${data.fromUid}')">
                    <div class="card-header">
                        <div class="avatar">D</div>
                        <strong>Duo Chat</strong>
                    </div>
                    <div class="bio">Click to chat with this duo</div>
                </div>
            `;
        });
    });
}

// Accept/Decline
async function acceptRequest(docId,fromUid){
    await updateDoc(doc(db,"duoRequests",docId), { status: "accepted" });
}
async function declineRequest(docId){
    await updateDoc(doc(db,"duoRequests",docId), { status: "declined" });
}

// ----- CHAT -----
function openChat(friendUid){
    activeFriendUid = friendUid;
    activeChatId = [auth.currentUser.uid,friendUid].sort().join("_");
    chatHeader.textContent = `Chat with ${friendUid}`;
    chatModal.style.display = "flex";

    // Load messages in real-time
    const messagesQuery = query(collection(db,"messages"), where("chatId","==",activeChatId), orderBy("timestamp","asc"));
    onSnapshot(messagesQuery, snap=>{
        messageArea.innerHTML = "";
        snap.forEach(docSnap=>{
            const msg = docSnap.data();
            const isSelf = msg.fromUid === auth.currentUser.uid;
            messageArea.innerHTML += `<div class="message ${isSelf?"self":"other"}"><div class="message-content">${msg.text}</div></div>`;
        });
        messageArea.scrollTop = messageArea.scrollHeight;
    });
}

async function sendMessage(){
    if(chatInput.value.trim()==="") return;
    await addDoc(collection(db,"messages"),{
        chatId: activeChatId,
        fromUid: auth.currentUser.uid,
        toUid: activeFriendUid,
        text: chatInput.value,
        timestamp: serverTimestamp()
    });
    chatInput.value = "";
}

function closeChat(){
    chatModal.style.display = "none";
}

// ----- AUTH STATE -----
onAuthStateChanged(auth,user=>{
    if(user){
        authSection.style.display="none";
        appSection.style.display="block";
        mainHeader.style.display="flex";
        loadUsers();
        loadDuoRequests();
        showSection('home');
    } else {
        authSection.style.display="flex";
        appSection.style.display="none";
        mainHeader.style.display="none";
    }
});

// Global
window.loadProfile = loadProfile;
window.showSection = showSection;
window.sendMessage = sendMessage;
window.closeChat = closeChat;
window.openChat = openChat;
window.acceptRequest = acceptRequest;
window.declineRequest = declineRequest;
window.sendDuoRequest = sendDuoRequest;
</script>
