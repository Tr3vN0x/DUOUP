<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DUO UP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Orbitron',sans-serif;
  background:#0b0b0b;
  color:white;
}
.hidden{display:none}
.container{width:90%;margin:auto;padding:20px}
.neon-btn{
  background:transparent;
  color:white;
  border:2px solid cyan;
  padding:8px 14px;
  margin:5px;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 0 10px cyan;
}
.neon-btn:hover{border-color:magenta;box-shadow:0 0 15px magenta}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.flex{display:flex;flex-wrap:wrap;gap:15px}
.card{
  width:260px;
  padding:15px;
  border:2px solid cyan;
  border-radius:15px;
  box-shadow:0 0 10px cyan;
  background:#111;
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  border:2px solid cyan;
  object-fit:cover;
}
.user{display:flex;gap:10px;align-items:center}
.badge{color:gold;margin-left:5px}
input{
  width:100%;
  padding:8px;
  margin:5px 0;
  background:transparent;
  border:2px solid cyan;
  color:white;
  border-radius:6px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="login()">Login with Google</button>
</div>

<!-- USERNAME -->
<div id="usernamePage" class="container hidden">
  <h2>Pick a Username</h2>
  <input id="usernameInput" placeholder="Username">
  <button class="neon-btn" onclick="saveUsername()">Continue</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">

  <div class="header">
    <h2 id="welcome"></h2>
    <div>
      <button class="neon-btn" onclick="openProfile()">Profile</button>
      <button class="neon-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div>
    <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
    <button class="neon-btn" onclick="showTab('requests')">Requests</button>
    <button class="neon-btn" onclick="showTab('friends')">Friends</button>
  </div>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>

</div>

<!-- PROFILE -->
<div id="profileEditor" class="container hidden">
  <h2>Edit Profile</h2>
  <img id="profilePreview" class="avatar"><br>
  <input type="file" id="profileImage">
  <input id="editStatus" placeholder="Status">
  <button class="neon-btn" onclick="saveProfile()">Save</button>
  <button class="neon-btn" onclick="closeProfile()">Back</button>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

auth.onAuthStateChanged(user=>{
  if(!user) return;
  db.collection("users").doc(user.uid).get().then(doc=>{
    if(doc.exists && doc.data().nickname){
      loadDashboard(doc.data());
    }else{
      loginPage.classList.add("hidden");
      usernamePage.classList.remove("hidden");
    }
  });
});

function saveUsername(){
  const user=auth.currentUser;
  const name=usernameInput.value.trim();
  if(!name) return alert("Username required");

  db.collection("users").doc(user.uid).set({
    uid:user.uid,
    nickname:name,
    email:user.email,
    friends:[],
    profileImageUrl:user.photoURL||"",
    status:"Online",
    isPremium:false
  }).then(()=>{
    usernamePage.classList.add("hidden");
    loadDashboard({nickname:name,profileImageUrl:user.photoURL});
  });
}

function loadDashboard(data){
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  welcome.innerText="Welcome, "+data.nickname;
  loadSuggested();
  loadRequests();
  loadFriends();
  showTab("suggested");
}

function logout(){
  auth.signOut();
  location.reload();
}

function showTab(tab){
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(tab+"Tab").classList.remove("hidden");
}

function loadSuggested(){
  suggestedTab.innerHTML="";
  db.collection("users").get().then(users=>{
    users.forEach(u=>{
      if(u.id===auth.currentUser.uid) return;
      suggestedTab.innerHTML+=`
      <div class="card">
        <div class="user">
          <img class="avatar" src="${u.data().profileImageUrl||''}">
          <div>
            <strong>${u.data().nickname}</strong>
            ${u.data().isPremium?"<span class='badge'>â˜…</span>":""}
            <div>${u.data().status||""}</div>
          </div>
        </div>
        <button class="neon-btn" onclick="sendRequest('${u.id}')">DUO UP</button>
      </div>`;
    });
  });
}

function sendRequest(id){
  db.collection("friendRequests").add({
    senderId:auth.currentUser.uid,
    receiverId:id,
    status:"pending",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadRequests(){
  requestsTab.innerHTML="";
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(s=>{
      requestsTab.innerHTML="";
      s.forEach(r=>{
        db.collection("users").doc(r.data().senderId).get().then(u=>{
          requestsTab.innerHTML+=`
          <div class="card">
            <strong>${u.data().nickname}</strong><br><br>
            <button class="neon-btn" onclick="accept('${r.id}','${u.id}')">Accept</button>
            <button class="neon-btn" onclick="reject('${r.id}')">Reject</button>
          </div>`;
        });
      });
    });
}

function accept(rid,sender){
  db.collection("friendRequests").doc(rid).update({status:"accepted"});
  db.collection("users").doc(auth.currentUser.uid)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(sender)});
  db.collection("users").doc(sender)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)});
}

function reject(id){
  db.collection("friendRequests").doc(id).update({status:"rejected"});
}

function loadFriends(){
  friendsTab.innerHTML="";
  db.collection("users").doc(auth.currentUser.uid)
    .onSnapshot(doc=>{
      friendsTab.innerHTML="";
      doc.data().friends.forEach(fid=>{
        db.collection("users").doc(fid).get().then(u=>{
          friendsTab.innerHTML+=`
          <div class="card">
            <strong>${u.data().nickname}</strong>
          </div>`;
        });
      });
    });
}

function openProfile(){
  dashboard.classList.add("hidden");
  profileEditor.classList.remove("hidden");
  db.collection("users").doc(auth.currentUser.uid).get().then(d=>{
    profilePreview.src=d.data().profileImageUrl||"";
    editStatus.value=d.data().status||"";
  });
}

function closeProfile(){
  profileEditor.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function saveProfile(){
  const file=profileImage.files[0];
  if(file){
    const ref=storage.ref("profiles/"+auth.currentUser.uid);
    ref.put(file).then(()=>ref.getDownloadURL().then(url=>{
      updateProfile(url);
    }));
  }else updateProfile(null);
}

function updateProfile(url){
  const data={status:editStatus.value};
  if(url) data.profileImageUrl=url;
  db.collection("users").doc(auth.currentUser.uid).update(data).then(closeProfile);
}
</script>
</body>
</html>
