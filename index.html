
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Final MVP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- Base Mobile Styles (Default) --- */
        body {
            font-family: 'Roboto', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
            background: #15171e; color: #f0f0f0;
        }
        #app-container {
            /* Mobile/Small Tablet size */
            width: 100%; max-width: 600px; height: 100vh; position: relative;
            display: flex; flex-direction: column; background: #1e1e2f; 
        }
        
        /* --- Shared Styles --- */
        .loading { text-align: center; padding: 20px; color: #ffaa00; }

        /* --- Auth View --- */
        #auth-view { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 20px; }
        #auth-view h2 { color: #ffaa00; margin-bottom: 30px; font-size: 2em; }
        .auth-form { width: 100%; max-width: 350px; padding: 30px; background: #2a2a44; border-radius: 10px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); }
        .auth-form input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #3c3c5c; border-radius: 5px; background: #1e1e2f; color: white; font-size: 1em; }
        .auth-form button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
        #auth-main-btn { background: #ffaa00; color: #1e1e2f; }
        #toggle-auth-btn { background: none; color: #5c6fff; margin-top: 15px; border: 1px solid #5c6fff; }
        #auth-message { color: #ff4560; margin-top: 10px; text-align: center; }

        /* --- Top Bar and Navigation --- */
        #top-bar { display: none; justify-content: space-between; align-items: center; padding: 15px; background: #2a2a44; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); z-index: 10; }
        #top-bar h1 { color: #ffaa00; font-size: 1.5em; margin: 0; }
        .icon-btn { background: none; border: none; color: #f0f0f0; cursor: pointer; position: relative; padding: 5px; }
        .icon-btn .material-icons { font-size: 28px; }
        #bottom-nav { display: none; position: fixed; bottom: 0; width: 100%; max-width: 600px; justify-content: space-around; background: #2a2a44; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5); padding: 10px 0; z-index: 10; }
        .nav-item { text-align: center; color: #a0a0b0; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: #ffaa00; }
        .nav-item .material-icons { font-size: 28px; display: block; }
        .nav-item span { font-size: 0.7em; }

        /* --- Match Feed View --- */
        #content-area { flex-grow: 1; position: relative; overflow: hidden; }
        .app-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; overflow-y: auto; padding-bottom: 80px; }
        #matching-view { display: flex; flex-direction: column; align-items: center; }
        #card-stack { position: relative; width: 90%; max-width: 400px; height: 550px; margin: 20px 0; }
        .gamer-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2a2a44; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            padding: 25px; display: flex; flex-direction: column; cursor: grab; transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #ff4560; }
        .card-header { display: flex; align-items: center; margin-bottom: 15px; }
        .card-header .username { margin: 0; font-size: 1.8em; }
        .card-bio { flex-grow: 1; margin-bottom: 10px; }
        .game-info h3 { margin: 5px 0 10px; color: #ffaa00; }
        .tag { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-right: 8px; margin-top: 8px; color: #fff; }
        .role { background: #ff4560; } .rank { background: #5c6fff; } .platform { background: #ffaa00; } .vibe { background: #7c7c7c; }
        #action-buttons { display: flex; justify-content: space-around; width: 100%; max-width: 400px; padding: 10px; }
        .action-btn { padding: 15px 35px; border: none; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .skip { background: #5c6fff; color: white; } .request { background: #3dd022; color: white; }

        /* --- Inbox View --- */
        #inbox-view { padding: 10px; }
        .chat-list-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #3c3c5c; cursor: pointer; transition: background 0.2s; }
        .chat-list-item:hover { background: #2a2a44; }
        
        /* --- Profile/Edit View --- */
        #profile-view { padding: 20px; display: flex; flex-direction: column; gap: 20px;}
        .edit-section h3 { color: #5c6fff; border-bottom: 2px solid #5c6fff; padding-bottom: 5px; margin-top: 0;}
        .edit-form-group { margin-bottom: 15px; }
        .edit-form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #a0a0b0; }
        .edit-form-group input, .edit-form-group select {
            width: calc(100% - 20px); padding: 10px; border-radius: 5px; border: 1px solid #3c3c5c;
            background: #2a2a44; color: white;
        }
        #update-profile-btn, #update-card-btn { background: #3dd022; color: white; margin-top: 10px; }
        #logout-btn { background: #ff4560; color: white; }

        /* --- Single Chat View --- */
        #single-chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e2f; display: none; flex-direction: column; z-index: 20; }
        #message-form { display: flex; padding: 15px; background: #2a2a44; border-top: 1px solid #3c3c5c; }
        #message-input { flex-grow: 1; margin-right: 10px; }
        #send-btn { width: 80px; }
        #messages-list { overflow-y: auto; padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { display: flex; align-items: center; padding: 10px 15px; background: #2a2a44; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
        .chat-header h2 { flex-grow: 1; text-align: center; margin: 0; font-size: 1.2em; }
        .message { padding: 10px 15px; margin: 5px 0; max-width: 80%; border-radius: 15px; font-size: 0.9em; position: relative; }
        .message.sent { align-self: flex-end; background: #3dd022; color: #1e1e2f; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: #5c6fff; color: white; border-bottom-left-radius: 4px; }
        .message-time { font-size: 0.65em; opacity: 0.6; margin-top: 5px; display: block; text-align: right;}
        .system-message { text-align: center; color: #a0a0b0; padding: 10px; font-style: italic; }


        /* ======================================================================
        DESKTOP / TABLET OPTIMIZATION (min-width: 768px)
        ======================================================================
        */
        @media (min-width: 768px) {
            body { 
                align-items: flex-start;
                justify-content: center;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            #app-container {
                max-width: 1200px;
                height: 90vh; 
                border-radius: 12px;
                box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
                flex-direction: row; 
                overflow: hidden;
            }

            #top-bar { display: none !important; } 
            #bottom-nav { display: none !important; } 
            
            #content-area {
                width: 100%;
                display: flex;
                flex-direction: row; 
            }

            /* --- Desktop Side Navigation --- */
            #desktop-nav {
                display: flex !important;
                flex-direction: column;
                width: 80px; 
                background: #2a2a44;
                padding-top: 20px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
                flex-shrink: 0;
            }
            #desktop-nav .nav-item {
                padding: 15px 0;
                text-align: center;
                transition: background 0.2s;
                margin-bottom: 10px;
            }
            #desktop-nav .nav-item:hover {
                background: #3c3c5c;
            }
            #desktop-nav .nav-item.active {
                border-left: 3px solid #ffaa00;
                color: #ffaa00;
                background: #3c3c5c;
            }


            /* --- Views Adjustment --- */
            .app-view {
                position: relative; 
                width: 100%;
                height: 100%;
                padding-bottom: 0; 
                display: none;
                flex-shrink: 0;
            }

            #matching-view { 
                padding: 20px;
                flex-grow: 1; 
                max-width: 600px;
                border-right: 1px solid #3c3c5c; 
            }
            
            #profile-view {
                padding: 20px;
                flex-grow: 1;
                max-width: none;
            }

            /* --- Desktop Chat Layout (Multi-Panel) --- */
            #inbox-view { 
                display: flex !important;
                flex-direction: row;
                padding: 0;
                flex-grow: 1;
            }

            #chat-list-panel {
                width: 300px;
                min-width: 250px;
                border-right: 1px solid #3c3c5c;
                overflow-y: auto;
                padding: 10px 0;
                flex-shrink: 0;
            }

            #message-panel {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            #single-chat-view {
                position: relative; 
                display: none; 
                width: 100%;
                height: 100%;
                z-index: 1; 
            }
            #single-chat-view > .chat-header {
                display: none; 
            }
            
        }

    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="desktop-nav" style="display: none;">
            <div class="nav-item active" data-view="matching-view">
                <span class="material-icons">favorite</span>
                <span>Match</span>
            </div>
            <div class="nav-item" data-view="inbox-view">
                <span class="material-icons">chat</span>
                <span>Duos</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>

        <div id="top-bar">
            <h1>Duoup</h1>
            <button id="profile-btn" class="icon-btn" onclick="switchView('profile-view')">
                <span class="material-icons">person</span>
            </button>
        </div>

        <div id="content-area">
            
            <div id="auth-view" class="app-view">
                <h2>Welcome to Duoup</h2>
                <div class="auth-form">
                    <input type="text" id="auth-email" placeholder="Email" required>
                    <input type="password" id="auth-password" placeholder="Password" required>
                    <button id="auth-main-btn">Sign Up</button>
                    <div id="auth-message"></div>
                    <button id="toggle-auth-btn">Already have an account? Log In</button>
                </div>
            </div>
            
            <div id="matching-view" class="app-view">
                <div id="card-stack">
                    <div class="loading">Loading Gamer Cards...</div>
                </div>
                <div id="action-buttons">
                    <button id="skip-btn" class="action-btn skip" disabled>SKIP</button>
                    <button id="request-btn" class="action-btn request" disabled>DUO REQUEST</button>
                </div>
            </div>

            <div id="inbox-view" class="app-view">
                <div id="chat-list-panel">
                    <h2 style="padding: 0 10px;">Your Duos</h2>
                    <div id="chat-list">
                        <p style="text-align: center;">Loading your matches...</p>
                    </div>
                </div>
                <div id="message-panel">
                    <div id="single-chat-view"> 
                        <header class="chat-header">
                            <button id="chat-back-btn">‚Üê Back</button>
                            <h2 id="chat-partner-name">Chat with Duo</h2>
                        </header>
                        
                        <div id="messages-list"></div>
                        
                        <form id="message-form">
                            <input type="text" id="message-input" placeholder="Type your message..." required>
                            <button type="submit" id="send-btn">Send</button>
                        </form>
                    </div>
                    <p id="chat-prompt" style="color: #a0a0b0;">Select a Duo from the left to start chatting.</p>
                </div>
            </div>

            <div id="profile-view" class="app-view">
                <h2>Account Settings</h2>
                
                <div class="edit-section">
                    <h3>User Profile</h3>
                    <div class="edit-form-group">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" placeholder="Username">
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-bio">Bio / Description (for your profile)</label>
                        <input type="text" id="edit-bio" placeholder="Looking for competitive duo...">
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-imgurl">Profile Image URL</label>
                        <input type="url" id="edit-imgurl" placeholder="https://via.placeholder.com/150">
                    </div>
                    <button id="update-profile-btn">Update Profile</button>
                    <p id="profile-message" style="color: #3dd022;"></p>
                </div>

                <div class="edit-section">
                    <h3>Gamer Card (Match Settings)</h3>
                    <div class="edit-form-group">
                        <label for="edit-game">Game</label>
                        <select id="edit-game">
                            <option value="valorant">Valorant (Default)</option> 
                            <option value="overwatch_2">Overwatch 2</option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-role">In-Game Role</label>
                        <input type="text" id="edit-role" placeholder="Initiator, Tank, etc.">
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-skill">Skill Level</label>
                        <input type="text" id="edit-skill" placeholder="Diamond III">
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-platform">Platform</label>
                        <input type="text" id="edit-platform" placeholder="PC, PS5">
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-vibe">Vibe / Playstyle</label>
                        <input type="text" id="edit-vibe" placeholder="Competitive, Casual, Chill">
                    </div>
                    <button id="update-card-btn">Update Gamer Card</button>
                    <p id="card-message" style="color: #3dd022;"></p>
                </div>
                
                <button id="logout-btn" class="auth-form button">Log Out</button>
            </div>
        </div>

        <div id="bottom-nav">
            <div class="nav-item active" data-view="matching-view">
                <span class="material-icons">favorite</span>
                <span>Match</span>
            </div>
            <div class="nav-item" data-view="inbox-view">
                <span class="material-icons">chat</span>
                <span>Duos</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Your Keys) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
            authDomain: "duoup-cfae6.firebaseapp.com",
            projectId: "duoup-cfae6",
            storageBucket: "duoup-cfae6.firebasestorage.app",
            messagingSenderId: "812263060524",
            appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
            measurementId: "G-46B67F90FK"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- 2. GLOBAL STATE ---
        let currentUserId = null; 
        let isSigningUp = true; 
        let cards = [];
        let currentIndex = 0;
        let currentChatPartnerId = null;
        let currentChatPartnerUsername = '';
        let unsubscribeMessages = null;
        let unsubscribeChats = null;
        let chatPartnersData = {}; // Cache partner data

        // --- 3. CORE DOM ELEMENTS ---
        const bottomNavEl = document.getElementById('bottom-nav');
        const topBarEl = document.getElementById('top-bar');
        const desktopNavEl = document.getElementById('desktop-nav'); 
        const chatPromptEl = document.getElementById('chat-prompt'); 

        // Auth elements
        const authViewEl = document.getElementById('auth-view');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMainBtn = document.getElementById('auth-main-btn');
        const toggleAuthBtn = document.getElementById('toggle-auth-btn');
        const authMessageEl = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');

        // Match elements
        const cardStackEl = document.getElementById('card-stack');
        const requestBtn = document.getElementById('request-btn');
        const skipBtn = document.getElementById('skip-btn');

        // Chat elements
        const inboxViewEl = document.getElementById('inbox-view');
        const singleChatViewEl = document.getElementById('single-chat-view');
        const messagesListEl = document.getElementById('messages-list');
        const messageFormEl = document.getElementById('message-form');
        const messageInputEl = document.getElementById('message-input');
        const chatListEl = document.getElementById('chat-list');
        const chatBackBtn = document.getElementById('chat-back-btn');
        const chatPartnerNameEl = document.getElementById('chat-partner-name');

        // Edit form elements
        const editUsernameInput = document.getElementById('edit-username');
        const editBioInput = document.getElementById('edit-bio');
        const editImgUrlInput = document.getElementById('edit-imgurl');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const profileMessageEl = document.getElementById('profile-message');
        const editGameSelect = document.getElementById('edit-game');
        const editRoleInput = document.getElementById('edit-role');
        const editSkillInput = document.getElementById('edit-skill');
        const editPlatformInput = document.getElementById('edit-platform');
        const editVibeInput = document.getElementById('edit-vibe'); 
        const updateCardBtn = document.getElementById('update-card-btn');
        const cardMessageEl = document.getElementById('card-message');

        // --- 4. NAVIGATION / UI HELPERS ---
        
        function isDesktop() {
            return window.matchMedia("(min-width: 768px)").matches;
        }

        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => {
                view.style.display = 'none';
            });
            
            const activeView = document.getElementById(viewId);
            activeView.style.display = isDesktop() && viewId !== 'inbox-view' ? 'block' : 'flex';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewId) {
                    item.classList.add('active');
                }
            });

            if (viewId === 'matching-view') {
                if (cards.length === 0 || currentIndex >= cards.length) fetchGamerCards();
            }
            if (viewId === 'inbox-view') {
                fetchChatList();
                if (!isDesktop()) { // Mobile: Show list, hide chat
                    singleChatViewEl.style.display = 'none';
                    document.getElementById('message-panel').style.display = 'block';
                    chatPromptEl.style.display = 'block';
                } else { // Desktop: Show list panel
                    document.getElementById('message-panel').style.display = 'flex';
                }
            }
            if (viewId === 'profile-view') loadProfileEditData();
            
            if (!isDesktop() && viewId !== 'inbox-view') {
                singleChatViewEl.style.display = 'none';
            }
        }

        function attachNavListeners() {
            [bottomNavEl, desktopNavEl].forEach(nav => {
                nav.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.nav-item');
                    if (navItem) switchView(navItem.dataset.view);
                });
            });
        }
        attachNavListeners();

        // --- 5. AUTHENTICATION LOGIC ---

        function updateAuthUI() {
            authMainBtn.textContent = isSigningUp ? 'Sign Up' : 'Log In';
            toggleAuthBtn.textContent = isSigningUp 
                ? 'Already have an account? Log In' 
                : 'Need an account? Sign Up';
            authMessageEl.textContent = '';
        }
        toggleAuthBtn.addEventListener('click', () => { isSigningUp = !isSigningUp; updateAuthUI(); });

        authMainBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessageEl.textContent = '';
            
            if (!email || password.length < 6) {
                authMessageEl.textContent = 'Please enter a valid email and a password of at least 6 characters.'; return;
            }

            try {
                if (isSigningUp) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createInitialUserDocument(userCredential.user.uid, email);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                authMessageEl.textContent = 'Error: ' + error.message;
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            window.location.reload(); // Hard refresh to clear all listeners and state
        });

        // Initial setup for new user using your schema
        async function createInitialUserDocument(uid, email) {
            const userRef = db.collection('users').doc(uid);
            const defaultUsername = email.split('@')[0];
            
            await userRef.set({
                email: email, 
                username: defaultUsername, 
                bio: '',
                profileImageUrl: 'https://via.placeholder.com/150', 
                isPremium: false,
                status: 'online', 
                fcmToken: '',     
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('gamerCards').add({
                userId: uid, 
                description: 'Just looking for new teammates!', 
                gameSlug: 'valorant',
                inGameRole: 'Flex', 
                skillLevel: 'Silver', 
                platform: 'PC', 
                vibe: 'Casual',
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // --- AUTH STATE HANDLER ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                
                if (isDesktop()) {
                    desktopNavEl.style.display = 'flex';
                    topBarEl.style.display = 'none';
                    bottomNavEl.style.display = 'none';
                } else {
                    desktopNavEl.style.display = 'none';
                    topBarEl.style.display = 'flex';
                    bottomNavEl.style.display = 'flex';
                }
                
                authViewEl.style.display = 'none';
                // Redirects to matching view on sign in/up
                switchView('matching-view'); 

            } else {
                currentUserId = null;
                topBarEl.style.display = 'none';
                bottomNavEl.style.display = 'none';
                desktopNavEl.style.display = 'none';
                authViewEl.style.display = 'flex';
                
                document.querySelectorAll('.app-view').forEach(view => {
                    if (view.id !== 'auth-view') view.style.display = 'none';
                });
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeChats) unsubscribeChats();
                updateAuthUI();
            }
        });

        // --- 6. PROFILE EDITING LOGIC ---
        let currentGamerCardId = null;

        async function loadProfileEditData() {
            if (!currentUserId) return;
            profileMessageEl.textContent = 'Loading...';
            cardMessageEl.textContent = '';

            try {
                // Load User Profile
                const userDoc = await db.collection('users').doc(currentUserId).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    editUsernameInput.value = data.username || '';
                    editBioInput.value = data.bio || ''; 
                    editImgUrlInput.value = data.profileImageUrl || '';
                }

                // Load Gamer Card
                const cardQuery = await db.collection('gamerCards')
                    .where('userId', '==', currentUserId)
                    .where('isActive', '==', true)
                    .limit(1).get();

                if (!cardQuery.empty) {
                    const cardDoc = cardQuery.docs[0];
                    const data = cardDoc.data();
                    currentGamerCardId = cardDoc.id;

                    editGameSelect.value = data.gameSlug || 'valorant';
                    editRoleInput.value = data.inGameRole || '';
                    editSkillInput.value = data.skillLevel || '';
                    editPlatformInput.value = data.platform || '';
                    editVibeInput.value = data.vibe || '';
                }
                profileMessageEl.textContent = 'Data loaded.';
            } catch (error) {
                profileMessageEl.textContent = 'Error loading data.';
            }
        }

        updateProfileBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            try {
                await db.collection('users').doc(currentUserId).update({
                    username: editUsernameInput.value, 
                    bio: editBioInput.value, 
                    profileImageUrl: editImgUrlInput.value
                });
                profileMessageEl.textContent = 'Profile updated successfully!';
                
                // Also update the description in the gamerCard based on the new bio
                if (currentGamerCardId) {
                    await db.collection('gamerCards').doc(currentGamerCardId).update({
                        description: editBioInput.value
                    });
                }
            } catch (error) {
                profileMessageEl.textContent = 'Update failed: ' + error.message;
            }
        });

        updateCardBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentGamerCardId) return;
            try {
                await db.collection('gamerCards').doc(currentGamerCardId).update({
                    gameSlug: editGameSelect.value, 
                    inGameRole: editRoleInput.value,
                    skillLevel: editSkillInput.value, 
                    platform: editPlatformInput.value,
                    vibe: editVibeInput.value,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                cardMessageEl.textContent = 'Gamer Card updated successfully!';
                // Fetch new cards if settings change
                fetchGamerCards(); 
            } catch (error) {
                cardMessageEl.textContent = 'Update failed: ' + error.message;
            }
        });


        // --- 7. MATCH FEED LOGIC ---
        
        // Fetches user data for a given card's userId and merges it into the card object
        async function hydrateCardData(card) {
            if (!card.userId) return card;
            try {
                const userDoc = await db.collection('users').doc(card.userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    return {
                        ...card,
                        username: userData.username,
                        profileImageUrl: userData.profileImageUrl,
                        bio: userData.bio || card.description,
                    };
                }
            } catch (e) {
                console.error("Error hydrating card data:", e);
            }
            return card;
        }

        async function fetchGamerCards() {
            if (!currentUserId) return;
            skipBtn.disabled = true;
            requestBtn.disabled = true;
            cardStackEl.innerHTML = '<div class="loading">Finding Duos...</div>';
            
            // Get user's own card settings (defaulting to Valorant)
            const userCardQuery = await db.collection('gamerCards').where('userId', '==', currentUserId).limit(1).get();
            const userGameSlug = userCardQuery.empty ? 'valorant' : userCardQuery.docs[0].data().gameSlug;

            const cardsRef = db.collection('gamerCards');
            
            // Query for cards based on the current user's active game
            // (Assumes a composite index on: gamerCards collection, fields: gameSlug, isActive)
            const q = cardsRef
                .where('gameSlug', '==', userGameSlug) 
                .where('isActive', '==', true)     
                .limit(10); 

            try {
                const querySnapshot = await q.get();
                const rawCards = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(card => card.userId !== currentUserId); // Filter out own card

                // Hydrate cards with user profile data
                const hydrationPromises = rawCards.map(hydrateCardData);
                cards = await Promise.all(hydrationPromises);
                
                currentIndex = 0;
                renderCurrentCard();
            } catch (error) {
                cardStackEl.innerHTML = `<p style="color: #ff4560;">Error: Failed to load cards. Check console and Firebase indexes.</p>`;
                console.error("Fetch Cards Error:", error);
            }
        }

        function renderCurrentCard() {
            if (cards.length === 0 || currentIndex >= cards.length) {
                cardStackEl.innerHTML = '<h2>No more Duos found!</h2><p>Try refreshing or updating your Gamer Card settings.</p>';
                skipBtn.disabled = true;
                requestBtn.disabled = true;
                return;
            }
            
            const cardData = cards[currentIndex];
            const newCardEl = document.createElement('div');
            newCardEl.className = 'gamer-card';
            newCardEl.dataset.targetUserId = cardData.userId;
            
            const username = cardData.username || 'Gamer';
            const profileImg = cardData.profileImageUrl || 'https://via.placeholder.com/150';
            const description = cardData.bio || cardData.description || 'No description provided.'; 
            
            newCardEl.innerHTML = `
                <div class="card-header">
                    <img src="${profileImg}" alt="Profile" class="profile-img">
                    <h2 class="username">${username}</h2>
                </div>
                <div class="game-details">
                    <div class="game-info">
                        <h3>${cardData.gameSlug ? cardData.gameSlug.toUpperCase().replace('_', ' ') : 'UNKNOWN GAME'}</h3>
                        <span class="tag role">ROLE: ${cardData.inGameRole || 'Any'}</span>
                        <span class="tag rank">RANK: ${cardData.skillLevel || 'Casual'}</span>
                    </div>
                </div>
                <div class="card-bio">
                    <p>${description}</p>
                    <span class="tag platform">${cardData.platform || 'Unknown Platform'}</span>
                    <span class="tag vibe">#${cardData.vibe || 'Neutral'}</span>
                </div>
            `;
            cardStackEl.innerHTML = '';
            cardStackEl.appendChild(newCardEl);
            skipBtn.disabled = false;
            requestBtn.disabled = false;
        }

        // --- FIX: Complete swipeCard function ---
        async function swipeCard(action) {
            const currentCardEl = document.querySelector('.gamer-card');
            if (!currentCardEl) return;
            
            const targetUserId = currentCardEl.dataset.targetUserId;
            let translateX = (action === 'request') ? '500px' : '-500px';

            currentCardEl.style.transform = `translateX(${translateX}) rotate(${action === 'request' ? '10deg' : '-10deg'})`;
            currentCardEl.style.opacity = '0';

            // Log the swipe action
            await db.collection('swipes').add({
                swiperId: currentUserId,
                targetId: targetUserId,
                action: action, // 'request' or 'skip'
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (action === 'request') {
                await sendDuoRequest(targetUserId);
            }

            // Move to the next card after the animation
            setTimeout(() => {
                currentIndex++;
                renderCurrentCard();
            }, 500);
        }

        async function sendDuoRequest(targetId) {
            // Check if the target user has already requested a duo with the current user
            const reverseSwipe = await db.collection('swipes')
                .where('swiperId', '==', targetId)
                .where('targetId', '==', currentUserId)
                .where('action', '==', 'request')
                .limit(1).get();

            if (!reverseSwipe.empty) {
                // IT'S A MATCH! Create a chat room and a match notification
                const chatRoomRef = db.collection('chats').add({
                    users: [currentUserId, targetId].sort(),
                    lastMessage: `You matched with ${cards[currentIndex].username}! Say hello.`,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    matchTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`It's a Duo! You matched with ${cards[currentIndex].username}. Check your Duos tab.`);
            } else {
                alert(`Duo Request sent to ${cards[currentIndex].username}!`);
            }
        }
        
        skipBtn.addEventListener('click', () => swipeCard('skip'));
        requestBtn.addEventListener('click', () => swipeCard('request'));


        // --- 8. INBOX / CHAT LOGIC ---

        // Fetches list of active chats/duos
        function fetchChatList() {
            if (unsubscribeChats) unsubscribeChats();

            // Listen for changes in chats where the current user is involved
            unsubscribeChats = db.collection('chats')
                .where('users', 'array-contains', currentUserId)
                .orderBy('lastUpdated', 'desc')
                .onSnapshot(async snapshot => {
                    chatListEl.innerHTML = '';
                    
                    if (snapshot.empty) {
                        chatListEl.innerHTML = '<p style="text-align: center; color: #a0a0b0;">You have no active Duos. Go find a match!</p>';
                        return;
                    }

                    const chatDocs = snapshot.docs;
                    const partnerIds = chatDocs.map(doc => doc.data().users.find(uid => uid !== currentUserId));
                    
                    // Batch fetch partner profile data
                    await fetchChatPartnerProfiles(partnerIds);

                    chatDocs.forEach(doc => {
                        const chat = doc.data();
                        const partnerId = chat.users.find(uid => uid !== currentUserId);
                        const partner = chatPartnersData[partnerId] || { username: 'Unknown Duo', profileImageUrl: 'https://via.placeholder.com/50' };

                        const item = document.createElement('div');
                        item.className = 'chat-list-item';
                        item.dataset.chatId = doc.id;
                        item.dataset.partnerId = partnerId;
                        item.innerHTML = `
                            <img src="${partner.profileImageUrl}" alt="Profile" class="profile-img" style="width: 40px; height: 40px; margin-right: 10px; border: none;">
                            <div>
                                <strong>${partner.username}</strong>
                                <p style="margin: 0; font-size: 0.85em; color: #a0a0b0;">${chat.lastMessage || 'Start the conversation!'}</p>
                            </div>
                        `;
                        item.onclick = () => openChat(doc.id, partnerId, partner.username);
                        chatListEl.appendChild(item);
                    });
                }, error => {
                    console.error("Error listening to chats:", error);
                    chatListEl.innerHTML = '<p style="text-align: center; color: #ff4560;">Error loading chats.</p>';
                });
        }
        
        // Caches partner data to avoid repeated reads
        async function fetchChatPartnerProfiles(partnerIds) {
            const uniquePartnerIds = [...new Set(partnerIds)];
            const missingIds = uniquePartnerIds.filter(id => !chatPartnersData[id]);
            
            if (missingIds.length === 0) return;

            // Firestore does not allow `where('id', 'in', ...)` with more than 10 items. 
            // We'll iterate for simplicity in this small app.
            const userPromises = missingIds.map(id => db.collection('users').doc(id).get());
            const userDocs = await Promise.all(userPromises);

            userDocs.forEach(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    chatPartnersData[doc.id] = {
                        username: data.username,
                        profileImageUrl: data.profileImageUrl
                    };
                }
            });
        }


        function openChat(chatId, partnerId, partnerUsername) {
            currentChatPartnerId = partnerId;
            currentChatPartnerUsername = partnerUsername;
            
            // Mobile: Hide chat list, show single chat view
            if (!isDesktop()) {
                document.getElementById('chat-list-panel').style.display = 'none';
                singleChatViewEl.style.display = 'flex';
                document.querySelector('.chat-header').style.display = 'flex';
            } else {
                // Desktop: Show single chat view in the message panel
                singleChatViewEl.style.display = 'flex';
                chatPromptEl.style.display = 'none';
            }
            
            chatPartnerNameEl.textContent = `Chat with ${partnerUsername}`;

            // Remove any previous listener
            if (unsubscribeMessages) unsubscribeMessages();

            // Set up new real-time listener for messages
            unsubscribeMessages = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    messagesListEl.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        renderMessage(doc.data());
                    });
                    messagesListEl.scrollTop = messagesListEl.scrollHeight; // Auto-scroll to bottom
                }, error => {
                    console.error("Error listening to messages:", error);
                });
        }
        
        chatBackBtn.addEventListener('click', () => {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChatPartnerId = null;
            singleChatViewEl.style.display = 'none';
            document.getElementById('chat-list-panel').style.display = 'block';
        });

        messageFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInputEl.value.trim();
            if (!text || !currentChatPartnerId) return;

            // Find the chat ID again (safer than relying on a global var)
            const chatQuery = await db.collection('chats')
                .where('users', 'array-contains', currentUserId).get();
            
            const chatDoc = chatQuery.docs.find(doc => doc.data().users.includes(currentChatPartnerId));
            
            if (!chatDoc) {
                alert("Error: Chat room not found.");
                return;
            }

            const chatId = chatDoc.id;

            try {
                // 1. Add message to subcollection
                await db.collection('chats').doc(chatId).collection('messages').add({
                    senderId: currentUserId,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update parent chat document for last message/sorting
                await db.collection('chats').doc(chatId).update({
                    lastMessage: text,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                messageInputEl.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message.");
            }
        });


        function renderMessage(message) {
            const time = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';
            const isSent = message.senderId === currentUserId;
            
            const msgEl = document.createElement('div');
            msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
            msgEl.innerHTML = `${message.text}<span class="message-time">${time}</span>`;
            messagesListEl.appendChild(msgEl);
        }

    </script>

</body>
</html>
