<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DUO UP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Orbitron;background:#0b0b0b;color:white}
.hidden{display:none}
.container{width:90%;margin:auto;padding:20px}
.neon-btn{
  border:2px solid cyan;
  background:transparent;
  color:white;
  padding:8px 14px;
  margin:5px;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 0 10px cyan;
}
.neon-btn:hover{border-color:magenta;box-shadow:0 0 15px magenta}
.card{
  width:260px;
  padding:15px;
  border:2px solid cyan;
  border-radius:14px;
  background:#111;
  box-shadow:0 0 10px cyan;
}
.flex{display:flex;gap:15px;flex-wrap:wrap}
.avatar{
  width:48px;height:48px;border-radius:50%;
  border:2px solid cyan;object-fit:cover
}
.user{display:flex;gap:10px;align-items:center}
input{width:100%;padding:8px;margin:5px 0;background:#000;border:2px solid cyan;color:white;border-radius:6px}
</style>
</head>

<body>

<div id="login" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="login()">Login with Google</button>
</div>

<div id="usernamePage" class="container hidden">
  <h2>Choose Username</h2>
  <input id="usernameInput">
  <button class="neon-btn" onclick="saveUsername()">Continue</button>
</div>

<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>

  <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
  <button class="neon-btn" onclick="showTab('requests')">Requests</button>
  <button class="neon-btn" onclick="showTab('friends')">Friends</button>
  <button class="neon-btn" onclick="openProfile()">Profile</button>
  <button class="neon-btn" onclick="logout()">Logout</button>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
</div>

<div id="profile" class="container hidden">
  <h2>Edit Profile</h2>
  <img id="preview" class="avatar"><br>
  <input type="file" id="image">
  <input id="statusInput" placeholder="Status">
  <button class="neon-btn" onclick="saveProfile()">Save</button>
  <button class="neon-btn" onclick="closeProfile()">Back</button>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

const DEFAULT_AVATAR="https://www.shutterstock.com/image-vector/default-avatar-profile-icon-social-600nw-1677509740.jpg";

auth.onAuthStateChanged(user=>{
  if(!user) return;
  db.collection("users").doc(user.uid).get().then(d=>{
    if(d.exists) loadDashboard(d.data());
    else usernamePage.classList.remove("hidden");
  });
});

function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function logout(){ auth.signOut(); location.reload(); }

function saveUsername(){
  const u=auth.currentUser;
  db.collection("users").doc(u.uid).set({
    nickname:usernameInput.value,
    profileImageUrl:u.photoURL||DEFAULT_AVATAR,
    status:"Online",
    friends:[]
  }).then(()=>location.reload());
}

function loadDashboard(data){
  login.classList.add("hidden");
  usernamePage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  welcome.innerText="Welcome, "+data.nickname;
  loadSuggested(); loadRequests(); loadFriends();
}

function showTab(t){
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(t+"Tab").classList.remove("hidden");
}

function loadSuggested(){
  suggestedTab.innerHTML="";
  db.collection("users").get().then(s=>{
    s.forEach(u=>{
      if(u.id===auth.currentUser.uid) return;
      const d=u.data();
      suggestedTab.innerHTML+=`
      <div class="card">
        <div class="user">
          <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${d.nickname}</strong>
        </div>
        <button class="neon-btn" onclick="sendRequest('${u.id}')">DUO UP</button>
      </div>`;
    });
  });
}

function sendRequest(id){
  db.collection("friendRequests").add({
    senderId:auth.currentUser.uid,
    receiverId:id,
    status:"pending",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadRequests(){
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(s=>{
      requestsTab.innerHTML="";
      s.forEach(r=>{
        db.collection("users").doc(r.data().senderId).get().then(u=>{
          requestsTab.innerHTML+=`
          <div class="card">
            ${u.data().nickname}
            <button class="neon-btn" onclick="accept('${r.id}','${u.id}')">Accept</button>
          </div>`;
        });
      });
    });
}

function accept(id,sender){
  db.collection("friendRequests").doc(id).update({status:"accepted"});
  db.collection("users").doc(auth.currentUser.uid)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(sender)});
  db.collection("users").doc(sender)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)});
}

function loadFriends(){
  db.collection("users").doc(auth.currentUser.uid)
    .onSnapshot(d=>{
      friendsTab.innerHTML="";
      d.data().friends.forEach(f=>{
        db.collection("users").doc(f).get().then(u=>{
          friendsTab.innerHTML+=`
          <div class="card">${u.data().nickname}</div>`;
        });
      });
    });
}

function openProfile(){
  dashboard.classList.add("hidden");
  profile.classList.remove("hidden");
  db.collection("users").doc(auth.currentUser.uid).get().then(d=>{
    preview.src=d.data().profileImageUrl||DEFAULT_AVATAR;
    statusInput.value=d.data().status||"";
  });
}

function closeProfile(){
  profile.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function saveProfile(){
  const file=image.files[0];
  if(file){
    const ref=storage.ref("avatars/"+auth.currentUser.uid);
    ref.put(file).then(()=>ref.getDownloadURL().then(url=>{
      updateProfile(url);
    }));
  }else updateProfile(null);
}

function updateProfile(url){
  const data={status:statusInput.value};
  if(url) data.profileImageUrl=url;
  db.collection("users").doc(auth.currentUser.uid).update(data).then(closeProfile);
}
</script>
</body>
</html>
