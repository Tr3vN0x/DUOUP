<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO Up</title>

<link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Orbitron',sans-serif;
  background:linear-gradient(270deg,#0d0d0d,#1a1a1a,#0d0d0d);
  background-size:600% 600%;
  animation:bg 15s ease infinite;
  color:white;
}
@keyframes bg{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.hidden{display:none}
.neon-btn{
  background:transparent;
  border:2px solid #00ffff;
  color:white;
  padding:8px 16px;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 0 10px #00ffff;
}
.neon-btn:hover{
  border-color:#ff00ff;
  box-shadow:0 0 15px #ff00ff;
}
input{
  background:transparent;
  border:2px solid #00ffff;
  color:white;
  padding:8px;
  border-radius:6px;
  width:100%;
}
.container{padding:20px}
.flex{display:flex;gap:20px;flex-wrap:wrap}
.card{
  background:#111;
  border:2px solid #00ffff;
  border-radius:16px;
  padding:15px;
  width:260px;
  box-shadow:0 0 15px #00ffff;
}
.card:hover{
  border-color:#ff00ff;
  box-shadow:0 0 20px #ff00ff;
}
.user{
  display:flex;
  gap:10px;
  align-items:center;
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  border:2px solid #00ffff;
  object-fit:cover;
}
.badge{
  font-size:10px;
  color:#ffd700;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="login()">Login with Google</button>
</div>

<!-- USERNAME PICK (ONE TIME) -->
<div id="usernamePage" class="container hidden">
  <h2>Pick Your Username</h2>
  <input id="usernameInput" placeholder="Username (permanent)">
  <br><br>
  <button class="neon-btn" onclick="saveUsername()">Continue</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <div class="header">
    <h2 id="welcome"></h2>
    <div>
      <button class="neon-btn" onclick="openProfile()">Profile</button>
      <button class="neon-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <h3>Friend Requests</h3>
  <div id="friendRequests" class="flex"></div>

  <h3>Suggested Duos</h3>
  <div id="suggested" class="flex"></div>
</div>

<!-- PROFILE EDITOR -->
<div id="profileEditor" class="container hidden">
  <h2>Profile</h2>

  <p><strong>Username:</strong> <span id="lockedUsername"></span></p>

  <img id="preview" class="avatar"><br><br>
  <input type="file" id="file"><br><br>

  <input id="editStatus" placeholder="Status"><br><br>

  <button class="neon-btn" onclick="saveProfile()">Save</button>
  <button class="neon-btn" onclick="closeProfile()">Cancel</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app"
});

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

/* AUTH */

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    usernamePage.classList.add("hidden");
    return;
  }

  db.collection("users").doc(user.uid).get().then(doc=>{
    if(doc.exists){
      loadDashboard();
    }else{
      loginPage.classList.add("hidden");
      usernamePage.classList.remove("hidden");
    }
  });
});

/* USERNAME (ONE TIME ONLY) */

function saveUsername(){
  const user=auth.currentUser;
  const name=usernameInput.value.trim();
  if(!name) return;

  db.collection("users").doc(user.uid).set({
    uid:user.uid,
    nickname:name,
    email:user.email,
    profileImageUrl:user.photoURL||"",
    status:"online",
    isPremium:false,
    friends:[],
    lastActive:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>loadDashboard());
}

/* DASHBOARD (LIVE SYNC) */

function loadDashboard(){
  loginPage.classList.add("hidden");
  usernamePage.classList.add("hidden");
  dashboard.classList.remove("hidden");

  db.collection("users").doc(auth.currentUser.uid)
  .onSnapshot(doc=>{
    const u=doc.data();
    welcome.innerText="Welcome "+u.nickname;
    loadSuggested();
    loadRequests();
  });
}

/* PROFILE */

function openProfile(){
  profileEditor.classList.remove("hidden");

  db.collection("users").doc(auth.currentUser.uid).get().then(doc=>{
    const u=doc.data();
    lockedUsername.innerText=u.nickname;
    editStatus.value=u.status||"";
    preview.src=u.profileImageUrl||"";
  });
}

function closeProfile(){
  profileEditor.classList.add("hidden");
}

file.onchange=e=>{
  const r=new FileReader();
  r.onload=x=>preview.src=x.target.result;
  r.readAsDataURL(e.target.files[0]);
};

function saveProfile(){
  const uid=auth.currentUser.uid;
  const f=file.files[0];

  if(f){
    storage.ref("avatars/"+uid).put(f)
    .then(s=>s.ref.getDownloadURL())
    .then(url=>updateProfile(url));
  }else{
    updateProfile(preview.src);
  }
}

function updateProfile(url){
  db.collection("users").doc(auth.currentUser.uid).update({
    status:editStatus.value,
    profileImageUrl:url,
    lastActive:firebase.firestore.FieldValue.serverTimestamp()
  }).then(closeProfile);
}

/* SUGGESTED DUOS */

function loadSuggested(){
  suggested.innerHTML="";
  db.collection("users").get().then(snap=>{
    snap.forEach(doc=>{
      if(doc.id===auth.currentUser.uid) return;
      const u=doc.data();
      suggested.innerHTML+=`
      <div class="card">
        <div class="user">
          <img class="avatar" src="${u.profileImageUrl||''}">
          <div>
            <strong>${u.nickname}</strong>
            ${u.isPremium?'<span class="badge">â˜…</span>':''}
            <div>${u.status}</div>
          </div>
        </div>
        <br>
        <button class="neon-btn" onclick="sendRequest('${doc.id}')">DUO UP</button>
      </div>`;
    });
  });
}

/* FRIEND REQUESTS */

function sendRequest(id){
  db.collection("friendRequests").add({
    senderId:auth.currentUser.uid,
    receiverId:id,
    status:"pending",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadRequests(){
  friendRequests.innerHTML="";
  db.collection("friendRequests")
  .where("receiverId","==",auth.currentUser.uid)
  .where("status","==","pending")
  .get().then(snap=>{
    snap.forEach(doc=>{
      db.collection("users").doc(doc.data().senderId).get().then(u=>{
        friendRequests.innerHTML+=`
        <div class="card">
          <div class="user">
            <img class="avatar" src="${u.data().profileImageUrl||''}">
            <strong>${u.data().nickname}</strong>
          </div>
          <br>
          <button class="neon-btn" onclick="accept('${doc.id}')">Accept</button>
        </div>`;
      });
    });
  });
}

function accept(id){
  db.collection("friendRequests").doc(id).update({status:"accepted"});
  loadRequests();
}
</script>
</body>
</html>
