<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP - Friends</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; margin:auto; padding:20px; }
.hidden { display:none; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.flex { display:flex; gap:15px; flex-wrap:wrap; }
.card { width:260px; padding:15px; border:2px solid cyan; border-radius:14px; background:#111; box-shadow:0 0 10px cyan; }
.avatar { width:48px; height:48px; border-radius:50%; border:2px solid cyan; object-fit:cover; }
.user { display:flex; gap:10px; align-items:center; }
.status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-left:5px; border:2px solid #0b0b0b; }
.input { width:100%; padding:8px; margin:5px 0; background:#000; border:2px solid cyan; color:white; border-radius:6px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
  <button class="neon-btn" onclick="showTab('requests')">Requests</button>
  <button class="neon-btn" onclick="showTab('friends')">Friends</button>
  <button class="neon-btn" onclick="logout()">Logout</button>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const suggestedTab = document.getElementById("suggestedTab");
const requestsTab = document.getElementById("requestsTab");
const friendsTab = document.getElementById("friendsTab");

// ---------------- LOGIN ----------------
function loginWithGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}

// ---------------- AUTH STATE ----------------
auth.onAuthStateChanged(async user => {
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");

  const userSnap = await db.collection("users").doc(user.uid).get();
  if(!userSnap.exists){
    await db.collection("users").doc(user.uid).set({
      uid: user.uid,
      nickname: user.displayName || "Player",
      email: user.email,
      friends: [],
      profileImageUrl: user.photoURL || DEFAULT_AVATAR,
      status: "online"
    });
  } else {
    db.collection("users").doc(user.uid).update({status:"online"});
  }
  welcome.innerText = "Welcome, " + (userSnap.data()?.nickname || user.displayName);

  loadSuggested();
  loadRequests();
  loadFriends();
});

// ---------------- LOGOUT ----------------
function logout(){
  const uid = auth.currentUser.uid;
  db.collection("users").doc(uid).update({status:"offline"}).then(()=> auth.signOut());
}

// ---------------- TABS ----------------
function showTab(tab){
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(tab+"Tab").classList.remove("hidden");
}

// ---------------- SUGGESTED USERS ----------------
function loadSuggested(){
  suggestedTab.innerHTML="";
  const currentUserId = auth.currentUser.uid;
  db.collection("users").get().then(snap => {
    snap.forEach(doc => {
      if(doc.id === currentUserId) return;
      db.collection("users").doc(currentUserId).get().then(me => {
        const friends = me.data().friends || [];
        if(friends.includes(doc.id)) return;

        // Check if a request already exists
        db.collection("friendRequests")
          .where("senderId","==",currentUserId)
          .where("receiverId","==",doc.id)
          .get().then(reqSnap=>{
            if(!reqSnap.empty) return; // Already requested
            const u = doc.data();
            const card = document.createElement("div");
            card.className="card";
            card.innerHTML=`<div class="user">
              <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
              <strong>${u.nickname}</strong>
            </div>
            <button class="neon-btn" onclick="sendRequest('${doc.id}')">DUO UP</button>`;
            suggestedTab.appendChild(card);
          });
      });
    });
  });
}

// ---------------- FRIEND REQUESTS ----------------
function loadRequests(){
  requestsTab.innerHTML="";
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(snap => {
      if(snap.empty){ requestsTab.innerHTML="<p>No requests</p>"; }
      snap.forEach(r => {
        db.collection("users").doc(r.data().senderId).get().then(u => {
          const d = u.data();
          const card = document.createElement("div");
          card.className="card";
          card.innerHTML=`<div class="user">
            <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
            <strong>${d.nickname}</strong>
          </div>
          <button class="neon-btn" onclick="acceptRequest('${r.id}','${u.id}')">Accept</button>
          <button class="neon-btn" onclick="rejectRequest('${r.id}')">Reject</button>`;
          requestsTab.appendChild(card);
        });
      });
    });
}

function sendRequest(id){
  db.collection("friendRequests").add({
    senderId: auth.currentUser.uid,
    receiverId: id,
    status: "pending",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>alert("Request sent!"));
}

function acceptRequest(rid, sender){
  db.collection("friendRequests").doc(rid).update({status:"accepted"});
  db.collection("users").doc(auth.currentUser.uid)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(sender)});
  db.collection("users").doc(sender)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)});
  loadFriends();
}

function rejectRequest(id){
  db.collection("friendRequests").doc(id).update({status:"rejected"});
}

// ---------------- FRIENDS ----------------
function loadFriends(){
  const userRef = db.collection("users").doc(auth.currentUser.uid);
  userRef.onSnapshot(doc => {
    friendsTab.innerHTML = "";
    const friends = doc.data().friends || [];
    if(friends.length === 0){ friendsTab.innerHTML="<p>No friends yet</p>"; return; }
    friends.forEach(fid => {
      db.collection("users").doc(fid).get().then(u => {
        const d = u.data();
        const avatar = d.profileImageUrl||DEFAULT_AVATAR;
        const statusColor = d.status === "online" ? "green" : "gray";
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<div class="user">
          <img class="avatar" src="${avatar}">
          <strong>${d.nickname}</strong>
          <span class="status-dot" style="background:${statusColor}"></span>
        </div>`;
        friendsTab.appendChild(card);
      });
    });
  });
}
</script>
</body>
</html>
