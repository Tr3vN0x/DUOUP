<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDoc, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain: "duoup-cfae6.firebaseapp.com",
  projectId: "duoup-cfae6",
  storageBucket: "duoup-cfae6.appspot.com",
  messagingSenderId: "812263060524",
  appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
  measurementId: "G-46B67F90FK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

// Globals
let activeChatId = "";
let activeFriendUid = "";

// --- AUTH ---
const signinForm = document.getElementById("signin");
const signupForm = document.getElementById("signup");
const googleBtn = document.querySelector(".google-btn");
const authSection = document.getElementById("auth-section");
const appSection = document.getElementById("app-section");
const mainHeader = document.getElementById("mainHeader");
const logoutBtn = document.getElementById("logoutBtnHeader");

signinForm.addEventListener("submit", async e=>{
  e.preventDefault();
  try { await signInWithEmailAndPassword(auth,
    document.getElementById("signin-email").value,
    document.getElementById("signin-password").value
  ); } catch(err){ alert(err.message); }
});

signupForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const email = document.getElementById("signup-email").value;
  const password = document.getElementById("signup-password").value;
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,"users",userCredential.user.uid),{
      uid:userCredential.user.uid,
      username:"New Player",
      email,
      platform:"",
      games:"",
      playstyle:"",
      about:"",
      photoURL:"",
      mic:"",
      timestamp:serverTimestamp()
    });
  } catch(err){ alert(err.message); }
});

googleBtn.addEventListener("click", async ()=>{ try{await signInWithPopup(auth,provider);} catch(err){alert(err.message);} });
logoutBtn.addEventListener("click", async ()=>{ await signOut(auth); });

// --- PROFILE ---
async function updateProfile(){
  const user = auth.currentUser; if(!user) return;
  const username = document.getElementById("profile-username").value;
  const platform = document.getElementById("profile-platform").value;
  const games = document.getElementById("profile-games").value;
  const playstyle = document.getElementById("profile-playstyle").value;
  const about = document.getElementById("profile-about").value;
  const file = document.getElementById("profile-photo").files[0];
  let photoURL="";
  if(file){
    const storageRef = ref(storage,`profiles/${user.uid}`);
    await uploadBytes(storageRef,file);
    photoURL = await getDownloadURL(storageRef);
  }
  await updateDoc(doc(db,"users",user.uid),{username,platform,games,playstyle,about,photoURL});
  alert("Profile updated!");
}

async function loadProfile(){
  const user = auth.currentUser; if(!user) return;
  const docSnap = await getDoc(doc(db,"users",user.uid));
  if(docSnap.exists()){
    const data = docSnap.data();
    document.getElementById("profile-username").value = data.username || "";
    document.getElementById("profile-platform").value = data.platform || "";
    document.getElementById("profile-games").value = data.games || "";
    document.getElementById("profile-playstyle").value = data.playstyle || "";
    document.getElementById("profile-about").value = data.about || "";
  }
}

// --- SECTIONS ---
function showSection(section){
  ["home","profile","messages"].forEach(s=>{
    document.getElementById(s+"-section").style.display="none";
  });
  document.getElementById(section+"-section").style.display="block";
  if(section==="profile") loadProfile();
}

// --- USERS / DUO SEARCH ---
const usersGrid = document.getElementById("usersGrid");
async function loadUsers(){
  const q = query(collection(db,"users"));
  onSnapshot(q,snapshot=>{
    usersGrid.innerHTML="";
    snapshot.forEach(docSnap=>{
      if(docSnap.id===auth.currentUser.uid) return;
      const u = docSnap.data();
      // Check if required fields exist before rendering button
      const isComplete = u.username && u.platform && u.games; 
      const buttonHtml = isComplete 
        ? `<button class="action-button" onclick="sendDuoRequest('${docSnap.id}','${u.username}')">Send Duo Request</button>`
        : `<button class="action-button" disabled style="background:#80809C;">Profile Incomplete</button>`;

      const div = document.createElement("div");
      div.className="duo-card";
      div.innerHTML=`<div class="card-header">
        <div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:u.username[0]}</div>
        <strong>${u.username}</strong>
      </div>
      <div class="bio">Platform: ${u.platform||'N/A'}<br>Games: ${u.games||'N/A'}<br>Playstyle: ${u.playstyle||'N/A'}</div>
      ${buttonHtml}`;
      usersGrid.appendChild(div);
    });
  });
}

async function sendDuoRequest(toUid,toUsername){
  const fromUid = auth.currentUser.uid;
  const fromDoc = await getDoc(doc(db,"users",fromUid));
  const fromUsername = fromDoc.data().username;
  await addDoc(collection(db,"duoRequests"),{
    fromUserId:fromUid,
    fromUsername,
    toUserId:toUid,
    toUsername, // Added toUsername here for easier loading of accepted duos
    status:"pending",
    timestamp:serverTimestamp()
  });
  alert("Duo request sent!");
}

// --- DUO REQUESTS / MESSAGES ---
const requestsGrid = document.getElementById("requestsGrid");
const duosGrid = document.getElementById("duosGrid");

function loadDuoRequests(){
  const user = auth.currentUser;
  const duosMap = new Map(); // Use a map to prevent duplicate rendering of accepted duos

  // 1. Pending Requests (where I am the recipient)
  const q1 = query(collection(db,"duoRequests"),where("toUserId","==",user.uid),where("status","==","pending"));
  onSnapshot(q1,snap=>{
    requestsGrid.innerHTML="";
    snap.forEach(docSnap=>{
      const r = docSnap.data();
      const div = document.createElement("div");
      div.className="duo-card duo-request-card";
      div.innerHTML=`<div class="card-header"><strong>${r.fromUsername}</strong></div>
        <button class="action-button" onclick="acceptDuo('${docSnap.id}')">Accept</button>`;
      requestsGrid.appendChild(div);
    });
  });

  // Function to handle accepted duos snapshot
  function renderAcceptedDuos(snap){
    snap.forEach(docSnap=>{
      const r = docSnap.data();
      const friendUid = r.fromUserId === user.uid ? r.toUserId : r.fromUserId;
      const friendUsername = r.fromUserId === user.uid ? r.toUsername : r.fromUsername;
      if(!duosMap.has(friendUid)) { // Only add if not already present
        duosMap.set(friendUid, { id: docSnap.id, username: friendUsername });
      }
    });
    // Re-render the whole accepted grid
    duosGrid.innerHTML = "";
    duosMap.forEach((duo, friendUid) => {
      const div = document.createElement("div");
      div.className="duo-card";
      div.innerHTML=`<div class="card-header"><strong>${duo.username}</strong></div>
        <button class="action-button" onclick="openChat('${friendUid}','${duo.username}')">Chat</button>`;
      duosGrid.appendChild(div);
    });
  }

  // 2. Accepted duos (I am the sender)
  const qSent = query(collection(db,"duoRequests"),where("fromUserId","==",user.uid),where("status","==","accepted"));
  onSnapshot(qSent, renderAcceptedDuos);

  // 3. Accepted duos (I am the recipient)
  const qReceived = query(collection(db,"duoRequests"),where("toUserId","==",user.uid),where("status","==","accepted"));
  onSnapshot(qReceived, renderAcceptedDuos);
}

async function acceptDuo(requestId){
  await updateDoc(doc(db,"duoRequests",requestId),{status:"accepted"});
}

// --- CHAT ---
const chatModal = document.getElementById("chatModal");
const chatHeader = document.getElementById("chatHeader");
const messageArea = document.getElementById("messageArea");
const chatInput = document.getElementById("chatInput");

function openChat(friendUid,friendUsername){
  activeChatId = [auth.currentUser.uid,friendUid].sort().join("_");
  activeFriendUid = friendUid;
  chatModal.style.display="flex";
  chatHeader.innerHTML = `<span class="status-dot"></span> Chatting with ${friendUsername}`;
  loadChat(activeChatId);
}

function closeChat(){ chatModal.style.display="none"; messageArea.innerHTML=""; }

function sendMessage(){
  const content = chatInput.value.trim();
  if(!content) return;
  addDoc(collection(db,"messages"),{
    content,
    fromUid:auth.currentUser.uid,
    toUid: activeFriendUid,
    duoId:activeChatId,
    timestamp:serverTimestamp()
  });
  chatInput.value="";
}

function loadChat(duoId){
  const q = query(collection(db,"messages"),where("duoId","==",duoId),orderBy("timestamp"));
  onSnapshot(q,snap=>{
    messageArea.innerHTML="";
    snap.forEach(docSnap=>{
      const m=docSnap.data();
      const div=document.createElement("div");
      div.className="message "+(m.fromUid===auth.currentUser.uid?"self":"other");
      div.innerHTML=`<div class="message-content">${m.content}</div>`;
      messageArea.appendChild(div);
    });
    messageArea.scrollTop = messageArea.scrollHeight;
  });
}

// --- AUTH STATE ---
onAuthStateChanged(auth,user=>{
  if(user){
    authSection.style.display="none";
    appSection.style.display="block";
    mainHeader.style.display="flex";
    loadUsers();
    loadDuoRequests();
  } else {
    authSection.style.display="flex";
    appSection.style.display="none";
    mainHeader.style.display="none";
  }
});

// --- EXPOSE FUNCTIONS TO GLOBAL WINDOW FOR HTML ONCLICK ---
window.updateProfile = updateProfile;
window.showSection = showSection;
window.sendDuoRequest = sendDuoRequest;
window.acceptDuo = acceptDuo;
window.openChat = openChat;
window.closeChat = closeChat;
window.sendMessage = sendMessage;

</script>
