<!DOCTYPE html>
<html>
<head>
  <title>DuoUp</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #appDiv { display: none; }
    input { margin: 5px; }
    button { margin: 5px; }
    .friend, .request { margin-bottom: 10px; }
    .message { border: 1px solid #ccc; padding: 5px; margin: 5px 0; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <h1>DuoUp</h1>
  <div id="loginDiv">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
  </div>

  <div id="appDiv">
    <h2>Stars: <span id="stars">0</span></h2>
    
    <h2>Friend Requests</h2>
    <ul id="friendRequests"></ul>
    
    <h2>Friends</h2>
    <ul id="friendsList"></ul>

    <h2>Send Friend Request</h2>
    <input type="email" id="friendEmail" placeholder="Friend's email">
    <button id="sendRequestBtn">Send Request</button>

    <h2>Messages</h2>
    <ul id="messagesList"></ul>
    <input type="text" id="messageInput" placeholder="Type message">
    <button id="sendMessageBtn">Send</button>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain: "duoup-cfae6.firebaseapp.com",
  projectId: "duoup-cfae6",
  storageBucket: "duoup-cfae6.firebasestorage.app",
  messagingSenderId: "812263060524",
  appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
  measurementId: "G-46B67F90FK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginDiv = document.getElementById("loginDiv");
const appDiv = document.getElementById("appDiv");

let currentUser;

async function createUserDoc(user) {
  const docRef = db.collection("users").doc(user.uid);
  const doc = await docRef.get();
  if (!doc.exists) {
    await docRef.set({ 
      friends: [], 
      stars: 0,
      email: user.email
    });
  }
}

// --- Authentication ---
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    await createUserDoc(currentUser);
    loadApp();
  } catch(e) { alert(e.message); }
};

document.getElementById("signupBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    await createUserDoc(currentUser);
    loadApp();
  } catch(e) { alert(e.message); }
};

// --- Load main app ---
async function loadApp() {
  loginDiv.style.display = "none";
  appDiv.style.display = "block";
  loadStars();
  loadFriendRequests();
  loadFriends();
  loadMessages();
}

// --- Stars ---
async function loadStars() {
  const userDoc = await db.collection("users").doc(currentUser.uid).get();
  document.getElementById("stars").textContent = userDoc.data().stars || 0;
}

// --- Friend Requests ---
async function loadFriendRequests() {
  const reqList = document.getElementById("friendRequests");
  reqList.innerHTML = "";
  const snapshot = await db.collection("friendRequests")
    .where("receiverId", "==", currentUser.uid)
    .get();
  snapshot.forEach(doc => {
    const li = document.createElement("li");
    li.className = "request";
    li.textContent = doc.data().senderEmail;
    const acceptBtn = document.createElement("button");
    acceptBtn.textContent = "Accept";
    acceptBtn.onclick = () => acceptFriend(doc.id, doc.data().senderId);
    li.appendChild(acceptBtn);
    reqList.appendChild(li);
  });
}

async function acceptFriend(reqId, senderUid) {
  try {
    await db.collection('users').doc(currentUser.uid).update({
      friends: firebase.firestore.FieldValue.arrayUnion(senderUid)
    });
    await db.collection('friendRequests').doc(reqId).delete();
    alert("Duo accepted! +1 star");
    // Increase stars
    await db.collection('users').doc(currentUser.uid).update({
      stars: firebase.firestore.FieldValue.increment(1)
    });
    loadStars();
    loadFriendRequests();
    loadFriends();
  } catch(e) { console.error(e); alert("Error accepting duo"); }
}

// --- Friends List ---
async function loadFriends() {
  const friendsList = document.getElementById("friendsList");
  friendsList.innerHTML = "";
  const userDoc = await db.collection("users").doc(currentUser.uid).get();
  const friends = userDoc.data().friends || [];
  for (let friendUid of friends) {
    const friendDoc = await db.collection("users").doc(friendUid).get();
    const li = document.createElement("li");
    li.className = "friend";
    li.textContent = friendDoc.data().email || friendUid;
    friendsList.appendChild(li);
  }
}

// --- Send Friend Request ---
document.getElementById("sendRequestBtn").onclick = async () => {
  const friendEmail = document.getElementById("friendEmail").value;
  const snapshot = await db.collection("users").where("email", "==", friendEmail).get();
  if (snapshot.empty) { alert("User not found"); return; }
  const friendDoc = snapshot.docs[0];
  await db.collection("friendRequests").doc().set({
    senderId: currentUser.uid,
    senderEmail: currentUser.email,
    receiverId: friendDoc.id,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Request sent!");
};

// --- Messaging ---
async function loadMessages() {
  const messagesList = document.getElementById("messagesList");
  messagesList.innerHTML = "";
  const snapshot = await db.collection("messages")
    .where("participants", "array-contains", currentUser.uid)
    .orderBy("timestamp", "asc")
    .get();
  snapshot.forEach(doc => {
    const data = doc.data();
    const li = document.createElement("li");
    li.className = "message";
    li.textContent = `${data.senderEmail}: ${data.text}`;
    messagesList.appendChild(li);
  });
}

document.getElementById("sendMessageBtn").onclick = async () => {
  const text = document.getElementById("messageInput").value;
  if (!text) return;
  // Send to all friends
  const userDoc = await db.collection("users").doc(currentUser.uid).get();
  const friends = userDoc.data().friends || [];
  for (let friendUid of friends) {
    await db.collection("messages").add({
      participants: [currentUser.uid, friendUid],
      senderId: currentUser.uid,
      senderEmail: currentUser.email,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  document.getElementById("messageInput").value = "";
  loadMessages();
};
</script>
</body>
</html>
